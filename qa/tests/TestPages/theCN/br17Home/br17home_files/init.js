define("plugins/node-modules/nowjs",["socketio","nowjs"],function(){return now?now:void 0}),define("tools/date-tools",["jquery"],function(){var e={};return e.parseTimestamp=function(e,t){var n=new Date;e&&e>0?n.setTime(1e3*parseInt(e)):n.setTime(n.getTime());var i=n.getFullYear(),o=n.getDate(),r=n.getMonth()+1;if(10>o&&(o="0"+o),10>r&&(r="0"+r),t){var a=n.toUTCString(),s=a.split(" ");return s[2]+" "+s[1]+", "+i}return r+"/"+o+"/"+i},e.decodeDateString=function(e){var t=new Date(e);return t},e.getLocalTime=function(e){var t=new Date;!_.isUndefined(e)&&e>0?t.setTime(1e3*parseInt(e)):t.setTime(t.getTime());var n=t.toUTCString();n=n.replace(/\w+,/,""),n=n.replace(/\w+$/,"");var i=n.split(" ");return i[2]+" "+i[1]+", "+i[4]},e.getEventTime=function(){if(!arguments[0])return"";var e=new Date;_.isNumber(arguments[0])?e.setTime(1e3*arguments[0]):e.setTime(e.getTime());var t=e.toUTCString(),n=e.getFullYear(),i=e.getHours()>12?e.getHours()-12:e.getHours(),o=e.getHours()>12?"pm":"am",r=9>e.getMinutes()?"0"+e.getMinutes():e.getMinutes();t=t.replace(/\w+,/,""),t=t.replace(/\w+$/,"");var a=t.split(" ");return a[2]+" "+a[1]+", "+n+"    "+i+":"+r+o},e.getTimeObj=function(e){var t=/(\d+)(\:)(\d+)(am||pm)$/;if(!e||!e.match(t))return"";var n=e.match(t),i=n[1],o=n[3],r=i+":"+o;return{time:r,sign:n[4].toUpperCase(),ltime:r+" "+n[4].toUpperCase()}},e.str2Time=function(e){var t=new Date(e).getTime()/1e3;return parseInt(t)},e}),define("text!templates/node-apps/chat/chat-form/user-info.html",[],function(){return'<a class="show_avatar link_bypass" href="{{user_avatar_url}}" title="{{username}}">\r\n    <img class="avatar_url_{{user_id}}" src="{{user_avatar_url}}" alt="{{username}}">\r\n</a>\r\n<span><a class="show_card" href="{{user_cn}}" data-type="user" data-id="{{user_id}}">{{user_cn}}</a></span>'}),define("views/node-apps/chat/chat-form/user-info",["jquery","underscore","backbone","text!templates/node-apps/chat/chat-form/user-info.html"],function(e,t,n,i){return n.View.extend({tagName:"li",template:i,initialize:function(){this.$el.attr("data-id",this.model.get("user_id"))},serialize:function(){return this.model.toJSON()}})}),define("text!templates/common/autocomplete-box/menu-item/normal.html",[],function(){return'{{#email_address}}\n<span>\n    <b>{{email_address}}</b>\n</span>\n{{/email_address}}\n{{^email_address}}\n    {{#avatar}}\n    <div class="left l-float">\n        <img src="{{view_url}}" alt="" />\n    </div>\n    {{/avatar}}\n    <div class="right l-float">\n        <div class="title">{{cn_number}}</div>\n        <div class="body">{{display_name}}</div>\n    </div>\n    <div class="clear"></div>\n{{/email_address}}'}),define("views/common/autocomplete-box/menu-item/normal",["jquery","underscore","backbone","modules/user/user","text!templates/common/autocomplete-box/menu-item/normal.html"],function(e,t,n,i,o){return n.View.extend({template:o,className:"block-search-menu-item",initialize:function(e){this.model=!t.isUndefined(e)&&t.has(e,"model")?e.model:new i},serialize:function(){return this.model.toJSON()}})}),define("modules/user/email-receiver",["jquery","underscore","modules/user/user"],function(e,t,n){return n.extend({defaults_:function(){return{type:"user",id:"",receive_type:"normal"}}})}),define("text!templates/common/autocomplete-box/result-item/email-search-result-item.html",[],function(){return'<input type="hidden" name="receivers[{{receivers_len}}][type]" value="{{type}}"/>\n<input type="hidden" name="receivers[{{receivers_len}}][id]" value="{{id}}" />\n{{#email_address}}\n    <b>{{email_address}}</b>\n{{/email_address}}\n{{^email_address}}\n    <b>{{display_name}}{{#cn_number}}({{cn_number}}){{/cn_number}}</b>\n{{/email_address}}\n<a href="javascript:;" class="search_result_remove">X</a>'}),define("views/common/autocomplete-box/result-item/email-search-result-item",["jquery","underscore","backbone","modules/user/email-receiver","text!templates/common/autocomplete-box/result-item/email-search-result-item.html"],function(e,t,n,i,o){return n.View.extend({template:o,tagName:"span",className:"block-email-search-result email_search_result_item",events:{"click .search_result_remove":"deleted"},initialize:function(e){var n=this;n.model=!t.isUndefined(e)&&t.has(e,"model")?e.model:new i},serialize:function(){return this.model.toJSON()},deleted:function(){this.remove()}})}),define("text!templates/common/autocomplete-box/autocomplete.html",[],function(){return'<input class="receiver_search_box input-box" type="text" value="" placeholder="{{placeholder}}" title="{{placeholder}}"/>'}),define("views/common/autocomplete-box/autocomplete",["jquery","underscore","backbone","views/common/autocomplete-box/menu-item/normal","views/common/autocomplete-box/result-item/email-search-result-item","modules/user/email-receiver","text!templates/common/autocomplete-box/autocomplete.html","jqueryUi"],function(e,t,n,i,o,r,a){var s=1;return function(l){var c=a;t.isObject(l)&&t.isString(l.template)&&(c=l.template);var d={email:function(t,n){var i=RegExp(/[_a-zA-Z\d\-\.]+@[_a-zA-Z\d\-]+(\.[_a-zA-Z\d\-]+)+$/);if(i.test(t.term))if("function"==typeof afterSource){var o={email:e.trim(t.term)};afterSource(o,function(){n([{model:{type:"email",id:e.trim(t.term),email_address:e.trim(t.term)}}])})}else n([{model:{type:"email",id:e.trim(t.term),email_address:e.trim(t.term)}}])},user:function(t,n){var i=this,o=i.options.settings.afterSource.user;e.get("api/search_user/",{keyword:t.term,limit:5},function(e){e.result&&e.data.length>0&&("function"==typeof o?o(e,function(){n(e.data)}):n(e.data))})}};return n.View.extend({events:{"keydown .receiver_search_box":"keyDownHandler"},template:c,initialize:function(t){var n={tagName:"div",className:"block-autocomplete-box",target:".receiver_search_box",placeholder:"Enter email address or CN number then CLICK on the correct option",clearTarget:!0,autoFocus:!0,delay:500,searchTypes:["user","email"],sources:d,beforeSource:{},afterSource:{},afterSelect:{},menuItem:{model:r,view:i},resultItem:{model:r,view:o,afterSelect:function(e,t){this.$(".receiver_search_box").before(t)}}};this.options.settings=e.extend(!0,n,t),d=e.extend(!0,{},this.options.settings.sources,d),this.el.className=this.options.settings.className,this.$el.tagName=this.options.settings.tagName},serialize:function(){return{placeholder:this.options.settings.placeholder}},afterRender:function(){var n=this,i=this.options.settings,o=i.target;n.$(o).autocomplete({autoFocus:i.autoFocus,select:function(o,r){var a=i.resultItem,l=function(n,i,o){var r=this;t.isFunction(n)?n.call(r,i,o):t.isObject(n)&&t.has(n,"view")&&t.has(n,"model")&&(e.extend(o.item.model,{receivers_len:s++}),r.insertView(new n.view({model:new n.model(o.item.model),append:function(e,t){n.afterSelect.call(r,e,t)}})).render())};return"function"==typeof i.afterSelect?i.afterSelect(o,r,function(){l.call(n,a,o,r)}):l.call(n,a,o,r),i.clearTarget&&e(o.target).val(""),!1},source:function(o,r){if(0!=e.trim(o.term).length){var a=n.getSources();for(var s in a)t.isFunction(i.beforeSource[s])?i.beforeSource[s].call(n,a[s],o,r):a[s].call(n,o,r)}},change:function(){e("#"+i.menuId).find("li:first").click().empty()}}).each(function(){var o=i.menuItem;t.isFunction(o)?e(this).data("autocomplete")._renderItem=function(t,r){return i.menuId=e(t).attr("id"),o.call(n,t,r)}:t.isObject(o)&&(e(this).data("autocomplete")._renderItem=function(t,n){return i.menuId=e(t).attr("id"),e("<li>").append(e("<a>").html(new o.view({model:new o.model(n.model)}).render().view.el)).appendTo(t)})}),this.$el.on("click",function(){return n.$(o).focus(),!1}),this.$(o).on("blur",function(){var t=this;setTimeout(function(){0==n.$(".email_search_result_item").length&&(e(t).attr("placeholder",e(t).attr("title")),e(t).addClass("input-box"))},100)})},keyDownHandler:function(t){this.options.settings;var n=e.ui.keyCode;return t.keyCode==n.BACKSPACE&&""==e(t.currentTarget).val()?(this.$(".email_search_result_item:last").remove(),!1):(e(t.currentTarget).attr("placeholder",""),e(t.currentTarget).removeClass("input-box"),!0)},getSources:function(){var e={},t=this.options.settings,n=t.searchTypes;for(var i in n)e[n[i]]=d[n[i]];return e}})}}),define("modules/chat/user",["jquery","underscore","backbone"],function(e,t,n){return n.Model.extend({urlRoot:"api/user/",defaults:{username:"",userId:"",groupId:"",userCN:"",userAvatarUrl:"",userProfileViewUrl:""}})}),define("text!templates/node-apps/chat/chat-form/invite-friends-box.html",[],function(){return'<span class="text-hide arrow icon-float-tip-arrow-2">Arrow</span>\r\n<div class="main">\r\n    <h3>CN Number</h3>\r\n    <div class="block_invite_member_input">\r\n\r\n    </div>\r\n    <div class="operate">\r\n        <a class="bt bt-blue invite_member" href="javascript:;">ADD</a>\r\n        <a class="bt bt-gray close_box" href="javascript:;">CLOSE</a>\r\n    </div>\r\n</div>'}),define("views/node-apps/chat/chat-form/invite-friends-box",["jquery","underscore","backbone","tools/pop-up-window","views/common/autocomplete-box/autocomplete","modules/chat/user","text!templates/node-apps/chat/chat-form/invite-friends-box.html"],function(e,t,n,i,o,r,a){return n.View.extend({className:"invite-friends-box block-float-down-box display-none invite_friends_box",template:a,events:{"click .close_box":"closeBox","click .invite_member":"sendInvite"},initialize:function(e){t.bindAll(this,"reset"),this.data=e.data,this.model=new r({groupId:e.data.group_id}),this.reset()},beforeRender:function(){var e=this;this.setViews({".block_invite_member_input":new(o())({searchTypes:["user"],className:"",clearTarget:!1,placeholder:"Enter CN number",resultItem:function(t,n){var i=n.item.model;e.$(".block_invite_member_input input").val(i.display_name),e.model.set({userCN:i.cn_number})}})})},closeBox:function(){var e=this;return this.$el.slideUp(function(){e.reset()}),!1},sendInvite:function(){var e=this.model.get("groupId"),t=this.model.get("userCN");return""!=t?(now.sendInvite(e,t),this.$(".close_box").click()):i.get("function").alert("Please input the user CN#."),!1},reset:function(){this.model.set({userCN:""}),this.$(".block_invite_member_input input").val("")}})}),define("text!templates/node-apps/chat/chat-form/message-item.html",[],function(){return'{{#user_avatar_url}}\r\n<div class="avatar-wrap {{#is_me}}l-float{{/is_me}}{{^is_me}}r-float{{/is_me}}">\r\n    <a class="avatar show_avatar link_bypass" href="{{user_avatar_url}}">\r\n        <img src="{{user_avatar_url}}" alt="{{username}}" />\r\n    </a>\r\n    <a class="show_card" href="{{user_cn}}" data-id="{{user_cn}}" data-type="cn_number">{{user_cn}}</a>\r\n</div>\r\n{{/user_avatar_url}}\r\n<div class="main l-float _main">\r\n    <div class="top">\r\n        <span>{{username}}</span>\r\n        <span>{{display_time}}</span>\r\n        <span>{{status}}</span>\r\n    </div>\r\n    <div class="message">\r\n        {{message}}\r\n    </div>\r\n    {{#is_history}}\r\n    <div class="opera _opera visibility-hidden">\r\n        <a class="deleted" href="javascript:;">DELETE</a>\r\n    </div>\r\n    {{/is_history}}\r\n</div>\r\n<div class="clear"></div>'}),define("views/node-apps/chat/chat-form/message-item",["jquery","underscore","backbone","modules/me","text!templates/node-apps/chat/chat-form/message-item.html"],function(e,t,n,i,o){return n.View.extend({tagName:"li",template:o,events:{"mouseenter ._main":"displayTop","mouseleave ._main":"hideTop","click .deleted":"deleted"},serialize:function(){var e=new i,t=this.model.get("user_id");return t==e.get("id")&&this.model.set({is_me:!0}),this.model.toJSON()},displayTop:function(e){this.$(e.currentTarget).find("._top").css("visibility","visible")},hideTop:function(e){this.$(e.currentTarget).find("._top").css("visibility","hidden")},deleted:function(){var e=this;this.model.destroy({resultTrue:function(){e.remove()}})}})}),define("views/common/option",["jquery","underscore","backbone"],function(e,t,n){return n.View.extend({tagName:"option",initialize:function(i){if("undefined"!==e.type(i)){var o={};if(t.isUndefined(i.model))if(t.isUndefined(i.attrs))var r={display_value:"",display_name:"",selected:""};else var r=i.attrs;else var r=i.model;t.isUndefined(r)||(o={display_value:r instanceof n.Model?r.get("display_value"):r.display_value,display_name:r instanceof n.Model?r.get("display_name"):r.display_name,selected:t.isUndefined(i.params)||t.isUndefined(i.params.selected)?"":i.params.selected}),t.isUndefined(o.display_value)||t.isUndefined(o.display_name)||(this.$el.attr("value",o.display_value),this.$el.html(o.display_name),"undefined"!==e.type(o.selected)&&o.display_value==o.selected&&this.$el.prop("selected",!0))}}})}),define("views/common/select",["jquery","underscore","backbone","views/common/option"],function(e,t,n,i){return n.View.extend({tagName:"select",initialize:function(e){t.bindAll(this,"addAll","addOne"),this.attrs=e.attrs,this.extra=e.extra,this.collections=e.collections,this.collections.on("fetch",this.addAll,this)},afterRender:function(){var t=this,n={defaults:!0},i={defaultName:"Please Select One"};if(i=e.extend(!0,{},i,this.extra),n=e.extend(!0,{},n,this.attrs),e(this.$el).attr(n),"undefined"!==e.type(n)&&"undefined"!==e.type(n.defaults)&&n.defaults){var o='<option value="">'+i.defaultName+"</option>";t.$el.prepend(o)}},addAll:function(){this.collections.each(this.addOne)},addOne:function(e){var t=this,n=new i({model:e,params:{selected:t.attrs.value}});this.$el.append(n.render().view.el)}})}),define("text!templates/loading/head-horizontal.html",[],function(){return'<div class="block-loading block-horizontal-loading block_loading">\r\n	<img src="img/com/frontend/loading/horizontal.gif" alt="Loading" />\r\n</div>'}),define("text!templates/common/more-operation.html",[],function(){return'<div class="main get_more_operation_box">\r\n	<a href="javascript:;" class="get_more always_allow">\r\n		SHOW MORE\r\n	</a>\r\n</div>'}),function(e){var t={load:function(){},scrollTarget:null,heightOffset:"auto"},n=function(t,n){var i=e(n.scrollTarget);if(0!=e(t).scrollTop())if(e(t).length>0&&e(t).is(":visible")&&location.href==n.url){var o=!1;o="auto"===n.heightOffset||n.heightOffset>=e(t).height()?(e(t).scrollTop()+e(t).height())/i.height()>=.7:e(t).scrollTop()+n.heightOffset+e(t).height()>=i.height(),o&&n.load()}else e(t).stopScrollPagination()};e.fn.scrollPagination=function(i){var o=e.extend({},t,i,{url:location.href});return o.scrollTarget?(e(this).unbind("scroll"),e(this).attr("scrollPagination","enabled"),e(this).scroll(function(t){"enabled"==e(this).attr("scrollPagination")?n(this,o):t.stopPropagation()}),e(this)):(console.error("the scrollTarget is missing"),!1)},e.fn.stopScrollPagination=function(){return e(this).attr("scrollPagination","disabled")}}(jQuery),define("jqueryScrollPagination",function(){}),define("views/common/more-operation",["jquery","underscore","backbone","text!templates/loading/head-horizontal.html","text!templates/common/more-operation.html","jqueryScrollPagination"],function(e,t,n,i,o){return n.View.extend({className:"block-more-operation",template:o,events:{"click .get_more":"getMore"},initialize:function(t){this._tmpData={},this.view={initMinLimit:10,limit:20,scrollTarget:e(document),scrollTargetWrap:e(window),heightOffset:"auto",removeTemplateNoMore:!0,noMoreCallback:function(){},loadingCallback:function(){}},t.view&&t.view&&(this.view=e.extend(this.view,t.view)),this._tmpData.offset=0,this._tmpData.bindScrollPagination=!1,this.collection.on("add",this.render,this),this.collection.on("reset",this.render,this),this.collection&&this.view.initMinLimit<=this.collection.length?(this._tmpData.scrollLoadMore=!0,this._tmpData.offset=this.collection.length):this._tmpData.scrollLoadMore=!1},beforeRender:function(){return this._tmpData.scrollLoadMore?void 0:this.el=""},afterRender:function(){var t=this;return this._tmpData.scrollLoadMore?(t._tmpData.scrollLoadMore&&!t._tmpData.bindScrollPagination&&(t._tmpData.bindScrollPagination=!0,t._tmpData.scrollPagination=e(t.view.scrollTargetWrap).scrollPagination({heightOffset:t.view.heightOffset,scrollTarget:t.view.scrollTarget,callbackContext:t,load:function(){this.callbackContext.getMore()}})),void 0):this.el=""},getMore:function(){var t=this;if(!t._tmpData.scrollLoadMore)return!1;var n=function(e){t.$(".main").html(e)},o=function(){t._tmpData.scrollLoadMore=!1,t._tmpData.scrollPagination.stopScrollPagination(),t.view.removeTemplateNoMore?t.$el.parent().remove():n("<span>NO MORE</span>"),t.view.noMoreCallback()},r=t.$(".main").html();t._tmpData.scrollLoadMore&&t._tmpData.offset>0&&(n(i),t.view.loadingCallback(),t._tmpData.scrollLoadMore=!1,t.collection.fetch({add:!0,data:e.param({limit:t.view.limit,offset:t._tmpData.offset}),resultTrue:function(e,i){!i.data||t.view.limit>i.data.length?o():i.extra_data&&i.extra_data.next_offset?t._tmpData.offset<i.extra_data.next_offset?(t._tmpData.offset=i.extra_data.next_offset,t._tmpData.scrollLoadMore=!0,n(r)):o():o()},resultFalse:function(){o()}}))}})}),define("modules/chat/group",["jquery","underscore","backbone"],function(e,t,n){return n.Model.extend({urlRoot:"api/chat_group/",defaults:{id:"",users:[],display_time:"",status:"",ctime:""},initDefaults:function(){for(var e=this,t=[],n=this.get("users"),i=0,o=n.length;o>i;i++){var r=n[i];t.push(r.cn_number)}var a=t.join(", ");return{display_name:a,display_value:e.get("id")}}})}),define("collections/chat/groups",["jquery","underscore","backbone","modules/chat/group"],function(e,t,n,i){var o=n.Collection.extend({model:i,urlRoot:"api/chat_group/"});return o}),define("modules/chat/message",["jquery","underscore","backbone"],function(e,t,n){return n.Model.extend({urlRoot:"api/chat/",defaults:{id:"",user:{id:""},group:{id:""},display_time:"",username:"",message:"",type:"",status:"",ctime:"",display_time:"",is_history:!1},initDefaults:function(){var e=this.get("is_history"),n=this.get("display_time");if(!e&&""==n){var i=new Date,o=i.getHours();10>o&&(o="0"+o);var r=i.getMinutes();10>r&&(r="0"+r);var a=i.getSeconds();10>a&&(a="0"+a),n=o+":"+r+":"+a}var s=this.get("type"),l=this.get("status");return"system_user_joined"==s?l="(Joined)":"system_user_left"==s?l="(Left)":"system_user_offline"==s&&(l="(Offline)"),t.extend({display_time:n,status:l})}})}),define("collections/chat/messages",["jquery","underscore","backbone","modules/chat/message"],function(e,t,n,i){var o=n.Collection.extend({model:i,urlRoot:"api/chat/",clearAll:function(e,t){var n=this,o=new i({id:""});o.addUrlParam({group_id:e}),o.destroy({resultTrue:function(){n.reset(),"function"==typeof t&&t()}})}});return o}),define("text!templates/node-apps/chat/history/main.html",[],function(){return'<div class="operate _operate">\n    <label>Chat With:</label>\n    <a href="javascript:;" class="clear_all" style="margin-left:10px;">Clear All</a>\n</div>\n<div class="message-wrap history-wrap history_wrap">\n    <ul class="message-list history-list history_list">\n\n    </ul>\n</div>\n<div class="history_list_footer display-none">\n\n</div>'}),define("views/node-apps/chat/history/main",["jquery","underscore","backbone","views/node-apps/chat/chat-form/message-item","views/common/select","views/common/more-operation","tools/pop-up-window","collections/chat/groups","collections/chat/messages","text!templates/node-apps/chat/history/main.html"],function(e,t,n,i,o,r,a,s,l,c){return n.View.extend({className:"display-none history_wrap",template:c,events:{"change .load_group_history":"loadGroupHistory","mouseenter ._main":"displayOperate","mouseleave ._main":"hideOperate","click .clear_all":"clearAll"},initialize:function(e){t.bindAll(this,"getGroupHistoryById","addAll","addOne","refresh"),this.groupId="",e&&e.data&&(this.groupId=e.data.group_id),this.collection=new l,this.collection.on("reset",this.addAll,this),this.collection.on("reset",this.refresh,this),this.collection.on("add",this.addOne,this),this.collection.on("remove",this.refresh,this)},afterRender:function(){var e=this;this.getGroupHistoryById(this.groupId);var t=new s,n=new o({collections:t,attrs:{value:e.groupId,"class":"load_group_history",defaults:!1}});e.$(".clear_all").before(n.render().view.el),t.addUrlParam({with_chat_group_user:1}),t.fetch()},loadGroupHistory:function(t){this.getGroupHistoryById(e(t.currentTarget).val())},getGroupHistoryById:function(e){var t=this;this.collection.addUrlParam({group_id:e}),this.collection.fetch({resultTrue:function(e){t.$(".history_list_footer").empty().append(new r({collection:e,view:{initMinLimit:10,limit:10,scrollTarget:".history_list",scrollTargetWrap:".history_wrap",removeTemplateNoMore:!1}}).render().view.el)},resultFalse:function(){t.$(".history_list_footer").empty(),t.$(".history_list").empty().append("<li>No messages.</li>")}})},addAll:function(){this.$(".history_list").empty(),this.collection.each(this.addOne)},addOne:function(e){e.set({is_history:!0});var t=new i({model:e});this.$(".history_list").append(t.render().view.el)},displayOperate:function(e){this.$(e.currentTarget).find("._opera").css("visibility","visible")},hideOperate:function(e){this.$(e.currentTarget).find("._opera").css("visibility","hidden")},refresh:function(){0==this.collection.length&&this.$(".history_list").empty().append("<li>No messages.</li>")},clearAll:function(){var e=this;return a.get("function").confirm({content:"Are you sure to clear all of the chats?",yesCallBack:function(){e.collection.clearAll(e.$(".load_group_history").val())}}),!1}})}),define("text!templates/node-apps/chat/chat-form.html",[],function(){return'<a class="text-hide bt-minimize-17 minimize" href="javascript:;" title="minimize" style="z-index: 1;">Minimize</a>\r\n<a class="text-hide bt-close-17 delete" href="javascript:;" title="close" style="z-index: 1;">Close</a>\r\n<div class="main _main">\r\n    <div class="top _top">\r\n        <div class="l-float avatar-list-controll display-none prev_avatar">\r\n            <a class="icon-arrow-cross icon-arrow-cross-left" href="javascript:;"></a>\r\n        </div>\r\n        <div class="avatar-list-wrap l-float">\r\n            <ul class="avatar-list l-float avatar_list">\r\n\r\n            </ul>\r\n        </div>\r\n        <div class="l-float avatar-list-controll display-none next_avatar">\r\n            <a class="icon-arrow-cross icon-arrow-cross-right" href="javascript:;"></a>\r\n        </div>\r\n        <div class="operate r-float avatar_list_operate">\r\n            <a class="r-float operate-box load_invite_friends_box" href="javascript:;">\r\n                <img src="img/com/icon/icon-plug-white.png" alt="Invite friend to chat">\r\n            </a>\r\n            <div class="clear"></div>\r\n        </div>\r\n        <div class="clear"></div>\r\n    </div>\r\n    <div class="center _center">\r\n        <div class="message-wrap message_wrap" style="overflow: auto;">\r\n            <ul class="message-list message_list">\r\n\r\n            </ul>\r\n        </div>\r\n        <div class="tip-wrap tip_wrap">\r\n            \r\n        </div>\r\n        <div class="form-wrap">\r\n            <form class="chat_form" method="post">\r\n                <div>\r\n                    <textarea class="chat_message" name="message"></textarea>\r\n                </div>\r\n                <div class="operate">\r\n                    <button class="bt bt-blue l-float show_history">HISTORY</button>\r\n                    <button class="bt bt-gray l-float empty_list">EMPTY</button>\r\n                    <button class="bt bt-blue r-float" type="submit" style="margin-right:0;">SEND</button>\r\n                </div>\r\n            </form>\r\n        </div>\r\n        <div class="block_history_wrap" style="margin-top:10px;">\r\n\r\n        </div>\r\n    </div>\r\n</div>\r\n'}),define("views/node-apps/chat/chat-form",["jquery","underscore","backbone","tools/pop-up-window","views/node-apps/chat/chat-form/user-info","views/node-apps/chat/chat-form/invite-friends-box","views/node-apps/chat/history/main","text!templates/node-apps/chat/chat-form.html"],function(e,t,n,i,o,r,a,s){return n.View.extend({className:"block-float-down-box block-float-down-left-box block-window-chat-form draggable chat_form_wrap",template:s,initialize:function(e){t.bindAll(this,"addAvatar","removeAvatar","flickMinimize"),this.data=e.data,this.$el.attr("data-id",this.data.group_id),this.collection.on("add",this.addAvatar,this),this.collection.on("remove",this.removeAvatar,this),this._status="maximize",this._minimize_view={}},events:{"submit .chat_form":"save","click .delete":"closeConnection","click .empty_list":"emptyList","keypress .chat_message":"typing","click .load_invite_friends_box":"loadInviteFriendsBox","click .next_avatar":"nextAvatarList","click .prev_avatar":"prevAvatarList","click .show_history":"showHistory","click .minimize":"minimize"},afterRender:function(){var e=this;this.$(".avatar_list_operate").append(new r({data:e.data}).render().view.el),this.data&&this.data.minimize&&(this._minimize_view=this.data.minimize.addOne({parent:e,collection:e.collection,data:e.data}))},save:function(){var t=this.data.group_id,n=this.$(".chat_message"),o=n.val();return""==e.trim(o)?i.get("function").alert("Message can not be blank."):(n.val(""),this.$(".message_wrap").scrollTop(99999999),now.sendMessage(t,o)),!1},closeConnection:function(){var e=this;return now.left(e.data.group_id),this.remove(),!1},addAvatar:function(e){var t=new o({model:e});0==this.$(".avatar_list").length?this.insertView(".avatar_list",t):this.$(".avatar_list").append(t.render().view.el)},removeAvatar:function(t){this.$('.avatar_list li[data-id="'+t.get("user_id")+'"]').fadeOut(function(){e(this).remove()})},emptyList:function(){return this.$(".message_list").empty(),!1},typing:function(e){var t=this.data.group_id;return 13==e.keyCode?(this.$(".chat_form").submit(),!1):(now.isTyping(t),!0)},minimize:function(){var t=this;return"maximize"==this._status?this.$el.fadeOut("fast",function(){t._status="minimize",e('.chat_minimize_item[data-id="'+t.data.group_id+'"]').show()}):e('.chat_minimize_item[data-id="'+t.data.group_id+'"]').fadeOut("fast",function(){t._status="maximize",t.$el.show(),t.$(".message_wrap").scrollTop(99999999)}),!1},loadInviteFriendsBox:function(){0==this.$(".invite_friends_box:visible").length?this.$(".invite_friends_box").slideDown():this.$(".invite_friends_box").slideUp()},nextAvatarList:function(t){var n=this,i=e(t.currentTarget),o=this.$(".avatar_list"),r=o.position().left,a=o.find("li").outerWidth(!0);return o.animate({left:r-5*a},"slow",function(){var e=o.data(),t=e.total,r=e.current+1;r==t&&i.fadeOut("fast"),r>1&&n.$(".prev_avatar:hidden").fadeIn(),o.data("current",r)}),!1},prevAvatarList:function(t){var n=this,i=e(t.currentTarget),o=this.$(".avatar_list"),r=o.position().left,a=o.find("li").outerWidth(!0);return o.animate({left:r+5*a},"slow",function(){var e=o.data(),t=e.total,r=e.current-1;1==r&&i.fadeOut("fast"),t>r&&n.$(".next_avatar:hidden").fadeIn(),o.data("current",r)}),!1},showHistory:function(){var e=this;if(this.$(".history_wrap").is(":visible"))this.$(".history_wrap").slideUp();else{var t=new a({data:e.data});this.$(".block_history_wrap").html(t.render().view.el),this.$(".history_wrap").slideDown()}return!1},getIsMinimize:function(){return"minimize"==this._status},flickMinimize:function(){this.getIsMinimize&&this._minimize_view.flicker&&this._minimize_view.flicker()}})}),define("text!templates/node-apps/chat/chat-form/typing-user.html",[],function(){return'<img src="img/common/chat/typing.gif" alt="typing" />\n<span data-id="{{userId}}">{{userCN}}</span>\n'}),define("views/node-apps/chat/chat-form/typing-user",["jquery","underscore","backbone","text!templates/node-apps/chat/chat-form/typing-user.html"],function(e,t,n,i){return n.View.extend({tagName:"div",className:"typing-tip",template:i,serialize:function(){return this.model.toJSON()}})}),define("text!templates/node-apps/chat/minimize/item.html",[],function(){return'<div class="block-chat-minimize-item _main">\n    <div class="list l-float">\n        <div class="content">{{display_users}}</div>\n    </div>\n    <div class="r-float operate">\n        <a class="text-hide bt-close-17 bt-close delete" href="javascript:;" title="close">CLOSE</a>\n    </div>\n    <div class="clear"></div>\n</div>\n'}),define("views/node-apps/chat/minimize/item",["jquery","underscore","backbone","text!templates/node-apps/chat/minimize/item.html"],function(e,t,n,i){var o=!1;return n.View.extend({tagName:"li",className:"l-float chat_minimize_item display-none",template:i,events:{"click .delete":"closeConnection"},initialize:function(e){var n=this;t.bindAll(this,"flicker","clearTimer"),this.collection.on("all",this.render,this),this.parent=e.parent,this.$el.on("click",function(){n.parent.$(".minimize").click()}),this.$el.attr("data-id",e.data.group_id),this._locked=o},serialize:function(){var e=[];return this.collection.each(function(t){e.push(t.get("username"))}),{display_users:e.join(", ")}},closeConnection:function(){return this.parent.$(".delete").click(),this.remove(),!1},flicker:function(){var e=this;if(this._locked)return!1;this._locked=!0;var t=0,n=function(i){return 15==t?(e.clearTimer(),!1):(i?e.$("._main").css({background:"#0E76BD"}):e.$("._main").css({background:"#3399ff"}),t++,e._timer=setTimeout(function(){return e.parent.getIsMinimize()?(1==t%2?n(!0):n(!1),void 0):(e.clearTimer(),!1)},400),void 0)};n(!1)},clearTimer:function(){clearTimeout(this._timer),this._locked=!1,this.$("._main").css({background:"#0E76BD",color:"white"})}})}),define("text!templates/node-apps/chat/minimize/main.html",[],function(){return'<div class="l-float icon display-none _icon">\n    <a class="text-hide icon-alert icon-alert-chat " data-type="chat" href="javascript:;">CHATS</a>\n    <b class="number _number" data-status="false"></b>\n    <div class="clear"></div>\n</div>\n<div class="l-float list _list">\n    <ul class="_item">\n\n    </ul>\n</div>\n<div class="clear"></div>'}),define("views/node-apps/chat/minimize/main",["jquery","underscore","backbone","views/node-apps/chat/minimize/item","text!templates/node-apps/chat/minimize/main.html"],function(e,t,n,i,o){var r={};return n.View.extend({className:"chat-form-minimize-wrap",template:o,initialize:function(){t.bindAll(this,"addOne","subOne","resetNumber")},addOne:function(e){var t=new i(e);return r[e.data.group_id]=t,this.$("._list ._item").append(t.render().view.el),this.resetNumber(),t},subOne:function(e){r[e].remove(),this.resetNumber()},resetNumber:function(){r.length>=2?this.$("._number").html(r.length-1).attr("data-status",!0):this.$("._number").attr("data-status",!1)}})}),define("text!templates/node-apps/chat/requesting.html",[],function(){return'<div class="head">\r\n	<h4>Chat</h4>\r\n</div>\r\n<div class="main">\r\n	<div class="text">\r\n        <h3>Requesting to chat with {{display_names}}.</h3>\r\n    </div>\r\n    <div class="list">\r\n        {{#users}}\r\n        <div class="item l-float">\r\n            <a class="l-float show_avatar link_bypass" href="{{user_avatar_url}}">\r\n                <img alt="{{username}}" style="width:40px;height:40px;" src="{{user_avatar_url}}" />\r\n            </a>\r\n            <span><a class="show_card" href="{{user_cn}}" data-type="cn_number" data-id="{{user_cn}}">{{username}}, {{user_cn}}</a></span>\r\n            <div class="clear"></div>\r\n        </div>\r\n        {{/users}}\r\n    </div>\r\n    <div class="clear"></div>\r\n</div>'}),define("views/node-apps/chat/requesting",["jquery","underscore","backbone","tools/pop-up-window","text!templates/node-apps/chat/requesting.html"],function(e,t,n,i,o){return i.get("view").extend({className:"pop-up-window block-window-chat-navigation block-window-chat-requesting",template:o,initialize:function(){},serialize:function(){var e=[];return this.collection.each(function(t){e.push(t.get("username"))}),{users:this.collection.toJSON(),display_names:e.join(", ")}}})}),define("collections/chat/users",["jquery","underscore","backbone","modules/chat/user"],function(e,t,n,i){var o=n.Collection.extend({model:i,urlRoot:"api/user/"});return o
}),define("text!templates/node-apps/chat/navigation.html",[],function(){return'<div class="head">\r\n	<h4>Chat</h4>\r\n</div>\r\n<div class="main">\r\n	<div class="text">Would you like to chat with {{username}} ({{user_cn}})?</div>\r\n    <div class="operate">\r\n        <a href="{{user_cn}}" class="bt bt-gray view_profile" >VIEW PROFILE</a>\r\n        <a href="javascript:;" class="bt bt-blue chat_call" >CHAT</a>\r\n        <a href="javascript:;" class="bt bt-gray cancel" >CANCEL</a>\r\n    </div>\r\n</div>'}),define("views/node-apps/chat/navigation",["tools/pop-up-window","views/node-apps/chat/requesting","collections/chat/users","text!templates/node-apps/chat/navigation.html"],function(e,t,n,i){var o=e.get("function");return e.get("view").extend({className:"pop-up-window block-window-chat-navigation",template:i,events:{"click .cancel":"deleted","click .view_profile":"deleted","click .chat_call":"sendCall"},serialize:function(){return this.model.toJSON()},sendCall:function(){now.sendCall(this.model.get("user_id"));var e=new n;e.add(this.model);var i=new t({collection:e});o.open(i.render().view.el),setTimeout(function(){o.close()},5e3)}})}),define("text!templates/node-apps/chat/confirm.html",[],function(){return'<div class="head">\r\n	<h4>Chat</h4>\r\n</div>\r\n<div class="main">\r\n	<div class="text">\r\n        {{#confirm_text}}\r\n        <h3>{{confirm_text}}</h3>\r\n        {{/confirm_text}}\r\n        {{^confirm_text}}\r\n        <h3>{{userCN}} wants to chat.</h3>   \r\n        {{/confirm_text}}\r\n    </div>\r\n    <div class="list">\r\n        <div class="item">\r\n            <a class="l-float show_avatar link_bypass" href="{{userAvatarUrl}}">\r\n                <img alt="{{username}}" style="width:40px;height:40px;" src="{{userAvatarUrl}}" />\r\n            </a>\r\n            <span><a class="show_card" href="{{userCN}}" data-type="cn_number" data-id="{{userCN}}">{{username}}, {{userCN}}</a></span>\r\n            <div class="clear"></div>\r\n        </div>\r\n    </div>\r\n    <div class="operate">\r\n        <a href="javascript:;" class="bt bt-blue accept_call" >ACCEPT</a>\r\n        <a href="javascript:;" class="bt bt-gray reject_call" >IGNORE</a>\r\n    </div>\r\n</div>'}),define("views/node-apps/chat/confirm",["jquery","underscore","backbone","tools/pop-up-window","text!templates/node-apps/chat/confirm.html"],function(e,t,n,i,o){return i.get("view").extend({className:"pop-up-window block-window-chat-navigation block-window-chat-requesting",template:o,events:{"click .accept_call":"acceptCall","click .reject_call":"rejectCall"},initialize:function(e){t.bindAll(this,"clearTimeout"),this.data=e.data},serialize:function(){return e.extend(this.data,this.model.toJSON())},acceptCall:function(){return now.callAccept(this.model.get("userId"),this.model.get("groupId")),this.deleted(),this.clearTimeout(),!1},rejectCall:function(){return now.callReject(this.model.get("groupId"),this.model.get("userId")),this.deleted(),this.clearTimeout(),!1},clearTimeout:function(){this.data.timer&&clearTimeout(this.data.timer)}})}),define("modules/chat/miss",["jquery","underscore","backbone","modules/me"],function(e,t,n,i){return n.Model.extend({urlRoot:"api/chat_miss/",defaults:function(){var e=new i;return{actor_id:"",actor_type:"user",user_id:e.get("id"),mark:"unread",count:1}}})}),define("views/node-apps/chat/init",["jquery","underscore","backbone","tools/date-tools","tools/pop-up-window","views/node-apps/chat/chat-form","views/node-apps/chat/chat-form/message-item","views/node-apps/chat/chat-form/typing-user","views/node-apps/chat/minimize/main","views/node-apps/chat/requesting","views/node-apps/chat/navigation","views/node-apps/chat/confirm","modules/chat/user","modules/chat/message","modules/chat/miss","collections/chat/users","plugins/node-modules/nowjs","jqueryUi"],function(e,t,n,i,o,r,a,s,l,c,d,u,m,h,p,f,v){var _=o.get("function"),g={autoCloseDownTime:3e3},b=this;b._options={};var y={},w={},x=new l,C="";return{setOptions:function(t){return b._options=e.extend(!0,{},y,t),this},run:function(){var n=5,o="",l={top:e(window).height()-445,left:10},b={};return b.getChatFormViewByGroupId=function(e){return t.has(w,e)?w[e]:!1},b.setChatFormViewWithGroupId=function(e,t){w[e]=t},b.getGroupById=function(t){return e('.chat_form_wrap[data-id="'+t+'"]')},b.addUsers=function(e,t){var i=b.getChatFormViewByGroupId(e);return t&&i?(v.setupUsers(t,function(e){i.$(".avatar_list").empty(),o="",i.collection.reset();for(var t in e)if(e.hasOwnProperty(t)){var r=new m(e[t]);i.collection.add(r)}setTimeout(function(){var t=Math.ceil(e.length/n),o=1,r=i.$(".avatar_list").data();r&&r.current&&(o=r.current),i.$(".avatar_list").data({total:t,current:o,count:e.length}),t>o&&i.$(".next_avatar").show()},500)}),void 0):!1},b.initMinimize=function(e){x.addOne({collection:e})},b.missCall=function(e){var t=new p;t.save({actor_id:e.userId}),v.missCall(e)},b.initChatFormPosition=function(e){var t={top:l.top-40,left:l.left+30};l=t,e.css(t)},b.typingUsers={},v.getTypingUser=function(e,t){if(!t||!t.userId||!t.userCN||t.userId==v.userId)return!1;var n=b.getChatFormViewByGroupId(e),i=n.$(".tip_wrap"),o=i.find('span[data-id="'+t.userId+'"]'),r=new s({model:new m(t)});0>=o.length?i.append(r.render().view.el):b.typingUsers[t.userId]&&clearTimeout(b.typingUsers[t.userId]),function(e,t,n){var i=setTimeout(function(){n.empty()},1e3);t[e.userId]=i}(t,b.typingUsers,i)},e(document).on("click",'.chat_button[data-online="true"]',function(){var t=e(this).attr("data-id");return v.userId==t?!1:(v.getUserInfoByUserId(t,function(t){var n=new m(t);return t&&t.user_id?(v.checkIsOnlineByUserId(t.user_id,function(t){return t?(new d({model:n}).sendCall(),!1):(e("#member_wall_refresh_btn").click(),!1)}),void 0):(e("#member_wall_refresh_btn").click(),!1)}),!1)}),e(document).on("click",".chat_group_button[data-id]",function(t){var n=e(t.currentTarget).attr("data-id");v.sendInviteFromGroup(n,function(e){var t=new f;for(var n in e)t.add(new m(e[n]));var i=new c({collection:t});_.open(i.render().view.el),setTimeout(function(){_.close()},5e3)})}),v.receiveCall=function(e){if(e.userId!=v.userId){var t=new m(e),n=setTimeout(function(){_.close(),b.missCall(e)},2e4),i=new u({model:t,data:{timer:n}});_.open(i.render().view.el)}},v.getCallReject=function(e,t){t.user_id!=v.userId&&_.alert(t.username+" ("+t.user_cn+") is unavailable to chat.",g)},v.getInvite=function(e,t){if(t.userId!=v.userId){var n=new m(t);n.set({groupId:e});var i=setTimeout(function(){_.close(),b.missCall(t)},2e4),o=new u({model:n,data:{confirm_text:t.username+", "+t.userCN+" wants to invite you to join their group chat.",timer:i}});_.open(o.render().view.el)}},v.refreshUserList=function(e,t){b.addUsers(e,t)},v.initChatForm=function(n,i){if(cn.log("init chat form"),!t.has(w,n)&&0==e('.chat_form_wrap[data-id="'+n+'"]').length){var o=new f,a=new r({collection:o,data:{group_id:n,minimize:x}});b.setChatFormViewWithGroupId(n,a),e("body").append(a.render().view.el),b.initChatFormPosition(a.$el),e(".draggable").draggable({handle:"._top",containment:[0,e(document).scrollTop()+48,1e4,1e4]}),e(".draggable").on("dragstop",function(t){var n=e(this).offset().top,i=e(document).scrollTop();i+50>n&&(e(t.currentTarget).offset({top:i+53}),e(t.currentTarget).draggable({axis:!1}))}),e(".draggable").on("drag",function(t){var n=e(this).offset().top,i=e(document).scrollTop();i+50>n&&e(t.currentTarget).draggable({axis:"x"})})}t.isFunction(i)&&i()},v.closeChatForm=function(e){b.getGroupById(e).remove(),x.subOne(e),delete w[e]},v.getMessage=function(t,n,o){if(n&&v.userId==n.user_id&&n.type in{system_user_joined:"system_user_joined",system_user_left:"system_user_left",system_user_offline:"system_user_offline"})return!1;var r;if(t.length>0){if(r=b.getGroupById(t),0==r.length&&"message"==n.type)return v.missMessage(t),!1}else r=e(".chat_form_wrap");var s=n.ctime;o||(s="");var l=i.parseTimestamp(s,!0);if(C!=l&&(r.find(".message_list").append('<li class="date" >'+l+"</li>"),C=l),r.find(".message_list").append(new a({model:new h(n)}).render().view.el),!o&&r.find(".message_list li:last").length>0){var c=r.find(".message_wrap").innerHeight(),d=r.find(".message_list li:last").position().top;200>d-c&&r.find(".message_wrap").scrollTop(99999999)}var u=b.getChatFormViewByGroupId(t);u&&u.getIsMinimize()&&u.flickMinimize()},b.removeUser=function(e,t){var i=b.getChatFormViewByGroupId(t);if(i.collection.find(function(t){t.get("user_id")==e.userId&&i.collection.remove(t)}),i.$('.avatar_list li[data-id="'+e.userId+'"]').length){var o=i.$(".avatar_list"),r=o.data();if(r){var a=r.current,s=r.count-1,l=Math.ceil(s/n);r.current===l?i.$(".next_avatar").fadeOut():r.current>l&&(i.$(".prev_avatar").fadeOut(function(){o.animate({left:0},"slow"),i.$(".next_avatar").fadeIn()}),a=1),o.data({total:l,current:a,count:s})}}},b.removeUsers=function(e){for(var t in w)w.hasOwnProperty(t)&&b.removeUser(e,t)},v.removeUser=function(e,t){t?b.removeUser(e,t):o!==e.userId&&(b.removeUsers(e),o=e.userId)},v.alert=function(t,n){n=e.extend(n,g),_.alert(t,n)},e(document).on("click","#logout",function(){for(var e in w)w.hasOwnProperty(e)&&(w[e].remove(),v.left(e))}),setTimeout(function(){v.initChat(),e(document).ready(function(){e("body").append(x.render().view.el)})},500),this}}}),define("views/node-apps/realtime/init",["jquery","plugins/node-modules/nowjs","modules/message-system/message-count-chat","modules/message-system/message-count-email","modules/message-system/message-count-notification","modules/message-system/message-count-request"],function(e,t,n,i,o,r){var a={request:r,email:i,notification:o,chat:n},s=this,l={};return s._options={},{setOptions:function(t){return s._options=e.extend(!0,{},l,t),this},run:function(){cn.log("-- real time init --");for(var e in a)a.hasOwnProperty(e)&&a[e].on("change:number",function(){t&&"function"==typeof t.updateAlertNumber&&t.updateAlertNumber(this.get("type"),this.get("number"))});return t.updateTopbarAlert=function(e,t){cn.log("update topbar alert: ",e,t),a[e]&&a[e].set({number:t})},this}}}),define("views/node-apps/init",["jquery","plugins/node-modules/nowjs","views/node-apps/chat/init","views/node-apps/realtime/init","modules/me"],function(e,t,n,i,o){var r=!1,a=!1,s={chat:{},realtime:{}},l={chat:n,realtime:i},c=0,d=function(){if(c++,!(c>3)){var n=new o;if(!(n.get("id")&&n.get("cn_number")&&n.get("avatar")&&n.get("avatar").view_url))return cn.log("-- Me is not ready, run again later --"),setTimeout(function(){d()},3e3),void 0;e.extend(t,{username:n.get("display_name"),userId:n.get("id"),userCN:n.get("cn_number"),userAvatarUrl:n.get("avatar").view_url,userProfileViewUrl:n.get("cn_number")}),t.init(function(){if(!a){a=!0,cn.log("-- now ready init --");for(var e in t.apps)t.apps.hasOwnProperty(e)&&t.apps[e].enable&&l[e].setOptions(s[e]).run()}})}};return{setOptions:function(t){return s=e.extend(!0,{},s,t),this},run:function(){return t&&(cn.log("-- now before ready --"),r?(cn.log("-- now has ready, initNowApp again--"),d()):(cn.log("-- now has not ready, define ready now--"),t.ready(function(){r=!0,cn.log("-- now ready callback, init app now--"),d()}))),this},clearCache:function(){c=0}}});