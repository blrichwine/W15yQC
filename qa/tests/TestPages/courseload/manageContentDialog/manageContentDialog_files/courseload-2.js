window.log=function(){if(this.console){console.log(Array.prototype.slice.call(arguments))}};window.namespace=function(c){var d=c.split(".");var a=window;for(var b=0;b<d.length;b++){a=a[d[b]]=a[d[b]]||{}}};(function(){var a={}.hasOwnProperty,c=function(g,e){for(var d in e){if(a.call(e,d)){g[d]=e[d]}}function f(){this.constructor=g}f.prototype=e.prototype;g.prototype=new f();g.__super__=e.prototype;return g},b=[].indexOf||function(f){for(var e=0,d=this.length;e<d;e++){if(e in this&&this[e]===f){return e}}return -1};namespace("courseload.api");namespace("courseload.api_online");courseload.api_online.getcsrftoken=function(){return $.getJSON("/api/csrftoken/")};courseload.api_online.getcustomer=function(){return $.getJSON("/api/customer/")};courseload.api_online.getuser=function(){return $.getJSON("/api/login/")};courseload.api_online.offlinestatus=function(){return $.getJSON("/api/online/")};courseload.api_online.login=function(e,d){return $.ajax({url:"/api/login/",type:"POST",headers:{"X-CSRFToken":courseload.data.csrftoken},data:{username:e,password:d}})};courseload.api_online.logout=function(){return $.ajax("/api/logout/")};courseload.api_online.forgotpassword=function(d){return $.ajax({url:"/api/password/forgot/",type:"POST",headers:{"X-CSRFToken":courseload.data.csrftoken},data:{email:d}})};courseload.api_online.validateresetpassword=function(e){var d;d="/api/password/reset/"+e+"/";return $.ajax({url:d,type:"GET",headers:{"X-CSRFToken":courseload.data.csrftoken}})};courseload.api_online.resetpassword=function(f,e){var d;d="/api/password/reset/"+f+"/";return $.ajax({url:d,type:"POST",headers:{"X-CSRFToken":courseload.data.csrftoken},data:{password:e}})};courseload.api_online.addTag=function(e,d){return $.ajax({url:e.tag,headers:{"X-CSRFToken":courseload.data.csrftoken},type:"POST",data:{tag:d}})};courseload.api_online.removeTag=function(e,d){var f;f=""+e.tag+(encodeURIComponent(d))+"/";return $.ajax({url:f,type:"DELETE",headers:{"X-CSRFToken":courseload.data.csrftoken}})};courseload.api_online.renameTag=function(h,f,d){var g,e;d=courseload.api_online.cleanTag(d);e=""+h.tag+(encodeURIComponent(f))+"/";g=function(i){return i.toLowerCase()===f.toLowerCase()};h.tags=_.reject(h.tags,g);h.tags.push(d);h.tags.naturalSort(true);return $.ajax({url:e,type:"POST",headers:{"X-CSRFToken":courseload.data.csrftoken},data:{tag:d}})};courseload.api_online.cleanTag=function(d){return d.toString()};courseload.api_online.consentToEula=function(e,d){return $.ajax({url:e.eula_consent,headers:{"X-CSRFToken":courseload.data.csrftoken},type:"POST",data:d})};courseload.api_online.logPageRead=function(e,d,f){var g;g={page:d};if(f!=null){g.while_offline=f}return $.ajax({url:e.log_page_read,headers:{"X-CSRFToken":courseload.data.csrftoken},type:"POST",data:g})};courseload.api_online.logPageReadIncrement=function(d){return $.ajax({url:d,headers:{"X-CSRFToken":courseload.data.csrftoken},type:"POST"})};courseload.api_online.respondToNote=function(d,e){return $.ajax({url:d.respond,headers:{"X-CSRFToken":courseload.data.csrftoken},type:"POST",data:e})};courseload.api_online.getmanifest=function(d){return $.getJSON(d.manifest)};courseload.api_online.checkout=function(d){return $.ajax({url:d.checkout,type:"POST",headers:{"X-CSRFToken":courseload.data.csrftoken}})};courseload.api_online.checkin=function(d){return $.ajax({url:d.checkout,type:"DELETE",headers:{"X-CSRFToken":courseload.data.csrftoken}})};courseload.api_online.checkoutDownloading=function(d){return $.ajax({url:d.uri,data:{status:"downloading"},type:"POST",headers:{"X-CSRFToken":courseload.data.csrftoken}})};courseload.api_online.checkoutComplete=function(d){return $.ajax({url:d.uri,data:{status:"current"},type:"POST",headers:{"X-CSRFToken":courseload.data.csrftoken}})};courseload.api_online.checkForUpdates=function(d){return $.getJSON("/api/offline/checkforupdates/")};courseload.api_online.getnav=function(e){var d;d=new $.Deferred();$.getJSON(e.nav).done(function(r){var x,o,t,y,u,w,n,A,v,p,q,j,h,g,f,B,D,C,z,s,l,k,i;q=[];s=r.terms;for(j=0,B=s.length;j<B;j++){v=s[j];p=new courseload.models.Term();v=$.extend({},p,v);l=v.memberships;for(h=0,D=l.length;h<D;h++){w=l[h];A=new courseload.models.Section();w.section=$.extend({},A,w.section);t=[];k=w.section.assignments;for(g=0,C=k.length;g<C;g++){x=k[g];u=[];i=x.items;for(f=0,z=i.length;f<z;f++){y=i[f];o=new courseload.models.AssignmentItem();n=$.extend({},o,y);u.push(n)}x.items=u;t.push(x)}w.section.assignments=t}q.push(v)}r.terms=q;return d.resolve(r)}).fail(function(){return d.reject()});return d};courseload.api_online.copysectioncounts=function(d){return $.getJSON(d.copy)};courseload.api_online.copysection=function(e,d){return $.ajax({url:e.copy,type:"POST",headers:{"X-CSRFToken":courseload.data.csrftoken},data:d})};courseload.api_online.getroster=function(d){return $.getJSON(d.roster)};courseload.api_online.getbookmarks=function(d){return $.getJSON(d.bookmarks)};courseload.api_online.getnewquestions=function(d){return $.getJSON(d.notifications.questions)};courseload.api_online.getnewresponses=function(d){return $.getJSON(d.notifications.responses)};courseload.api_online.markread=function(d){return $.ajax({url:d.mark_as_read,type:"POST",headers:{"X-CSRFToken":courseload.data.csrftoken}})};courseload.api_online.getclassmaterials=function(e){var d;d=new $.Deferred();$.getJSON(e.classmaterial).done(function(g){var h,p,f,o,k,n,m,i,l,j;h=g.classmaterials;f={};for(o in h){m=[];j=h[o];for(i=0,l=j.length;i<l;i++){p=j[i];n=new courseload.models.Material();k=$.extend({},n,p);m.push(k)}f[o]=m}g.classmaterials=f;return d.resolve(g)}).fail(function(){return d.reject()});return d};courseload.api_online.deleteclassmaterial=function(d){var e;e=d.remove;return $.ajax({url:e,type:"DELETE",headers:{"X-CSRFToken":courseload.data.csrftoken}})};courseload.api_online.deleteusereresource=function(e){var d;d=e.remove;return $.ajax({url:d,type:"DELETE",headers:{"X-CSRFToken":courseload.data.csrftoken}})};courseload.api_online.abortupload=function(e){var d;d=e.abort;return $.ajax({url:d,type:"DELETE",headers:{"X-CSRFToken":courseload.data.csrftoken}})};courseload.api_online._getnotes_buildurl=function(e,g){var h,f,d,i;if(g&&g.type&&g.type!=="notes"){f=e.markups}else{f=e.notes}if(g){d=[];for(h in g){if(!a.call(g,h)){continue}i=g[h];d.push(""+h+"="+i)}if(d.length){f+="?"+d.join("&")}}return f};courseload.api_online.getnotes=function(d,g){var f,e;f=new $.Deferred();e=courseload.api_online._getnotes_buildurl(d,g);$.getJSON(e).done(function(k){var i,j,h;for(j=0,h=k.length;j<h;j++){i=k[j];courseload.api_online._convert_position_to_array(i)}return f.resolve(k)}).fail(function(){return f.reject()});return f};courseload.api_online.getwords=function(f,d){var e;e=""+f.words_base+d+"/";return $.getJSON(e)};courseload.api_online.deletemarkup=function(f,e){var g,d;d=new $.Deferred();if(e.uri){g=$.ajax({url:e.uri,type:"DELETE",headers:{"X-CSRFToken":courseload.data.csrftoken}});g.done(function(){return d.resolve()});g.fail(function(){return d.reject(g)});$("#track").trigger("markup_deleted",e);if($(".note-edit-panel").length){$(".note-edit-panel").trigger("markup_deleted",e)}}return d};courseload.api_online.savemarkup=function(i,f){var j,e,h,d,g;e=new $.Deferred();h=f;if(!(f.uri!=null)){$("#track").trigger("markup_created",f)}if(f.position){d=courseload.api_online._convert_array_to_position(f.position);h=$.extend({},h,{position:d})}if(h.uri){g=h.uri}else{if(i&&i.markup_save){g=i.markup_save}else{g="/api/markup/"}}j=$.ajax({url:g,headers:{"X-CSRFToken":courseload.data.csrftoken},type:"POST",data:h});j.done(function(k){if(k.position){courseload.api_online._convert_position_to_array(k)}$.extend(f,k);return e.resolve(f)});j.fail(function(){return e.reject(j)});return e};courseload.api_online.getmarkup=function(i,d){var h,e,f,j,g;f=new $.Deferred();h={ME:0,INSTRUCTOR:1,CLASSMATES:2,MEANDINSTRUCTOR:3};g={slug:courseload.data.classmaterial.slug,section:courseload.data.classmaterial.sectionId,page:d,type:"note,selection,bookmark"};e=courseload.data.classmaterial;switch(courseload.data.book.notesetting){case 0:g.me=1;break;case 1:g.instructor=1;break;case 2:g.classmates=courseload.data.book.selectedclassmate;break;case 3:g.me=1;g.instructor=1}j=courseload.api_online._getnotes_buildurl(e,g);$.getJSON(j).done(function(n){var l,m,k;for(m=0,k=n.length;m<k;m++){l=n[m];courseload.api_online._convert_position_to_array(l)}return f.resolve(n)}).fail(function(){return f.reject()});return f};courseload.api_online.savemarkupsharing=function(f){var d,e;d=new $.Deferred();e=f;$.ajax({url:courseload.data.manifest.markup_sharing_save,headers:{"X-CSRFToken":courseload.data.csrftoken},type:"POST",data:e}).done(function(g){return d.resolve(g)}).fail(function(){return d.reject()});return d};courseload.api_online.getsharingsettings=function(d){return $.getJSON(d.sharing_settings_uri)};courseload.api_online.savesharingsettings=function(e,d){return $.ajax({url:e.sharing_settings_uri,type:"POST",headers:{"X-CSRFToken":courseload.data.csrftoken},data:d})};courseload.api_online.getclassmatessharingwithme=function(d){return $.getJSON(d.sharing_with_me_uri)};courseload.api_online.getinstructorcourses=function(){return $.getJSON("/api/instructor/courses/")};courseload.api_online.getuserresources=function(){var d;d=new $.Deferred();$.getJSON("/api/user/resources/").done(function(j){var f,g,k,i,h,e;f=[];for(h=0,e=j.length;h<e;h++){i=j[h];k=new courseload.models.Material();g=$.extend({},k,i);f.push(g)}return d.resolve(f)}).fail(function(){return d.reject()});return d};courseload.api_online.getmarkuplist=function(){var d,e,g,f;e=new $.Deferred();f={slug:courseload.data.classmaterial.slug,type:"note,selection"};f.section=courseload.data.classmaterial.sectionId||"";d=courseload.data.classmaterial;switch(courseload.data.book.notesetting){case 0:f.me=1;break;case 1:f.instructor=1;break;case 2:f.classmates=courseload.data.book.selectedclassmate;break;case 3:f.me=1;f.instructor=1}g=courseload.api_online._getnotes_buildurl(d,f);$.getJSON(g).done(function(h){return e.resolve(h)}).fail(function(){return e.reject()});return e};courseload.api_online.saveexternallink=function(e){var d;d=new $.Deferred();$.ajax({url:"/api/upload/externallink/",headers:{"X-CSRFToken":courseload.data.csrftoken},type:"POST",data:e}).done(function(f){return d.resolve(f)}).fail(function(){return d.reject()});return d};courseload.api_online.getbltilaunchparams=function(e){var d;d=new $.Deferred();$.getJSON(e.lti_provider).done(function(f){return d.resolve(f)}).fail(function(){return d.reject()});return d};courseload.api_online.taskComplete=function(d){return $.ajax({url:d.task_complete_uri,headers:{"X-CSRFToken":courseload.data.csrftoken},type:"POST"})};courseload.api_online.taskNotComplete=function(d){return $.ajax({url:d.task_complete_uri,headers:{"X-CSRFToken":courseload.data.csrftoken},type:"DELETE"})};courseload.api_online._convert_position_to_array=function(f){var e,d;e=function(m){var j,l,h,k,g;k=m.split(",");g=[];for(l=0,h=k.length;l<h;l++){j=k[l];g.push(parseInt(j))}return g};f.position=f.position?(function(){var j,h,i,g;i=f.position.split(" ");g=[];for(j=0,h=i.length;j<h;j++){d=i[j];g.push(e(d))}return g})():[];return f};courseload.api_online._convert_array_to_position=function(e){var d;return((function(){var h,g,f;f=[];for(h=0,g=e.length;h<g;h++){d=e[h];f.push(d.join(","))}return f})()).join(" ")};courseload.api_online.BaseSearch=(function(){function d(i,e,h,g,f){this.section=i;this.slug=e;this.query=h;this.pageStart=g!=null?g:"*";this.pageEnd=f!=null?f:"*";this.buffer=[];this.length;this.start=0;this.consumed=0;this.datasourceExhausted=false}d.prototype.fromBeginning=function(){var e;if((e=this.pageStart)!==0&&e!=="*"){this.buffer=[];this.start=0;this.consumed=0;this.total=0;this.pageEnd=this.pageStart-1;this.pageStart="*"}return this};d.prototype.hasMore=function(){return !(this.buffer.length===0&&this.datasourceExhausted)};d.prototype.ensure=function(g,f){var e=this;if(this.buffer.length<g&&(this.start===0||!this.datasourceExhausted)){this.load(g,function(h){e.datasourceExhausted=h;return f()});return this.start+=g}else{return f()}};d.prototype.next=function(g,f){var e=this;if(g==null){g=5}return this.ensure(g*2,function(){var h;h=e.buffer.splice(0,g);e.consumed+=h.length;return f(h)})};return d})();courseload.api_online.SolrSearch=(function(e){c(d,e);function d(){return d.__super__.constructor.apply(this,arguments)}d.prototype.mergeHighlights=function(g){var f,j,l,i,k,h;k=g.response.docs;h=[];for(l=0,i=k.length;l<i;l++){j=k[l];f=g.highlighting[j.id].text[0];h.push(this.buffer.push({id:j.id,page:j.page,slug:j.slug,highlights:f,match:"… "+f+" …"}))}return h};d.prototype._query=function(g){var f;f={q:this.query,wt:"json",start:this.start,rows:g,indent:true,"hl.simple.pre":'<span class="search-highlight"><em>',"hl.simple.post":"</em></span>"};return $.getJSON("/api/search/"+this.slug+"/?"+($.param(f)))};d.prototype.load=function(h,g){var f=this;return this._query(h).done(function(j){var i;i=j.response.numFound===j.response.docs.length+j.response.start;f.mergeHighlights(j);return g(i)})};return d})(courseload.api_online.BaseSearch);courseload.api_online.MarkupSearch=(function(e){c(d,e);function d(){return d.__super__.constructor.apply(this,arguments)}d.prototype.mergeHighlights=function(l){var h,k,i,j,g,f;f=[];for(j=0,g=l.length;j<g;j++){i=l[j];k=_.map(i.highlights,this._fixup_hl_markup);f.push((function(){var o,m,n;n=[];for(o=0,m=k.length;o<m;o++){h=k[o];n.push(this.buffer.push({href:i.href,page:i.page,highlights:k,match:h}))}return n}).call(this))}return f};d.prototype._fixup_hl_markup=function(f){return f.replace("<em>",'<span class="search-highlight"><em>').replace("</em>","</em></span>")};d.prototype._query=function(h){var g,f;g=$.param({q:this.query,start:this.start,rows:h});f="/api/markup/user/search/";if(this.section){f+=""+this.section+"/"+this.slug+"/"}else{f+=""+this.slug+"/"}return $.getJSON(""+f+"?"+g)};d.prototype.load=function(h,g){var f=this;return this._query(h).done(function(j){var i;f.mergeHighlights(j.matches);i=j.numFound===j.matches.length+j.start;return g(i)})};return d})(courseload.api_online.BaseSearch);courseload.api_online.print=function(d,f,e,g){return $.ajax({url:courseload.data.manifest.print_uri,headers:{"X-CSRFToken":courseload.data.csrftoken},type:"POST",dataType:"json",data:{first_page:f,last_page:e},statusCode:{400:function(h,j,i){return g({status:"bad_range"})},403:function(h,j,i){return g({status:"limit_exceeded"})}}}).success(function(i,j,h){return g(i)})};courseload.api_online.polljob=function(g,h){var e,d,f;e=["waiting","inprogress"];d="";f=function(){return courseload.api_online.getjob(g,function(j){var i;if(j){if(d!==j.status){d=j.status;h(j)}if(i=j.status,b.call(e,i)>=0){return window.setTimeout(f,1000)}}else{return h()}})};return f()};courseload.api_online.getjob=function(d,e){return $.getJSON(d.href).success(function(g,h,f){return e(g)}).error(function(f,h,g){return e()})};courseload.api_online.getreleasenotesacknowledgement=function(d){return $.getJSON(d.release_notes_ack_uri)};courseload.api_online.markreleasenotesacknowledgement=function(d){return $.ajax({url:d.release_notes_ack_uri,type:"POST",headers:{"X-CSRFToken":courseload.data.csrftoken}})};courseload.api_online.sendFeedback=function(d){return $.ajax({url:"/api/feedback/",headers:{"X-CSRFToken":courseload.data.csrftoken},type:"POST",data:d,dataType:"json"}).done(function(){return courseload.feedback.alert("success")}).fail(function(){return courseload.feedback.alert("fail")})};courseload.api=$.extend(true,{},courseload.api_online)}).call(this);(function(){namespace("courseload");courseload.pluralize=function(c,b,a){if(c===1){return b}else{return a}};courseload.possessify=function(a){var b;b=a.match(/[s]$/i)?"'":"'s";return a+b};courseload.truncate=function(a,b){if(a.length>b){a=a.substring(0,b)+"... "}return a}}).call(this);(function(){var c,b,a,e,g,f,i,h,d;namespace("courseload.offline");f=function(){var j;if(window.localStorage&&localStorage.checkout&&window.applicationCache&&applicationCache.status===applicationCache.UNCACHED){localStorage.removeItem("checkout");j=new Date("Fri Dec 31 1999").toGMTString();return document.cookie="offline=; expires="+j+"; path=/;"}};f();courseload.offline.syncing=false;courseload.offline.isBusy=function(){var j;return(window.frames.offlineFrame&&window.frames.offlineFrame.applicationCache&&((j=window.frames.offlineFrame.applicationCache.status)===window.frames.offlineFrame.applicationCache.DOWNLOADING||j===window.frames.offlineFrame.applicationCache.CHECKING))||courseload.offline.syncing};courseload.offline.approvedBrowser=function(){return !window.externalHost&&/chrome/.test(navigator.userAgent.toLowerCase())};i=courseload.offline.approvedBrowser();courseload.offline.materialIsOffline=function(){if(courseload.data&&courseload.data.classmaterial){return courseload.data.classmaterial.is_downloading||courseload.data.classmaterial.is_checked_out}else{return false}};courseload.offline.materialIsDownloading=function(){if(courseload.data&&courseload.data.classmaterial){return courseload.data.classmaterial.is_downloading}else{return false}};courseload.offline.disableMarkups=function(){var j;j=courseload.offline.materialIsDownloading();if(j){alert("Markups cannot be manipulated for materials that are being downloaded.")}return j};h=null;courseload.offline.status=function(j){if(i){if(!h){h=courseload.api.offlinestatus()}h.success(function(k){return j(k.online)});return h.error(function(k){return j(false)})}else{return j(true)}};courseload.offline.checkin=function(j){j.is_checked_out=false;j.is_downloading=false;courseload.api.checkin(j).success(function(){var k;if(courseload.data.classmaterial&&courseload.data.classmaterial.uri&&courseload.data.classmaterial.uri===j.uri){courseload.api=$.extend(true,{},courseload.api_online)}k=localStorage.checkout&&JSON.parse(localStorage.checkout);if(k){return a(k)}});if(window.localStorage){localStorage.removeItem(j.checkout);return localStorage.removeItem(j.uri)}};courseload.offline.synchOfflineData=function(o){var k,r,u,v,s,p,j,m,l,t,n;if(Modernizr.localstorage){k="/api/bookmark/"+o.section+"/"+o.slug+"/";s="/api/markup/"+o.section+"/"+o.slug+"/";j={};j.classmaterial=o;j.actions=[];j.count=0;for(r=m=n=localStorage.length-1;n<=0?m<=0:m>=0;r=n<=0?++m:--m){u=localStorage.key(r);if(!u){courseload.api.checkin(o);return $(document).trigger("markupsQueue",[j])}if(u.indexOf(s)===0||u.indexOf(k)===0){p=JSON.parse(localStorage[u]);for(l=0,t=p.length;l<t;l++){v=p[l];if(v.offline){switch(v.offline.verb){case"POST":if(v.position){courseload.api_online._convert_array_to_position}j.actions.push({key:u,markup:v});break;case"DELETE":if(!v.offline.hsid){j.actions.push({key:u,markup:v})}}}}}}j.count=j.actions.length;return $(document).trigger("markupsQueue",[j])}};g=null;courseload.offline.checkout=function(j){g=$.Deferred();g.classmaterial=j;j.is_checked_out=true;j.is_downloading=true;courseload.api.checkout(j).success(function(k){g.checkout=k;courseload.api.checkoutDownloading(k);a(k);if(Modernizr.localstorage&&(k!=null)){return localStorage.setItem(j.checkout,JSON.stringify(k))}});return g};a=function(j){$("#offlineFrame").remove();return $("#offlineFrameTemplate").tmpl().appendTo("body").attr("src",j.download)};courseload.offline.abort=function(){$("#offlineFrame").remove();if(g){if(g.classmaterial){g.classmaterial.is_downloading=false;g.classmaterial.is_checked_out=false;g.reject(g.classmaterial)}return g=null}};courseload.offline.downloadError=function(){if(g){alert('"'+g.classmaterial.title+'" could not be downloaded. Please check your internet connection and try again.')}return courseload.offline.abort()};courseload.offline.downloadObsolete=function(k){var j;j=localStorage.checkout&&JSON.parse(localStorage.checkout);if(j&&j.download===k){return localStorage.removeItem("checkout")}};courseload.offline.downloadComplete=function(){var k,j;j=localStorage.checkout&&JSON.parse(localStorage.checkout);if(g){if(g.classmaterial){g.classmaterial.is_downloading=false;g.resolve(g.classmaterial)}courseload.api.checkoutComplete(g.checkout);if(j){a(j)}localStorage.checkout=JSON.stringify(g.checkout);if(g.classmaterial){if(courseload.data.classmaterial&&courseload.data.classmaterial.uri&&courseload.data.classmaterial.uri===g.classmaterial.uri){courseload.api=$.extend(true,{},courseload.api_offline);$("section.search").remove()}if(Modernizr.localstorage){b(g.classmaterial)}}if(g.intercept){k=function(){var l;$("#container").remove();l=$("#interceptReloadTemplate").tmpl().prependTo("body");return l.find("button.brown").bind("click",function(m){return window.location.reload()})};_.delay(k,2000)}g=null}return courseload.nav.refresh()};b=function(k){var j,l,n,m;m="/api/markup/"+k.section+"/"+k.slug;l="/api/bookmark/"+k.section+"/"+k.slug;n="/api/notes/"+k.section+"/"+k.slug+"/?me=1&instructor=1";$.getJSON(n).done(function(u){var r,o,s,t,q,p;p=[];for(t=0,q=u.length;t<q;t++){r=u[t];courseload.api_offline._convert_position_to_array(r);o=""+m+"/"+r.page+"/";r.offline={verb:""};s=JSON.parse(localStorage.getItem(o));if(!$.isArray(s)){s=[]}s.push(r);p.push(localStorage.setItem(o,JSON.stringify(s)))}return p});j="/api/offline/markup/"+k.section+"/"+k.slug+"/bookmark/all/";return $.getJSON(j).done(function(t){var r,o,s,q,p;p=[];for(s=0,q=t.length;s<q;s++){r=t[s];o=""+l+"/"+r.page+"/";r.offline={verb:""};p.push(localStorage.setItem(o,JSON.stringify([r])))}return p})};courseload.offline.updateProgress=function(l,j){var k;k=$("#checkoutProgress");if(k.length===0){return}return k.attr("max",j).attr("value",l)};courseload.offline.getExpiry=function(l){var o,q,k,n,j,m,p;n={is_expired:false,show_warning:false};if(Modernizr.localstorage){o=JSON.parse(localStorage.getItem(l.checkout));if(o&&o.expiry){p=o.total_days;k=Date.parse(o.expiry);m=new Date();n.is_expired=m>k;if(n.expired){n.days_remaining=0}else{j=1000*60*60*24;q=Math.round((k.getTime()-m.getTime())/j);n.days_remaining=q}n.show_warning=n.daysRemaining<=(p/2)}}return n};courseload.offline.updateIntercept=function(j){var k;if(!i||!window.applicationCache||applicationCache.status===applicationCache.UNCACHED){$(document).trigger("userloggedin",[j]);return}if(applicationCache.status===applicationCache.CHECKING){k=function(l){return function(){return courseload.offline.updateIntercept(l)}};_.delay(k(j),100);return}return courseload.offline.status(function(n){var p,m,o,l;if(!n){return $(document).trigger("userloggedin",[j])}else{if((o=applicationCache.status)===applicationCache.UPDATEREADY||o===applicationCache.OBSOLETE){return p=$("#interceptReloadTemplate").tmpl().prependTo("body").find("button.brown").bind("click",function(q){return window.location.reload()})}else{if((l=applicationCache.status)===applicationCache.IDLE){m=courseload.api.checkForUpdates();return m.success(function(q){if(m.status===200){$(".emptyOnLogout").empty();$(".removeOnLogout").remove();$("#container").remove();p=$("#updateInterceptTemplate").tmpl().prependTo("body");g=$.Deferred();g.intercept=true;g.checkout=q;courseload.api.checkoutDownloading(q);return a(q)}else{return $(document).trigger("userloggedin",[j])}})}else{return $(document).trigger("userloggedin",[j])}}}})};c=(function(){function j(){}return j})();d=function(){var s,v,u,p,r,j,k,o,n,t,l,m;if(!window.localStorage){return}m=[];for(o=0,t=localStorage.length;o<t;o++){u=localStorage[o];v=localStorage.key(o);switch(v){case"courseload.api.logPageRead":j=JSON.parse(localStorage.getItem(v));if($.isArray(j)){k={};k.functions=[];for(n=0,l=j.length;n<l;n++){r=j[n];p=new c;p.log_page_read=r.url;p.pageIndex=r.pageIndex;s=(function(q){return function(){return courseload.api_online.logPageRead(q,q.pageIndex,true)}})(p);k.functions.push(s)}$(document).trigger("pageReadQueue",[k]);m.push(localStorage.removeItem(v))}else{m.push(void 0)}break;default:m.push(void 0)}}return m};if(i&&window.applicationCache&&applicationCache.status!==applicationCache.UNCACHED){courseload.offline.status(function(j){if(!j){if(!courseload.api_offline){log("ERROR: courseload.api.offline must load before courseload.offline")}return courseload.api=$.extend(true,{},courseload.api_offline)}else{return _.delay(d,10000)}})}$(document).bind("pageReadQueue",function(m,k){var l,j;if(k&&k.functions&&k.functions.length){l=k.functions.shift();j=l();j.success(function(){return $(document).trigger("pageReadQueue",[k])});return j.error(function(){return $(document).trigger("pageReadQueue",[k])})}});e=function(k){var l,m,n,o,q,p,j;o="/api/markup/"+k.section+"/"+k.slug;l="/api/bookmark/"+k.section+"/"+k.slug;j=[];for(m=q=p=localStorage.length-1;p<=0?q<=0:q>=0;m=p<=0?++q:--q){n=localStorage.key(m)||[];if(n.indexOf(o)===0||n.indexOf(l)===0){j.push(localStorage.removeItem(n))}else{j.push(void 0)}}return j};$(document).bind("markupsQueue",function(o,k){var n,l,m,j;if(k&&k.actions){if(k.actions.length===0){e(k.classmaterial);$(document).trigger("syncComplete",[k.classmaterial])}if(k.actions.length){n=k.actions.shift();l=n.markup;m=(function(q,p){return function(){var s,u,t,r;l=q.markup;u=JSON.parse(localStorage[q.key]);for(t=0,r=u.length;t<r;t++){s=u[t];if(!(s.offline&&((s.uri===l.uri)||(s.offline.hsid===l.offline.hsid)))){continue}s.offline.verb="";break}localStorage.setItem(q.key,JSON.stringify(u));courseload.offline.updateProgress(p.count-p.actions.length,p.count);return $(document).trigger("markupsQueue",[p])}})(n,k);switch(l.offline.verb){case"POST":j=courseload.api_online.savemarkup(courseload.data.manifest,l);break;case"DELETE":j=courseload.api_online.deletemarkup(courseload.data.manifest,l)}j.done(function(p){return m()});return j.fail(function(q){var p;switch(q.status){case 404:switch(l.offline.verb){case"POST":n.markup.uri="";p=courseload.api_online.savemarkup(courseload.data.manifest,l);p.done(function(r){return m()});return p.fail(function(r){log("sync 404 -> insert failed");alert("We are having trouble syncing your data. Please verify your internet connection and retry your check in.");return courseload.nav.refresh()});case"DELETE":return m()}break;case 403:return m();default:log("sync "+q.status+" -> sync failed");alert("We are having trouble syncing your data. Please verify your internet connection and retry your check in.");return courseload.nav.refresh()}})}}})}).call(this);(function(){var a,b;namespace("courseload.api_offline");if(!courseload.api_online){log("ERROR: courseload.api must load before courseload.api_offline")}courseload.api_offline=$.extend(true,{},courseload.api_online);courseload.api_offline.logPageRead=function(d,c){var e;e=courseload.api_online.logPageRead(d,c).error(function(){var g,f;if(window.localStorage){g={url:d.log_page_read,pageIndex:c};f=JSON.parse(localStorage.getItem("courseload.api.logPageRead"));if(!$.isArray(f)){f=[]}f.push(g);return localStorage.setItem("courseload.api.logPageRead",JSON.stringify(f))}});if(window.localStorage){localStorage[d.uri]=JSON.stringify({last_page_read:c})}return e};courseload.api_offline.getroster=function(c){return $.getJSON(c.roster)};courseload.api_offline.getmarkuplist=function(){var c,e,d;d=courseload.data.user.uri;c=new $.Deferred();e=courseload.api_offline._getmarkuplist(d);c.resolve(e);return c};courseload.api_offline.getmarkup=function(f,c){var d,g,e;e=courseload.data.user.uri;d=new $.Deferred();g=courseload.api_offline._getmarkup(c,e);d.resolve(g);return d};courseload.api_offline.getnotes=function(c,f){var d,g,e;e=courseload.data.user.uri;d=new $.Deferred();g=courseload.api_offline._getnotes(f,e);d.resolve(g);return d};courseload.api_offline.getbookmarks=function(f){var h,c,k,j,g,i,d,e;k="/api/bookmark/"+f.section+"/"+f.slug;c=[];j=new $.Deferred();if(!localStorage.length){return c}for(g=d=0,e=localStorage.length-1;0<=e?d<=e:d>=e;g=0<=e?++d:--d){i=localStorage.key(g);if(i.indexOf(k)===0){h=JSON.parse(localStorage[i]);if($.isArray(h)&&h.length===1){h=h[0]}if(h.offline&&h.offline.verb!=="DELETE"){c.push(h.page)}}}j.resolve(c);return j};courseload.api_offline.deletemarkup=function(h,e){var d,f,j,g,i,c;if(!e.uri&&!e.offline.hsid){return}if(!e.offline){e.offline={}}e.offline.verb="DELETE";g=e.type==="bookmark"?"bookmark":"markup";f="/api/"+g+"/"+courseload.data.classmaterial.section+"/"+courseload.data.classmaterial.slug+"/"+e.page+"/";if(localStorage[f]){j=JSON.parse(localStorage[f])}if($.isArray(j)){for(i=0,c=j.length;i<c;i++){d=j[i];if((d.uri&&d.uri===e.uri)||(e.offline.hsid&&d.offline.hsid===e.offline.hsid)){j.splice(i,1);break}}j.push(e);localStorage.setItem(f,JSON.stringify(j))}$("#track").trigger("markup_deleted",e);if($(".note-edit-panel").length){return $(".note-edit-panel").trigger("markup_deleted",e)}};courseload.api_offline.savemarkup=function(d,k){var l,c,j,g,e,h,f,i;e=new Date().getTime();k.author=courseload.data.user.uri;if(!k.offline){k.offline={}}if(!k.uri&&!k.offline.hsid){k.offline.hsid=e}k.offline.verb="POST";h=k.type==="bookmark"?"bookmark":"markup";l=new $.Deferred();if(k.offline.hsid&&k.offline.hsid===e){$("#track").trigger("markup_created",k)}j="/api/"+h+"/"+courseload.data.classmaterial.section+"/"+courseload.data.classmaterial.slug+"/"+k.page+"/";if(localStorage[j]){g=JSON.parse(localStorage[j])}if($.isArray(g)){if(k.uri||(k.offline.hsid&&k.offline.hsid!==e)){for(f=0,i=g.length;f<i;f++){c=g[f];if((c.uri&&c.uri===k.uri)||(c.offline.hsid===k.offline.hsid&&k.offline.hsid!==void 0)){g.splice(f,1);break}}}g.push(k)}else{g=[k]}localStorage.setItem(j,JSON.stringify(g));l.resolve(k);return l};a=function(){var d,c;c="/api/markup/"+courseload.data.classmaterial.section+"/"+courseload.data.classmaterial.slug+"/";d="/api/bookmark/"+courseload.data.classmaterial.section+"/"+courseload.data.classmaterial.slug+"/";return[c,d]};b=function(h,c,d){var i,f,k,g,e,j;g=[];f=_.pluck(courseload.data.book.instructors,"user");for(e=0,j=h.length;e<j;e++){k=h[e];i=k[c];switch(courseload.data.book.notesetting){case 0:if(i===d&&k.offline.verb!=="DELETE"){g.push(k)}break;case 1:if(i!==d){g.push(k)}break;case 3:if(k.author===d||$.inArray(k.author,f)!==-1&&k.type!=="response"){g.push(k)}}}return g};courseload.api_offline._getmarkuplist=function(l){var c,j,m,k,h,i,g,e,f,d;f=a(),k=f[0],c=f[1];h=[];if(!localStorage.length){return h}for(j=e=0,d=localStorage.length-1;0<=d?e<=d:e>=d;j=0<=d?++e:--e){m=localStorage.key(j);if(m.indexOf(k)===0){i=_.filter(JSON.parse(localStorage[m]),function(n){return n.offline});g=b(i,"author",l);h=h.concat(g)}}return h};courseload.api_offline._getmarkup=function(d,n){var l,c,k,o,m,j,i,h,f,g,e;g=a(),m=g[0],c=g[1];j=[];if(!localStorage.length){return j}for(k=f=0,e=localStorage.length-1;0<=e?f<=e:f>=e;k=0<=e?++f:--f){o=localStorage.key(k);if(o.indexOf(m)===0){i=_.filter(JSON.parse(localStorage[o]),function(p){return p.offline&&p.page===d});h=b(i,"author",n);j=j.concat(h)}else{if(o.indexOf(c)===0){l=JSON.parse(localStorage[o]);if($.isArray(l)&&l.length===1){l=l[0]}if(l.page===d&&l.offline&&l.offline.verb!=="DELETE"){j.push(l)}}}}return j};courseload.api_offline._getnotes=function(q,n){var c,k,o,p,l,j,i,d,g,f,m,h,e;j=[];if(!q){q={me:1,instructor:1}}h=a(),l=h[0],c=h[1];for(k=g=0,e=localStorage.length-1;0<=e?g<=e:g>=e;k=0<=e?++g:--g){o=localStorage.key(k);if(o.indexOf(l)===0){i=courseload.markup.filterNotesOnly(JSON.parse(localStorage[o]));for(f=0,m=i.length;f<m;f++){p=i[f];if(p.offline&&p.note_text!==""){if(q.me&&q.instructor){if(p.offline.verb!=="DELETE"){j.push(p)}}else{if(q.me){if(p.author===n&&p.offline.verb!=="DELETE"){j.push(p)}}else{if(q.instructor){if(p.author!==n){j.push(p)}}}}}}}}if(q.page){d=_.filter(j,function(r){return r.page===q.page});j=d}return j}}).call(this);(function(){var a;namespace("courseload");courseload.resize=function(){var e,f,d,c,b;e=$("#main");if(e.length===0){return}f=$(window);c=$("div.menu:visible").outerHeight(true);d=$(".footer.tracker").outerHeight(true);b=f.height()-c-d;e.height(b);e.trigger("resized");return $(".externallinkcontainer:visible").trigger("resized")};a=_.debounce(courseload.resize,50);$(window).resize(a);$(function(){return courseload.resize()})}).call(this);(function(){namespace("courseload.screen");$(document).bind("fullscreenchange",function(a){if(!document.fullscreen){return courseload.book.disableFullScreen()}});$(document).bind("webkitfullscreenchange",function(a){if(!document.webkitIsFullScreen){return courseload.book.disableFullScreen()}});$(document).bind("mozfullscreenchange",function(a){if(!document.mozFullScreen){return courseload.book.disableFullScreen()}});courseload.screen.enterFullScreen=function(){var a;courseload.book.page.clearCurrentZoomLevel();courseload.screen.collapsePanels();a=$("html")[0];if(a.requestFullScreen&&!document.fullscreen){return a.requestFullScreen()}else{if(a.webkitRequestFullScreen&&!document.webkitIsFullScreen){return a.webkitRequestFullScreen(a.ALLOW_KEYBOARD_INPUT)}else{if(a.mozRequestFullScreen&&!document.mozFullScreen){return a.mozRequestFullScreen()}}}};courseload.screen.exitFullScreen=function(){courseload.book.page.clearCurrentZoomLevel();courseload.screen.expandPanels();if(document.exitFullScreen&&document.fullscreen){return document.exitFullScreen()}else{if(document.webkitCancelFullScreen&&document.webkitIsFullScreen){return document.webkitCancelFullScreen()}else{if(document.mozCancelFullScreen&&document.mozFullScreen){return document.mozCancelFullScreen()}}}};courseload.screen.collapsePanels=function(){courseload.screen.collapseNavPanel();return courseload.screen.collapseNotePanels()};courseload.screen.collapseNavPanel=function(){var a;a=$("#main > .nav");if(a.hasClass("open")){a.find(".new-question-notifications .notification").toggle();return a.removeClass("open closed").addClass("closed").find(".nav-content-wrapper").toggle()}};courseload.screen.collapseNotePanels=function(){return $("div.page").each(function(){var a;a=$(this);if(a.hasClass("open")){a.removeClass("open closed").addClass("closed");return courseload.data.book.showSidebar=false}})};courseload.screen.expandPanels=function(){courseload.screen.expandNavPanel();return courseload.screen.expandNotePanels()};courseload.screen.expandNavPanel=function(){var a;a=$("#main > .nav");if(a.hasClass("closed")){a.removeClass("open closed").addClass("open").find(".nav-content-wrapper").toggle();return a.find(".new-question-notifications .notification").toggle(a.hasClass("open"))}};courseload.screen.expandNotePanels=function(){return $("div.page").each(function(){var a;a=$(this);if(a.hasClass("closed")){a.removeClass("open closed").addClass("open");return courseload.data.book.showSidebar=true}})}}).call(this);(function(){namespace("courseload.bookmark");courseload.bookmark.remove=function(b,a){var c;c=a.data("bookmark");courseload.api.deletemarkup(courseload.data.manifest,c);a.removeClass("active");return courseload.nav.ui.removeBookmark(b.data("pageIndex"))};courseload.bookmark.add=function(b,a){var d,c;c=courseload.data.manifest;d={type:"bookmark",page:b.data("pageIndex"),slug:c.slug,section:courseload.data.classmaterial.sectionUri};courseload.api.savemarkup(c,d);a.data("bookmark",d).addClass("active");return courseload.nav.ui.addBookmark(b.data("pageIndex"))};$(".page").live("dataloaded",function(g){var c,b,d,f,a;b=$(this);f=b.data();d=(function(){var j,h,i,e;i=f.markup;e=[];for(j=0,h=i.length;j<h;j++){a=i[j];if(a.type==="bookmark"&&a.author===courseload.data.user.uri){e.push(a)}}return e})();c=b.find(".class-material-tools .bookmark");if(d.length!==0){c.data("bookmark",d[0]).addClass("active")}if(courseload.markup.allowAnnotation()){return c.toggleClass("allowedPointer","notAllowed").attr("title","")}else{return c.toggleClass("notAllowed","allowedPointer").attr("title",'To change the bookmark, please select "Me" from notes sidebar.')}});$(".page button.bookmark").live("click",function(c){var b,a;if(!courseload.markup.allowAnnotation()||courseload.offline.disableMarkups()){return}c.preventDefault();b=$(this);a=b.closest(".page");if(b.hasClass("active")){return courseload.bookmark.remove(a,b)}else{return courseload.bookmark.add(a,b)}})}).call(this);(function(){var c,d,a,b=[].indexOf||function(g){for(var f=0,e=this.length;f<e;f++){if(f in this&&this[f]===g){return f}}return -1};namespace("courseload.book.notes");$(document).on("click","a.print-notes",function(f){f=courseload.touch.getEvent(f);f.preventDefault();$("#printable").empty().removeClass("printable");$(".sidebar").addClass("printable");return window.print()});courseload.book.notes._flattenTOC=c=function(){var m,f,g,j,i,l,e,k,h;g=[];k=courseload.data.manifest.TOC;for(j=0,l=k.length;j<l;j++){m=k[j];g.push({name:m.name,page:m.page,pages:[]});h=m.sections;for(i=0,e=h.length;i<e;i++){f=h[i];if(_.last(g).page===f.page){g.pop()}g.push({name:f.name,page:f.page,pages:[]})}}return g};courseload.book.notes._nestNotes=d=function(w,y){var v,z,p,B,r,m,k,o,i,n,t,u,A,C,s,j,h,g,f,F,H,G,E,D,e,q,l;A=_.sortBy(c(),function(I){return I.page});w=_.sortBy(w,function(I){return I.page});m=true;t=(function(){var J,I,x;x=[];for(J=0,I=w.length;J<I;J++){s=w[J];x.push(s.page)}return x})();t=_.uniq(t,m);if(A.length===0){A=[{name:"All Notes",page:0,pages:[]}]}if(A[0].page!==0){A.splice(0,0,{name:"",page:0,pages:[]})}C=(function(){var J,I,x;x=[];for(J=0,I=A.length;J<I;J++){s=A[J];x.push(s.page)}return x})();o=[];B={};u={};if(y||y===0){_.each(w,function(I,J){if(I.type==="response"){return u[I.in_response_to]=I}});w=_.filter(w,function(I){return I.type!=="response"});_.each(w,function(I){if(u[I.uri]){return I.response=u[I.uri]}});w={count:w.length,notes:w};return w}else{for(j=0,F=w.length;j<F;j++){k=w[j];if(k.type==="response"){u[k.in_response_to]=k;continue}z=_.sortedIndex(C,k.page+1)-1;v=A[z];p=B[k.page];if(!p){p={page:k.page,notes:[],responses:{}};B[k.page]=p;v.pages.push(p)}p.notes.push(k)}for(h=0,H=A.length;h<H;h++){v=A[h];q=v.pages;for(g=0,G=q.length;g<G;g++){n=q[g];l=n.notes;for(f=0,E=l.length;f<E;f++){k=l[f];if(u.hasOwnProperty(k.uri)){k.response=u[k.uri]}}}}for(e=0,D=A.length;e<D;e++){v=A[e];r=function(J,I){return J+I.notes.length};i=_.reduce(v.pages,r,0);v.count=i}A=_.select(A,function(I){return I.count>0});return A}};courseload.book.notes.x=d;courseload.book.notes.get_taglist=function(k){var j,f,o,i,n,m,h,g,l,e;i=[];f=(function(){var r,q,p;p=[];for(r=0,q=k.length;r<q;r++){m=k[r];p.push((m.tags||"").split(","))}return p})();for(h=0,l=f.length;h<l;h++){n=f[h];for(g=0,e=n.length;g<e;g++){o=n[g];o=$.trim(o);if(o){i.push(o)}}}i=_.uniq(i);j=true;i.naturalSort(j);return i};courseload.book.notes.editMarkup=function(h,e){var g,i,f;$(h).addClass("edit");g=$(h).find(".note-details");g.empty();f=$("#main > .nav").data();i=f.membership&&f.membership.role==="instructor";$("#noteDetailsForm").tmpl({markup:e,isInstructor:i}).appendTo(g);if(e.is_question){g.find("#is_question").prop("checked",true)}if(e.color){g.find(".color-list li."+e.color).addClass("current").find(".color-select").attr("checked","checked")}$(".color-list li").click(function(){var j;j=$(this);$(".color-list li").removeClass("current");j.addClass("current");j.closest(".color-list").find(".color-select").attr("checked",false);j.find(".color-select").attr("checked","checked");return e.temp_color=j.data("color")});return $(".footer button, .footer a",h).click(function(l){var k,j;l.preventDefault();j=$(l.target);k=$("#container");if(j.attr("href")==="#cancel"){courseload.book.notes.populateNoteMetaData(h,e,k)}else{e.color=e.temp_color||e.color;courseload.book.notes.updateMarkup(h,e,k);k.find(".icon-pencil, .icon-trash").show()}if(e.temp_color){return delete e.temp_color}})};courseload.book.notes.populateNoteMetaData=function(h,e,i){var g,j,k,f;g=$(h).find(".note-details");g.empty();$(h).removeClass("edit");f=$("#main > .nav").data();j=f.membership?courseload.api.getroster(f.membership.section):[[courseload.data.user]];k=f.membership&&f.membership.role==="instructor";$.when(j).done(function(p){var m,n,o,l;n={};for(o=0,l=p.length;o<l;o++){m=p[o];n[m.user?m.user:m.uri]=m}return $("#noteDetails").tmpl(e,{isInstructor:k,getUserName:function(q){return n[q.author].name},getCreatedTimestamp:function(q){var r;return r=new Date(q.created).toString("d")+" "+new Date(q.created).toString("t")},splitTags:function(r){var q;return(function(){var u,t,v,s;v=r.split(",");s=[];for(u=0,t=v.length;u<t;u++){q=v[u];s.push($.trim(q))}return s})()}}).appendTo(g).find(".note-text-body").linkify(function(q){return q.attr("target","_blank")})});g.parent().find(".note-meta .annotation").attr("class","annotation "+e.color);return $(i).find(".icon-pencil,.icon-trash").show()};courseload.book.notes.updateMarkup=function(h,f,i){var e,g;e=$(h).find("#edit-note-form");f.note_text=e.find("#edit-note-text").val();f.tags=e.find("#edit-note-tags").val();f.is_question=e.find("#is_question").prop("checked");f.color=e.find(".color-list .current").data("color");courseload.api.savemarkup(courseload.data.manifest,f);courseload.book.notes.populateNoteMetaData(h,f,i);g={type:"success",title:"Note Updated",message:"Your note has been updated."};return courseload.banner.alertsMessage(i,g)};courseload.book.notes.load=function(e,j,f){var r,p,g,n,k,h,o,i,m,q,l;o=$("#main > .nav").data();h=o.membership&&o.membership.role==="instructor";k=o.membership?courseload.api.getroster(o.membership.section):[[courseload.data.user]];i={};r=e.find(".header > form");i.me=r.find('input[name="show-from-me"]:checked').length;i.instructor=r.find('input[name="show-from-instructor"]:checked').length;p=[];_.each(r.find(".checklist .student input[type=checkbox]:checked"),function(s){return p.push($(s).val())});if(p){i.classmates=p.join()}if(e.data("tmplItem").data.pageIndex!==void 0){i.page=e.data("tmplItem").data.pageIndex}l=courseload.data.classmaterial.title;m=courseload.data.classmaterial.notes;n=m+"Notes - "+encodeURIComponent(l)+".csv";if(courseload.data.section){g={notes:n};n=courseload.api._getnotes_buildurl(g,i)}e.find(".export-notes").attr("href",n);j=j||courseload.api.getnotes(courseload.data.classmaterial,i);courseload.markup.getPageNotes(courseload.data.book.currentPage);q=$(".page").data().notescount||"";courseload.book.notes.loadHeader(q);return $.when(j,k).done(function(C,I){var B,D,w,F,M,x,y,v,E,A,H,z,G,N,J,t,u,s,K,L;I=I[0];v={showresponses:true};C=courseload.markup.filterNotesOnly(C,v);A=_.pluck(C,"page");t=_.uniq(A);if(t.length===1&&t[0]===courseload.data.book.currentPage){E=courseload.data.book.currentPage}J=courseload.book.notes.get_taglist(C);D=$("#select-tag");G=D.find("option:selected").val();D.find('option[value!=""]').remove();for(u=0,K=J.length;u<K;u++){N=J[u];D.append('<option value="'+N+'">'+N+"</option>")}D.find('option[value="'+G+'"]').prop("selected",true);f=f||e.data("filter");w=f?f(C):C;z={};for(s=0,L=I.length;s<L;s++){M=I[s];z[M.user?M.user:M.uri]=M}e.data({notes:C,filter:f});x=d(w,E);B=e.find(".note-edit-panel .viewport .overview");B.empty();if(_.isArray(x)&&x.length&&_.first(x).hasOwnProperty("count")){q=0;_.each(x,function(O){return q+=O.count})}else{q=x.length}if(E||E===0){y="#pageNotePanelTemplate";if(x.hasOwnProperty("count")){q=x.count}}else{y="#notePanelTemplate"}if(q){H=$("#notesReultsCountTemplate").tmpl({notescount:q});B.prepend(H);F=_.pluck(courseload.data.book.instructors,"user");$(y).tmpl(x,{pageIndex:E,notescount:function(){return C.length},isInstructor:function(){return h},isInstructorNote:function(O){return $.inArray(O.author,F)!==-1},getUserName:function(O){return z[O.author].name},isOwner:function(O){if(O.author===courseload.data.user.uri){return true}else{return false}},getCreatedTimestamp:function(O){var P;return P=new Date(O.created).toString("d")+" "+new Date(O.created).toString("t")},splitTags:function(P){var O;return(function(){var S,Q,T,R;T=P.split(",");R=[];for(S=0,Q=T.length;S<Q;S++){O=T[S];R.push($.trim(O))}return R})()}}).appendTo(B).find("p").linkify(function(O){return O.attr("target","_blank")})}else{$("#noNotesAvailableTemplate").tmpl().appendTo(B)}return courseload.book.page.resizeNotesView()})};courseload.book.notes.loadHeader=function(g,e){var f;f=$(".page");return f.bind("notesCountLoaded",function(){var k,h,i,j;if(f.data().tmplItem.data.pageIndex||f.data().tmplItem.data.pageIndex===0){e=f.data().tmplItem.data.pageIndex}if($(".page-level-note").length||e||e===0){j=true}if(j){h={notescount:f.data().notescount,pageIndex:courseload.data.book.currentPage.toString()};k=f.data().notescount;i=e}else{h={notescount:g};k=courseload.data.book.notescount;i=false}$(".header.super").remove();$("#notesViewHeaderTemplate").tmpl(h).insertBefore(".note-edit-panel");$("p.notes-results span").text(k);if(!k){courseload.book.notes.hideResultsContent(i)}return $(".page").unbind("notesCountLoaded")})};courseload.book.notes.hideResultsContent=function(e){var f;$(".note-edit-panel .header, .notes-results h3").hide();f=$("#notesReultsMessageTemplate").tmpl({pageIndex:e});return $(".notes-results p").empty().html(f)};courseload.book.notes.allNotesCount=function(){return $(document).bind("markupListLoaded",function(){var e;e=courseload.data.book.notescount;$(".nav .book-notes-count a").text(e+courseload.pluralize(e," Note"," Notes"));$(document).unbind("markupListLoaded");return $(document).trigger("allNotesCountLoaded")})};courseload.book.notes.updateCounts=function(h){var e,g,f,j,i;e=$('.note-content[data-markup-uri="'+h+'"]');if(e.length){g=e.closest(".note-chapter");if(g.length){f=g.data().notecount-1}j=e.closest(".note-page");if(j){i=j.data().notecount-1}e.remove();if(g&&f===0){return g.remove()}else{if(f){g.data("notecount",f);g.find(".noteChapterCount").text("("+f+" "+courseload.pluralize(f,"note","notes")+")")}if(i===0){return j.remove()}else{j.find(".notePageCount").text("("+i+" "+courseload.pluralize(i,"note","notes")+")");return j.data("notecount",i)}}}};$(".page.edit-note a.noteChapter").live("click",function(g){var f;g=courseload.touch.getEvent(g);g.preventDefault();f=$(this).closest(".note-chapter").toggleClass("open closed");return f.find(".note-chapter-slide-panel").slideToggle("fast",courseload.book.page.resizeNotesView)});$(".page.edit-note a.notePage").live("click",function(g){var f;g=courseload.touch.getEvent(g);g.preventDefault();f=$(this).closest(".note-page").toggleClass("open closed");return f.find(".note-page-slide-panel").slideToggle("fast",courseload.book.page.resizeNotesView)});a=function(e){var g,f;e=e||{};f=$(".page.edit-note");g=f.find(".note-edit-panel .viewport .overview");g.empty();courseload.book.notes.load(f,e.notes,e.filter);return courseload.book.page.resizeNotesView()};courseload.book.notes.refresh=a;$(".page.edit-note .header select.selectTag").live("change",function(g){var f;f=$('.page.edit-note .header input[name="show-filter"][value="tags"]');return f.prop("checked",true).trigger("change")});$('.page.edit-note .header input[name="show-filter"]').live("change",function(g){var f,h;h=$('.page.edit-note .header input[name="show-filter"]:checked').val();f=function(e){return e};if(h==="questions"){f=function(k){var e,l,j,i;i=[];for(l=0,j=k.length;l<j;l++){e=k[l];if(e.is_question===true||e.type==="response"){i.push(e)}}return i}}if(h==="tags"){f=function(k){var n,l,i,e,m,j;i=$("#select-tag option:selected").val();n=[];for(m=0,j=k.length;m<j;m++){l=k[m];if(l.type==="response"){n.push(l)}else{e=courseload.book.notes.get_taglist([l]);if(b.call(e,i)>=0){n.push(l)}}}return n}}return a({filter:f})});$('.page.edit-note .header input[name="show-from-me"]').live("change",function(f){return a()});$('.page.edit-note .header input[name="show-from-instructor"]').live("change",function(f){return a()});$('.page.edit-note .checklist input[type="checkbox"]').live("change",function(l){var r,q,f,h,m,g,p,k,s,t,n,i,o,j;g=$(this);h=$(this).closest(".checklist");f=h.find("input[type=checkbox]");q=h.find(".select-all-students label");r=h.find(".select-all-students input");s=[];j=h.find('.student input[type="checkbox"]:checked');for(i=0,o=j.length;i<o;i++){k=j[i];s.push($(k).val())}m=$("#show-from-classmates");m.val(s.join(","));if(g.is("#classmate_select_all")){if($(this).prop("checked")){t="Deselect All";p=true;n=true}else{t="Select All";p=false;n=false}q.text(t);_.each(f,function(e){return $(e).prop("checked",p)})}else{if(s.length===h.find('.student input[type="checkbox"]').length){t="Deselect All";n=true;p=true}else{if(s.length===0){t="Select All";n=false;p=false}else{t="Select All";n=true;p=false}}}m.prop("checked",n);q.text(t);r.prop("checked",p);return a()});$('.page.edit-note .header input[name="show-from-classmates"]').live("click",function(i){var g,h,f;i.preventDefault();h=$(this).prop("checked");g=$(this).parents(".sidebar").find(".checklist-container");f=function(j){if(!j||j.which===hotkeys.Escape||(j.pageX&&!$(j.target).is(".checklist *"))){g.hide();return $(document).unbind("click",f)}};g.show();return _.defer(function(){$(document).bind("click",f);return $(document).bind("keydown",f)})});$(".page.edit-note .noteReplyForm").live("submit",function(k){var g,f,j,h,i;k.preventDefault();g=$(this);f=$("#container");h=$("#main > .nav").data();j=courseload.api.getroster(h.membership.section);i=courseload.api.respondToNote({respond:g.attr("action")},g.serialize());return $.when(j,i).done(function(o,e){var s,n,q,t,m,r,l,p;o=o[0];e=e[0];m={};for(l=0,p=o.length;l<p;l++){n=o[l];m[n.user]=n}s=g.closest(".note-content");g.parent(".reply-to-note").remove();t=s.data().tmplItem.data.$value.author;q=m[t].name;$("#noteReplyTemplate").tmpl(e,{getUserName:function(){return m[e.author].name},getCreatedTimestamp:function(u){var v;return v=new Date(e.created).toString("d")+" "+new Date(e.created).toString("t")}}).appendTo(s);r={type:"success",title:"Response Sent",message:"Your response to "+q+" has been sent."};courseload.banner.alertsMessage(f,r);return courseload.notification.qanda.refresh()})});$(document).on("click",".tools a",function(j){var i,h,f,g;j.preventDefault();f=$(j.target);i=f.closest(".note-content");g=i.data().tmplItem.data.$value;if(f.hasClass("icon-pencil")){h=$("#container");h.find(".icon-pencil,.icon-trash").hide();return courseload.book.notes.editMarkup(i,g)}else{if(f.hasClass("icon-trash")){return courseload.markup.confirmDelete(g)}}})}).call(this);(function(){var b,f,d,e,c,a;namespace("courseload.markup.ui");$("highlight-link").live("click",function(g){});b=function(o,q){var g,n,k,i,m,j,h,l,p;g=$(this);if($(o.target).is("i")){i=$(o.target).parent()}else{i=$(o.target)}if(i.is(".highlight-header a")){h=i.attr("href");switch(h){case"#cancel":if(q.cancel){q.cancel()}break;case"#delete":if(q["delete"]){q["delete"]()}break;case"#addnote":k=g.parent();l=g.position();n=courseload.markup.ui.note(q).appendTo(k);courseload.markup.positionMenu(n,l.left,l.top,g);m=n.find("textarea");p=m.val();m.val("").focus().val(p);break;case"#editnote":k=g.parent();l=g.position();if(g.data("markup-uri")){q.uri=g.data("markup-uri")}n=courseload.markup.ui.note(q).appendTo(k);courseload.markup.positionMenu(n,l.left,l.top,g);m=n.find("textarea");p=m.val();m.val("").focus().val(p)}return g.remove()}else{if(i.is("li.color-block")){j=i.data("color");courseload.data.markupColor=j;if(q.save){q.save({color:j})}return g.remove()}else{if(i.is(".highlight-content a.delete")){h=i.attr("href");switch(h){case"#delete":if(q["delete"]){return q["delete"]()}}}else{if(i.is('a[href="#addnote"]')){h=i.attr("href");k=g.parent();l=g.position();n=courseload.markup.ui.note(q).appendTo(k);courseload.markup.positionMenu(n,l.left,l.top,g);$(g).remove();n.find(".highlight-header").text("Add Your Note");m=n.find("textarea");p=m.val();return m.val("").focus().val(p)}}}}};f=function(w,i){var x,k,v,q,t,h,j,s,u,n,l,g,p,o,m,r;k=$(this);g=k.data();h=$(w.target);if(i.uri){g.markupuri=i.uri}v=$("#container");if(i.pageIndex){m=k.find("#pagenote-text").val();j=k.find("#cited-text").val()}else{m=k.find("textarea").val()}if(navigator.userAgent.match(/(iPad|iPhone);.*CPU.*OS 6_\d/i)){if(!w.type&&(h.is("#is_question")||h.is("label[for='is_question']"))){$("#is_question").trigger("click")}}n=k.find("#is_question").is(":checked");k.data("is_question",n);l=k.data("is_question");t=k.find(".note-tags input");o=t.val()===t.attr("placeholder")?"":t.val();if(h.text()==="Save"&&h.closest("#add-note-form").find("#note-text-entry").val()!==""){if(w.type==="click"){w.preventDefault()}p=courseload.book.page.getLabelByIndex(i.markup.page);if(m&&i.markup.note_text===void 0){r={type:"success",title:"Note Added",message:"Your note has been added to Page "+p+"."}}else{r={type:"success",title:"Note Saved",message:"Your note on Page "+p+" has been updated."}}if(i.save){i.save({text:m,is_question:l,tags:o,color:courseload.data.markupColor})}k.remove();courseload.banner.alertsMessage(v,r);if(courseload.data.tempMarkupColor){delete courseload.data.tempMarkupColor}}if(h.is(".note-links-buttons > a.cancel")){if(w.type==="click"){w.preventDefault()}q=$(this).parent();if(i.cancel){i.cancel()}courseload.data.markupColor=courseload.data.tempMarkupColor||courseload.data.markupColor;c(i,courseload.data.markupColor,q);if(courseload.data.tempMarkupColor){delete courseload.data.tempMarkupColor}k.remove()}else{if(h.is("li.color-block")){if(w.type==="click"){w.preventDefault()}q=$(this).parent();if(i.markup.color){courseload.data.tempMarkupColor=i.markup.color}s=h.data("color");h.closest(".color-list").find(".selectedColor").removeClass("selectedColor");h.addClass("selectedColor");c(i,s,q)}else{if(h.is("#add-page-note")&&(i.pageIndex||i.pageIndex===0)){x=k.find("textarea#cited-text").val();if(i.save){i.save({text:m,is_question:l,tags:o,selection_text:x,color:courseload.data.markupColor})}courseload.book.page.loadPage(i.pageIndex);p=courseload.book.page.getLabelByIndex(i.pageIndex);r={type:"success",title:"Note Added",message:"Your note has been added to Page "+p+"."};courseload.banner.alertsMessage(v,r)}}}if(h.is(".highlight-header a")){if(w.type==="click"){w.preventDefault()}u=h.attr("href");switch(u){case"#cancel":if(i.cancel){i.cancel()}}return k.remove()}};c=function(h,g,i){if(h.uri){return e(h.uri,g)}else{return d(i,g)}};d=function(h,g){courseload.data.markupColor=g;h.attr("class","wordcontainer "+g);return h.find("button.annotation").attr("class","annotation "+g)};e=function(i,h){var g;courseload.data.markupColor=h;g=$('.sticky-note[data-markup-uri="'+i+'"]');return g.attr("class","sticky-note ui-draggable "+courseload.data.markupColor)};a=function(k){var g,l,m,i,j,h;l=$(k).find("#add-note-page-number");g=$(k).find(".error-messages");if(l.length>0){h=_.pluck(courseload.data.manifest.pages,"label");i=_.first(h);j=_.last(h);m=l.val();if(_.contains(h,m)){g.empty();return true}else{if(!g.find(".error").length){g.show();g.find("ul").append("<li class='error'><label                         for='"+($(l).attr("id"))+"'>The page                         number '"+($(l).val())+"'                        does not exist in this resource. <br />Please enter a                         page number in the range of "+i+" -                        "+j+".</label></li>")}l.empty().addClass("error");l.on("focus",function(n){return $(this).removeClass("error")});return false}}else{return true}};courseload.markup.ui.menu=function(h){var j,g,i;h=h||{};i="without-note";if(h.markup&&h.markup.note_text){i="with-note"}j=$(h.template||"#noteMenuTemplate").tmpl({$data:h}).addClass(h.markup?"edit":"create").addClass(i).bind("click touchstart",function(k){if(!$(k.target).is(".note-text a")){k.preventDefault();k=courseload.touch.getEvent(k);return b.apply(this,[k,h])}});if(h.markup&&h.markup.color){g=h.markup.color}courseload.markup.ui.setSelectedColor(j,g);return j};courseload.markup.ui.setSelectedColor=function(h,g){if(g){courseload.data.markupColor=g}return h.find("li[data-color='"+courseload.data.markupColor+"']").addClass("selectedColor")};courseload.markup.ui.note=function(i){var g,j,h;i=i||{};g=$("#noteTemplate").tmpl().bind("click touchstart",function(k){k=courseload.touch.getEvent(k);return f.apply(this,[k,i])});g.data("is_question",g.find("#is_question").is(":checked"));h=i.markup||{};j=g.find(".note-tags input");if(!(h.tags||Modernizr.input.placeholder)){j.val(j.attr("placeholder"));j.bind("focus",function(l){var k;k=$(this);if(k.val()===k.attr("placeholder")){return k.val("")}});j.bind("blur",function(l){var k;k=$(this);if(k.val()===""){return k.val(k.attr("placeholder"))}})}if(h.tags){j.val(h.tags)}if(h.note_text){g.find("textarea").val(i.markup.note_text)}if(h.is_question){g.find("#is_question").prop("checked",true)}courseload.markup.ui.setSelectedColor(g);return g};$(document).on("submit","#add-page-note",function(k){var j,i,g,n,o,m,h,l;k.preventDefault();if(a($(this))){j=$(this).parents(".page");h=$(this).find("#add-note-page-number").val()||courseload.data.book.currentPage;if($(this).find("#add-note-page-number").val()){m=_.detect(courseload.data.manifest.pages,function(p){return p.label===h.toString()})}else{m=_.detect(courseload.data.manifest.pages,function(p){return p.pagenum===h})}l=m.pagenum;g=courseload.data.manifest;i=$(".color-block.selectedColor").data("color");n={created:new Date().toString(),type:"note",slug:g.slug,section:courseload.data.classmaterial.sectionUri,page:l,position:[[0,0]],color:i};o={pageIndex:l,save:function(p){if(p.hasOwnProperty("color")){n.color=n.color||p.color}if(p.hasOwnProperty("text")){n.note_text=p.text}if(p.hasOwnProperty("tags")){n.tags=p.tags}if(p.hasOwnProperty("selection_text")){n.selection_text=p.selection_text}if(p.hasOwnProperty("is_question")){n.is_question=p.is_question}return courseload.api.savemarkup(courseload.data.manifest,n)}};return f.apply(this,[k,o])}});courseload.markup.confirmDelete=function(i){var j,g,h;g=$("#container");j=$("#modaldelete");j.find("blockquote").text(i.note_text);j.find(".notePageNumber").text(i.page+1);$("#modaldelete .modaldelete").data("note",i);h={overlayColor:"#000",margin:30,padding:0,content:$("#modaldelete").html()};$.fancybox(h);return $(".modaldelete").on("click",".footer button, .footer a",function(m){var k,l;m.preventDefault();k=$(m.target);l=$(".modaldelete").data();if(k.attr("id")==="confirm_delete_note"){courseload.api.deletemarkup(courseload.data.manifest,l.note);return k.attr("disable","disable").addClass("disabled")}else{parent.$.fancybox.close();return delete l.note}})};$(document).on("markup_deleted",".note-edit-panel",function(m,h){var i,n,l,j,g,k;i=$("#container");n=courseload.data.book.markuplist;l=h.uri||h.offline.hsid;courseload.book.notes.updateCounts(l);courseload.book.page.resizeNotesView();parent.$.fancybox.close();g=courseload.book.page.getLabelByIndex(h.page);k={type:"success",title:"Note Deleted",message:"Your note has been removed from page "+g+"."};courseload.banner.alertsMessage(i,k);courseload.scrubber.paintMarkupDots(n);j={pageIndex:$(".page").hasClass("page-level-note")?h.page:false};courseload.book.page.notesview(j);return $(".note-edit-panel").unbind("markup_deleted")})}).call(this);(function(){var e,c,b,d,a;namespace("courseload.markup");e="red cyan green yellow";c=null;courseload.markup.gesturing=false;$(document).bind("gesturestart",function(f){return courseload.markup.gesturing=true});$(document).bind("gestureend",function(f){return courseload.markup.gesturing=false});b=function(f){var g;g=$('.dialog[data-markup-uri="'+f.uri+'"]');if(g.length){return $('.dialog[data-markup-uri="'+f.uri+'"]').remove()}};a=function(i,h,g){var f;f=h.find(".note-text");f.text(g.markup.note_text).linkify(function(j){return j.attr("target","_blank")});if(g.markup.is_question){f.prepend("<span class='new-notification "+g.markup.color+"'>NEW QUESTION</span>")}if(g.restricted){h.addClass("restricted")}if(g.markup.tags){h.addClass("with-tags").find(".note-tags span").text(g.markup.tags)}else{h.find(".note-tags").hide()}return courseload.markup.positionMenu(h,g.x,g.y,i)};d=function(f){var g;courseload.book.notes.allNotesCount();courseload.book.getNotesCount();if(courseload.data.classmaterial.is_checked_out){courseload.markup.getPageNotes(courseload.data.book.currentPage,g=false)}if(f==="save"){return $.when(courseload.api.getmarkuplist()).done(function(h){courseload.data.book.markuplist=h;return courseload.scrubber.paintMarkupDots(h)})}};$(".selectedword").live("click touchend",function(p){var t,j,f,n,h,m,i,g,k,o,s,r,q,l;if(courseload.offline.disableMarkups()){return}p=courseload.touch.getEvent(p);i=$(p.target);if(!(i.hasClass("selectedword")||i.is("button.annotation"))){return}h=$("#container");t=i.parents(".wordcontainer");n=t.parents(".page");m=n.data();j=n.find("img.content");s=t.data("selection");if(s.author!==courseload.data.user.uri){o=true}else{o=false}k=j.offset();l=[p.pageX-k.left,p.pageY-k.top],r=l[0],q=l[1];if(!t.children(".dialog").length){if(s.note_text){f=courseload.markup.ui.menu({markup:s,restricted:o,"delete":function(){var v,u,w;courseload.api.deletemarkup(courseload.data.manifest,s);t.remove();v=n.data().pageIndex;courseload.markup.getPageNotes(v);u=courseload.book.page.getLabelByIndex(v);w={type:"success",title:"Note Deleted",message:"Your note has been removed from Page "+u+"."};courseload.banner.alertsMessage(h,w);return d("delete")},save:function(u){if(u.color){t.removeClass(e).addClass(u.color);t.find("button.annotation").removeClass(e).addClass(u.color);s.color=u.color}if(u.hasOwnProperty("is_question")){s.is_question=u.is_question}if(u.hasOwnProperty("text")){s.note_text=u.text}if(u.hasOwnProperty("tags")){s.tags=u.tags}courseload.api.savemarkup(courseload.data.manifest,s);courseload.markup.getPageNotes(n.data().pageIndex);courseload.markup.addAnnotationIndictor(t,s);return d("save")}}).appendTo(t)}else{f=courseload.markup.ui.menu({markup:s,restricted:o,template:"#highlightMenuTemplate",save:function(u){t.removeClass("currentselect").removeClass(e);if(u.hasOwnProperty("color")){t.addClass(u.color);courseload.data.markupColor=s.color=u.color}if(u.hasOwnProperty("is_question")){s.is_question=u.is_question}if(u.hasOwnProperty("text")){s.note_text=u.text}if(u.hasOwnProperty("tags")){s.tags=u.tags}courseload.api.savemarkup(courseload.data.manifest,s);if(s.note_text){courseload.markup.getPageNotes(n.data().pageIndex);courseload.markup.addAnnotationIndictor(t,s)}return d("save")},"delete":function(){t.remove();courseload.api.deletemarkup(courseload.data.manifest,s);courseload.markup.getPageNotes(n.data().pageIndex);return d("delete")}}).appendTo(t)}g={markup:s,x:r,y:q,restricted:o};return a(t,f,g)}});$(".page").live("page_resized",function(y){var f,o,v,s,u,p,j,w,D,q,H,F,x,G,t,B,z,l,i,g,A,E,C,r,n,m,k,h;y=courseload.touch.getEvent(y);s=$(this);o=s.find("img.content");p=s.find(".selectedword");s.children(".currentselect").remove();for(l=0,A=p.length;l<A;l++){x=p[l];u=$(x);r=u.data("coordinates"),B=r[0],z=r[1],H=r[2],F=r[3];n=courseload.markup.scaleFromBase(o,[B,z]),B=n[0],z=n[1];m=courseload.markup.scaleFromBase(o,[H,F]),H=m[0],F=m[1];u.css({top:z,left:B}).height(F-z).width(H-B)}f=$("button.annotation");for(i=0,E=f.length;i<E;i++){q=f[i];v=$(q);D=v.parents(".wordcontainer");G=D.data("selection");v.remove();D.find(".instructor-icon").remove();courseload.markup.addAnnotationIndictor(D,G)}w=$(".sticky-note");for(g=0,C=w.length;g<C;g++){t=w[g];j=$(t);k=j.data("coordinates"),B=k[0],z=k[1];h=courseload.markup.scaleFromBase(o,[B,z]),B=h[0],z=h[1];j.css({top:z,left:B})}return courseload.markup.updateNotesScrollbar(s)});$(".sticky-note").live("mousedown touchstart",function(h){var g,f;if(courseload.markup.gesturing||courseload.offline.disableMarkups()){return}h=courseload.touch.getEvent(h);g=$(this);f=g.data("note");return b(f)});$(".sticky-note").live("click touchend",function(q){var l,f,o,j,i,k,h,s,g,r,m,p,t,n;if(courseload.markup.gesturing||courseload.offline.disableMarkups()){return}q=courseload.touch.getEvent(q);j=$(this);h=courseload.data.manifest;o=j.parents(".page");l=o.find("img.content");r=j.data("note");i=o.find(".viewport");m=i.offset();n=[q.pageX-m.left,q.pageY-m.top],k=n[0],t=n[1];if(r.author!==courseload.data.user.uri){p=true}else{p=false}s=[];_.each($(".highlight.dialog"),function(u){return s.push($(u).data("markupUri"))});if(!_.contains(s,r.uri)){f=courseload.markup.ui.menu({template:"#noteMenuTemplate",restricted:p,markup:r,save:function(u){if(u.hasOwnProperty("color")){j.removeClass(e).addClass(u.color);r.color=u.color}if(u.hasOwnProperty("text")){r.note_text=u.text}if(u.hasOwnProperty("is_question")){r.is_question=u.is_question}if(u.hasOwnProperty("tags")){r.tags=u.tags}courseload.api.savemarkup(courseload.data.manifest,r);j.attr("title",r.note_text);courseload.markup.getPageNotes(o.data().pageIndex);return d("save")},"delete":function(){courseload.api.deletemarkup(courseload.data.manifest,r);j.remove();courseload.markup.getPageNotes(o.data().pageIndex);return d("delete")}}).appendTo(i.find(".overview"));$(f).attr("data-markup-uri",r.uri);g={markup:r,x:k,y:t,restricted:p};return a(j,f,g)}});courseload.markup.allowAnnotation=function(){if(courseload.data.book.notesetting===3||courseload.data.book.notesetting===0){return true}else{return false}};$(".page img.content").live("mousedown touchstart",function(g){var f,h;if(!courseload.markup.allowAnnotation()||courseload.offline.disableMarkups()){return}g=courseload.touch.getEvent(g);f=$(g.target);h=f.offset();return c={from:[g.pageX-h.left,g.pageY-h.top],$page:f.parents(".page"),$image:f}});courseload.markup.saveNote=function(h,f){var g;g=h.data("selection");g.note_text=f.find("textarea").val();courseload.api.savemarkup(courseload.data.manifest,g);h.removeClass("currentselect");$(".highlight").remove();return $(".add-note").remove()};courseload.markup.cancel=function(){return $(".currentselect").remove()};courseload.markup.clearDialogs=function(){var f;f=$(".dialog");if(f.length){return f.remove()}};$(document).bind("mouseup touchend",function(m){var p,h,f,l,k,g,i,o,n,j;if(!c||courseload.markup.gesturing||courseload.offline.disableMarkups()){return}m=courseload.touch.getEvent(m);k=$("#selectbox");l=c.$page;h=c.$image;p=$(".wordcontainer.currentselect");if(k.length!==0){p=$(".wordcontainer.currentselect");if(p.length!==0){o=courseload.markup.createSelection(k,l,h);$("#clipboard").text(o.selection_text);courseload.markup.copyText();o.color=courseload.data.markupColor;courseload.api.savemarkup(courseload.data.manifest,o);f=courseload.markup.ui.menu({template:"#highlightMenuTemplate",markup:o,cancel:function(){p.find(".highlight.dialog").remove();return p.removeClass("currentselect")},save:function(q){p.removeClass("currentselect").removeClass(e);if(q.hasOwnProperty("color")){p.addClass(q.color);courseload.data.markupColor=o.color=q.color}if(q.hasOwnProperty("is_question")){o.is_question=q.is_question}if(q.hasOwnProperty("text")){o.note_text=q.text}if(q.hasOwnProperty("tags")){o.tags=q.tags}courseload.api.savemarkup(courseload.data.manifest,o);if(o.note_text){courseload.markup.getPageNotes(l.data().pageIndex);courseload.markup.addAnnotationIndictor(p,o)}return d("save")},"delete":function(){p.remove();courseload.api.deletemarkup(courseload.data.manifest,o);return d("delete")}}).appendTo(p);i=h.offset();j=[m.pageX-i.left,m.pageY-i.top],g=j[0],n=j[1];courseload.markup.positionMenu(f,g,n,p)}k.remove()}return c=null});courseload.markup.positionMenu=function(E,l,t,u){var y,q,A,k,x,v,m,j,o,z,s,h,w,i,D,n,r,C,B,f,p,g;q=$(".page");w=q.outerWidth();s=q.position().left;h=q.position().top;m=E.outerHeight();j=E.outerWidth();z=390;o=221;y=E.find(".arrow");v=Math.abs(parseInt(y.css("bottom")));k=(j/2)-(v/2);x=v;if(u){i=u.outerHeight();r=u.outerWidth();if(u.hasClass("sticky-note")||u.data("markup-uri")){D=u.position().left;n=u.position().top;if(u.hasClass("sticky-note")){if(D<(z/2)){l=D-r;k=r/2;E.addClass("left")}else{if(D>(w-(j/2))){l=D-(z-r)+(x/2);k=(z-r)-x;E.addClass("right")}else{l=D-(j/2);E.addClass("center")}}if(n<o){t=n+u.outerHeight()+v;E.addClass("top")}else{t=n-m-v}}else{if(u.hasClass("right")){C=w-(l+r)}else{if(u.hasClass("center")){l=l+(j/4)}else{l=l;k=x-(x/2)}}if(u.hasClass("top")){t=n;E.addClass("top")}else{t=n-(m-i)}}}else{if(u.hasClass("edit")){A=u.closest(".wordcontainer").find(".selectedword:first")}else{A=u.find(".selectedword:first")}g=A.width();B=A.height();p=A.position().top;f=A.position().left;t=(p-m)-v;if(u.is(".edit.with-note")||u.is(".edit.without-note")){if((w-(g+f))<(z/2)&&g>j){l=((g/2)-(j/2))+f;E.addClass("center")}else{if((w-(g+f))<(z/2)&&g<j){C=u.css("right");E.addClass("right")}else{if(Math.floor(A.position().left)===Math.floor(u.position().left)){l=u.position().left;k=x;E.addClass("left")}else{l=l+((r-j)/2)}}}}else{if(u.hasClass("wordcontainer")){if((w-(g+f))<(z/2)&&g>j){l=((g/2)-(j/2))+f;E.addClass("left")}else{if((w-(g+f))<(z/2)){C=w-(g+f);E.addClass("right")}else{if(f>(z/2)){l=((g/2)-(j/2))+f;E.addClass("center")}else{l=f;k=x}}}}}if(p<o){E.addClass("top");t=p+B+v}}if(C){E.css({top:t,right:C});return y.css({right:x-13})}else{y.css({left:k});return E.css({top:t,left:l})}}};$(document).bind("mousemove touchmove",function(t){var h,q,m,l,j,k,A,v,D,B,s,r,i,w,u,C,z,p,o,n,g,f;if(!c||courseload.markup.gesturing||courseload.offline.disableMarkups()){return}t=courseload.touch.getEvent(t);q=c.$page;h=c.$image;i=h.offset();n=[t.pageX-i.left,t.pageY-i.top],p=n[0],o=n[1];if(Math.abs(p-c.from[0])<5&&Math.abs(o-c.from[1])<5){return}g=[i.top,i.left+h.width(),i.top+h.height(),i.left],k=g[0],j=g[1],m=g[2],l=g[3];if(t.pageX<l||t.pageX>j||t.pageY<k||t.pageY>m){return}f=c.from,s=f[0],r=f[1];w=A=Math.min(s,p);u=z=Math.min(r,o);D=C=Math.max(s,p);B=v=Math.max(r,o);return courseload.markup.select([w,u],[D,B],q,h)});courseload.markup.select=function(i,h,j,m){var l,k,g,f;g=i[0],f=i[1];l=h[0],k=h[1];courseload.markup.drawSelectBox([g,f],[l,k],j,m);return courseload.markup.selectWords([g,f],[l,k],j,m)};courseload.markup.drawSelectBox=function(g,j,m,i){var f,l,p,n,q,o,r,k;q=g[0],o=g[1];p=j[0],n=j[1];k=[p-q,n-o],r=k[0],l=k[1];if($("#selectbox").length===0){f=m.find(".page-scroll .overview");$('<div id="selectbox">').css({top:c.from[1],left:c.from[0]}).appendTo(f)}return $("#selectbox").css({top:o,left:q}).height(l).width(r)};courseload.markup.scaleToBase=function(h,g){var i,f,j;f=g[0],j=g[1];i=h.data("scale");return[f/i,j/i]};courseload.markup.scaleFromBase=function(h,g){var i,f,j;f=g[0],j=g[1];i=h.data("scale");return[f*i,j*i]};courseload.markup.selectWords=function(G,H,q,M){var l,J,P,ag,r,aa,Y,T,S,i,g,O,N,L,K,E,D,z,x,ae,ac,V,U,ai,af,Q,k,j,h,f,I,ak,ad,ab,Z,X,F,t,p,n,m,W,R,C,an,am,al,aj,ah,B,A,y,w,v,u,s,o;ai=G[0],af=G[1];i=H[0],g=H[1];q.find(".currentselect").remove();J=q.find(".page-scroll .overview");l=$('<div class="wordcontainer currentselect">').appendTo(J);I=q.data("words");R=courseload.markup.scaleToBase(M,[ai,af]),z=R[0],x=R[1];C=courseload.markup.scaleToBase(M,[i,g]),E=C[0],D=C[1];ak=[];for(ad=0,F=I.length;ad<F;ad++){r=I[ad];B=r[0],T=B[0],S=B[1],aa=B[2],Y=B[3];if(Y>=x&&aa>=z&&T<=E&&S<=D){ag=S<=x&&Y>=x;P=S<=D&&Y>=D;if(ag||P){A=[S,Y],U=A[0],ac=A[1];if(ag&&P){y=r.slice(1,r.length);for(ab=0,t=y.length;ab<t;ab++){w=y[ab],Q=w[0],h=w[1],f=w[2],k=w[3],j=w[4];if(k>=z&&h<=E){V=V||h;ae=k;ak.push(Q)}}}else{if(ag){ae=aa;v=r.slice(1,r.length);for(Z=0,p=v.length;Z<p;Z++){u=v[Z],Q=u[0],h=u[1],f=u[2],k=u[3],j=u[4];if(k>=z){V=V||h;ak.push(Q)}}}else{if(P){V=T;s=r.slice(1,r.length);for(X=0,n=s.length;X<n;X++){o=s[X],Q=o[0],h=o[1],f=o[2],k=o[3],j=o[4];if(h<=E){ae=k;ak.push(Q)}}}}}an=courseload.markup.scaleFromBase(M,[V,U]),L=an[0],K=an[1];am=courseload.markup.scaleFromBase(M,[ae,ac]),O=am[0],N=am[1];$('<div class="selectedword">').css({position:"absolute",top:K,left:L}).height(N-K).width(O-L).data("coordinates",[V,U,ae,ac]).appendTo(l)}else{al=r.slice(1,r.length);for(W=0,m=al.length;W<m;W++){Q=al[W];ak.push(Q[0])}aj=courseload.markup.scaleFromBase(M,[T,S]),L=aj[0],K=aj[1];ah=courseload.markup.scaleFromBase(M,[aa,Y]),O=ah[0],N=ah[1];$('<div class="selectedword">').css({position:"absolute",top:K,left:L}).height(N-K).width(O-L).data("coordinates",r[0]).appendTo(l)}}}l.data("text",ak.join(" "));if(l.children().length===0){l.remove()}l.removeClass(e).addClass(courseload.data.markupColor);return l};courseload.markup.createSelection=function(j,k,g){var r,m,o,l,f,q,p,n,i,h;r=$(".wordcontainer.currentselect");f=courseload.data.manifest;m=j.position();i=courseload.markup.scaleToBase(g,[m.left,m.top]),p=i[0],n=i[1];h=courseload.markup.scaleToBase(g,[m.left+j.width(),m.top+j.height()]),o=h[0],l=h[1];q={created:new Date().toString(),type:"selection",selection_text:r.data("text"),slug:f.slug,section:courseload.data.classmaterial.sectionUri,page:k.data("pageIndex"),position:[[p,n],[o,l]]};r.data({selection:q});return q};courseload.markup.updateNotesScrollbar=function(g){var f;f=g.find(".sidebar .scroll.tinyscrollbar");if(f.length){return f.tinyscrollbar_update()}};courseload.markup.filterNotesOnly=function(h,f){var g;if(f==null){f={}}return g=_.filter(h,function(i){if(i.note_text&&f.showresponses){return i.note_text!==""}else{if(i.note_text){if(i.in_response_to){return i.note_text!==""&&i.in_response_to===null}else{return i.note_text!==""}}}})};courseload.markup.getPageNotes=function(f,i){var h,g;if(i==null){i=true}g={};g.me=1;g.instructor=1;h="all";if(h){g.classmates=h}if(courseload.data.book.currentPage){g.page=courseload.data.book.currentPage}return $.when(courseload.api.getnotes(courseload.data.classmaterial,g)).done(function(l){var j,k;if(i){courseload.scrubber.paintMarkupDots(courseload.data.book.markuplist)}k=_.filter(l,function(m){return m.page===f});j=courseload.markup.filterNotesOnly(k);return courseload.markup.pageNotesCount(j)})};courseload.markup.pageNotesCount=function(k){var h,j,m,i,g,f,l;h=$(".page");l=h.data();g=_.pluck(courseload.data.book.instructors,"user");m=[];_.each(k,function(n){if($.inArray(n.author,g)!==-1){return m.push(n)}});i=m.length;l.notescount=f=k.length;j=f+" "+courseload.pluralize(f,"Note","Notes")+'<span class="auraltext"> on this page</span>';if(i){j+='<span class="instructor-notes-count">('+i+" Instructor "+courseload.pluralize(i,"Note","Notes")+")</span>"}$(".page-level-notes").html(j);return h.trigger("notesCountLoaded")};courseload.markup.loadNotes=function(i,h){var m,l,j,k,g,f;f=[];for(k=0,g=i.length;k<g;k++){j=i[k];l=_.flatten(j.position);if(l.length&&!_.isEqual(l,[0,0])){f.push(m=courseload.markup.addStickyNote(h,j))}else{f.push(void 0)}}return f};courseload.markup.loadSelections=function(f,l){var s,g,o,m,r,p,n,j,q,k,i,h;g=l.find("img.content");h=[];for(j=0,q=f.length;j<q;j++){r=f[j];k=courseload.markup.scaleFromBase(g,r.position[0]),p=k[0],n=k[1];i=courseload.markup.scaleFromBase(g,r.position[1]),o=i[0],m=i[1];s=courseload.markup.selectWords([p,n],[o,m],l,g);s.data({selection:r,text:r.selection_text}).removeClass("currentselect");if(r.color){s.removeClass(e).addClass(r.color)}if(r.note_text){h.push(courseload.markup.addAnnotationIndictor(s,r))}else{h.push(void 0)}}return h};courseload.markup.addAnnotationIndictor=function(f,l){var n,i,g,m,k,j,h;n=f.find("div.selectedword:first");h=[n.width(),0],k=h[0],j=h[1];g=_.pluck(courseload.data.book.instructors,"user");if($.inArray(l.author,g)!==-1){m=true}else{m=false}return i=$("#annotationIndicatorTemplate").tmpl({isInstructorNote:m}).appendTo(n).css({top:j-4,left:k-4}).addClass(l.color?l.color:"yellow")};courseload.markup.addStickyNote=function(i,k){var j,g,m,h,f,l;j=i.find("img.content");g=i.find(".page-scroll .overview");l=courseload.markup.scaleFromBase(j,k.position[0]),h=l[0],f=l[1];m=$("#stickyNoteTemplate").tmpl();m.appendTo(g).css({left:h,top:f}).data("note",k).data("coordinates",k.position[0]).attr("title",k.note_text).attr("data-markup-uri",k.uri);if(k.color){m.addClass(k.color)}m.draggable({containment:"parent",cancel:null,disabled:courseload.offline.materialIsDownloading(),stop:function(r,q){var p,o,n;n=[q.position.left,q.position.top],p=n[0],o=n[1];k.position=[courseload.markup.scaleToBase(j,[p,o])];return courseload.api.savemarkup(courseload.data.manifest,k)}});return m};courseload.markup.copyText=function(){var g,f,h;g=$("#clipboard");if(g.text()===""){return}if(window.getSelection&&document.createRange){h=window.getSelection();f=document.createRange();f.selectNodeContents(g[0]);h.removeAllRanges();return h.addRange(f)}else{if(document.body.createTextRange){f=document.body.createTextRange();f.moveToElementText(g[0]);return f.select()}}};$(document).on("dataloaded",".page",function(q){var n,m,k,u,p,t,o,g,s,j,i,r,f,l,h;q=courseload.touch.getEvent(q);n=$(this);m=n.data();o={};l=m.markup;for(j=0,r=l.length;j<r;j++){u=l[j];if(u.type==="response"){o[u.in_response_to]=u}}h=m.markup;for(i=0,f=h.length;i<f;i++){u=h[i];if(o.hasOwnProperty(u.uri)){u.response=o[u.uri]}}k=_.pluck(courseload.data.book.instructors,"user");if(courseload.data.classmaterial.is_checked_out){g=(function(){var x,v,y,w;y=m.markup;w=[];for(x=0,v=y.length;x<v;x++){s=y[x];if(s.offline&&s.offline.verb!=="DELETE"&&s.type==="selection"){w.push(s)}}return w})()}else{g=(function(){var x,v,y,w;y=m.markup;w=[];for(x=0,v=y.length;x<v;x++){s=y[x];if(s.type==="selection"){w.push(s)}}return w})()}courseload.markup.loadSelections(g,n);p=(function(){var x,v,y,w;y=m.markup;w=[];for(x=0,v=y.length;x<v;x++){s=y[x];if(s.type==="note"){w.push(s)}}return w})();courseload.markup.loadNotes(p,n);if(courseload.data.section){courseload.api.getroster(courseload.data.section).done(function(D){var C,B,z,x,w,v,y,A;B={};for(z=0,w=D.length;z<w;z++){C=D[z];B[C.user]=C}y=m.markup;A=[];for(x=0,v=y.length;x<v;x++){u=y[x];A.push(u.author_name=B[u.author].name)}return A})}return courseload.markup.getPageNotes(m.pageIndex,t=false)})}).call(this);(function(){var c,b,a;namespace("hotkeys");hotkeys.Backspace=8;hotkeys.Shift=16;hotkeys.Enter=13;hotkeys.Escape=27;hotkeys.PageUp=33;hotkeys.PageDown=34;hotkeys.End=35;hotkeys.Home=36;hotkeys.LeftArrow=37;hotkeys.UpArrow=38;hotkeys.RightArrow=39;hotkeys.DownArrow=40;hotkeys.Delete=46;hotkeys.Comma=188;hotkeys.Dash=189;hotkeys.C=67;hotkeys.Z=90;hotkeys.FriendKeys=[38,38,40,40,37,39,37,39,66,65];hotkeys.MongoKeys=[77,79,78,71,79];hotkeys.FriendIndex=0;hotkeys.MongoIndex=0;$(document).keydown(function(d){if(courseload.data.book){switch(d.which){case hotkeys.PageDown:case hotkeys.RightArrow:return c(d,"+1");case hotkeys.PageUp:case hotkeys.LeftArrow:return c(d,"-1");case hotkeys.UpArrow:return b(d,true);case hotkeys.DownArrow:return b(d,false)}}else{if(courseload.data&&courseload.data.user){if(d.keyCode===hotkeys.FriendKeys[hotkeys.FriendIndex++]){if(hotkeys.FriendIndex===hotkeys.FriendKeys.length){hotkeys.FriendIndex=0;return a("/media/images/friend.jpg")}}else{if(d.keyCode===hotkeys.MongoKeys[hotkeys.MongoIndex++]){if(hotkeys.MongoIndex===hotkeys.MongoKeys.length){hotkeys.MongoIndex=0;return a("/media/images/mongo.gif")}}else{hotkeys.FriendIndex=0;return hotkeys.MongoIndex=0}}}else{hotkeys.FriendIndex=0;return hotkeys.MongoIndex=0}}});b=function(l,h){var d,k,j,i,m,g,f;if(!$(l.target).is(":input")&&!$("#fancybox-content").is(":visible")&&!$(".page.edit-note").is(":visible")){l.stopPropagation();j=40;k=$("#main > .page > .page-scroll");d=k.find("img.content");if(k.height()>=d.height()){return}i=-1*k.find(".overview").position().top;g=d.height()-k.height();f=0;if(h){m=Math.max(f,i-j)}else{m=Math.min(g,i+j)}return k.tinyscrollbar_update(m)}};c=function(f,d){if(!$(f.target).is(":input")&&!$("#fancybox-content").is(":visible")&&!$(".page.edit-note").is(":visible")){f.stopPropagation();return courseload.book.page.gotoPage(d)}};hotkeys.unleash=function(){return a("/media/images/mongo.gif")};a=function(o){var e,h,k,g,m,j,i,l,n,d,f;g=$(window);h=$("#main");k=h.find(".nav");i=20;l=20;j=$("div.menu:visible").outerHeight(true);n=k.width();f=g.width();d=g.height();m=function(p){var r,q;$(this).unbind(p);r=$(".friendcontainer");q=$(".friend");r.css("left",n).css("position","relative");q.hide().css("position","absolute").css("top",(d/2)-(q.outerHeight(true)/2)-j-i).css("left",(f-n)/2-(q.outerWidth(true)/2)).css("z-index",1).show();return _.delay(function(){return r.remove()},5000)};$('<div class="friendcontainer"><div class="friend"></div></div>').appendTo("#container");e=$("<img/>");return e.attr("src",o).bind("load",m).appendTo(".friend")}}).call(this);(function(){namespace("courseload.touch");courseload.touch.getEvent=function(a){if(a.originalEvent&&(a.originalEvent.touches||a.originalEvent.changedTouches)){if(a.originalEvent.changedTouches.length){return a.originalEvent.changedTouches[0]}else{if(a.originalEvent.touches.length){return a.originalEvent.touches[0]}}}else{return a}};$(function(){return $("body").bind("touchmove",function(c){var a,b;b=c.originalEvent.touches.length;a=$(c.target);if(b===2&&a.closest(".page.edit-note").length){}else{return c.preventDefault()}})})}).call(this);(function(){namespace("courseload.scrubber");courseload.scrubber.init=function(){var a;a=$("#scrubber");$(".scrubber").hide();a.css("cursor","default").css("z-index",100).css("opacity",0.85).text(courseload.data.manifest.pages[0].label);if(courseload.data.manifest.TOC&&courseload.data.manifest.TOC.length>0){$(".scrubber-head .chapter").text("").show();$(".scrubber-head .scrubber-title").text("").show()}else{$(".scrubber-head .chapter").text("").hide();$(".scrubber-head .scrubber-title").text("").hide()}return a.draggable({containment:"parent",axis:"x",drag:function(d,c){var b;b=courseload.scrubber.updateScrubber(c.position.left);return courseload.scrubber.loadThumbs(b)}})};$("#main").live("resized",function(){var a;a=$("#track").outerWidth(true);return $("#track div.scrubbable").each(function(b){return $(this).width(a)})});$(".page").live("page_resized",function(){var a;a=$("#track").outerWidth(true);return $("#track div.scrubbable").each(function(b){return $(this).width(a)})});courseload.scrubber.paintMarkupDots=function(a){var h,b,i,c,f,j,e,g,d;b=$("#track");j=b.outerWidth(true);c=(j-$("#scrubber").outerWidth(true))/(courseload.data.manifest.pages.length-1);$("#track span").remove();d=[];for(e=0,g=a.length;e<g;e++){i=a[e];f=(c*i.page/j)*100;h=$("<div class='scrubbable'>").width(j);if(i.uri){if(!i.id){i.id=i.uri.match(/\/([\d]+)\/$/)[1]}}else{i.id=""}$("<span id='scrubberMarkup"+i.id+"' class='annotation "+i.color+"' style='left:"+f+"%'>").data("page",i.page).appendTo(h);d.push(b.append(h))}return d};courseload.scrubber.refresh=function(){var d,e,c,a,b;if($("#scrubber")&&courseload.data.manifest&&courseload.data.manifest.pages){$(".scrubber").hide();b=($("#track").outerWidth(true)-$("#scrubber").outerWidth(true))/(courseload.data.manifest.pages.length-1);d=$(".page");e=d.length?d.data("pageIndex"):0;if(courseload.data.manifest.pages[e]){c=courseload.data.manifest.pages[e].label;a=b*e;return $("#scrubber").text(c).css("left",a)}}};$("#track").live("click",function(f){var a,c,b,j,g,i,h,d,k;c=$(f.target);if(c.is("span.annotation")&&c.data("page")){g=c.data("page");courseload.book.page.gotoPage(g);return courseload.scrubber.refresh()}else{b=$(this);k=b.outerWidth(true);$(".scrubber").hide();a=$("#scrubber");d=a.outerWidth(true);i=f.pageX-b.position().left-(d/2);if((i+d)>k){i=k-d}j=i>0?i:0;a.css("left",j);h=courseload.scrubber.updateScrubber(j);return courseload.book.page.gotoPage(h)}});courseload.scrubber.updateScrubber=function(a){var e,f,d,c,b;e=$(".page");f=$("#scrubber");c=($("#track").outerWidth(true)-f.outerWidth(true))/(courseload.data.manifest.pages.length-1);b=Math.floor(a/c);if(courseload.data.manifest.pages[b]){d=courseload.data.manifest.pages[b].label;f.text(d)}return b};courseload.scrubber.loadThumbs=function(c){var g,d,f,b,e,a;courseload.scrubber.renderThumbs(c);e=courseload.data.book.markuplist;a=[];for(f=0,b=e.length;f<b;f++){d=e[f];g=$("#thumb"+d.page+" .page-notes");if($(".annotation."+d.color,g).length===0){a.push(g.append("<span class='annotation "+d.color+"'>"))}else{a.push(void 0)}}return a};courseload.scrubber.renderThumbs=function(g){var t,i,d,n,a,h,r,l,f,m,k,p,o,q,s,e,b,j,c;d=$("ul.scrubber-page-list");d.empty();m=courseload.data.manifest.pages.length-1;k=230;s=$(window).width();j=courseload.scrubber.calcThumbRange(m,k,s,g),r=j[0],q=j[1],p=j[2],o=j[3];if(g<o&&p>1){l=o-g-1;for(a=e=0;0<=l?e<=l:e>=l;a=0<=l?++e:--e){d.append("<li><a>")}}$(".scrubber").addClass("show").show();i=$("#scrubberImageTemplate");t=$(".scrubber-head .chapter");n=$(".scrubber-head .scrubber-title");c=[];for(h=b=r;r<=q?b<=q:b>=q;h=r<=q?++b:--b){f=courseload.data.manifest.pages[h];if(f.chapter&&f.chapter!==""){t.text(f.chapter);n.text(courseload.data.manifest.TOC[parseInt(f.chapter,10)].name)}f.image_url=""+courseload.data.manifest.image_base+"thumbs/"+f.image;c.push(i.tmpl(f).appendTo(d))}return c};courseload.scrubber.calcThumbRange=function(c,h,e,a){var b,d,g,f;d=1;g=0;if(e>h){d=Math.floor(e/h);if(d>1){g=Math.floor(d/2);b=a-g;f=a+g;if(b<0){b=0}if(f>c){f=c}}else{b=f=a}}else{b=f=a}return[b,f,d,g]};$("ul.scrubber-page-list li a").live("click",function(a){a.preventDefault();courseload.book.page.gotoPage($(this).data("page"));courseload.scrubber.refresh();return $(".scrubber").hide()});$("#main, .scrubber-head a.scrubber-close").live("click",function(a){return courseload.scrubber.refresh()});$(document).live("markup_created","#track",function(f,i){var h,g,d,c,a,b;if(i.type==="selection"||i.type==="note"){g=$("#track");b=g.outerWidth(true);c=(b-$("#scrubber").outerWidth(true))/(courseload.data.manifest.pages.length-1);d=i.color?i.color:"yellow";a=(c*i.page)*100/b;h=$("<div class='scrubbable'>").width(b);$("<span class='annotation "+d+"' style='left:"+a+"%'>").data("page",i.page).appendTo(h);g.append(h);return courseload.data.book.markuplist.push({page:i.page,color:i.color})}});$(document).on("markup_deleted","#track",function(h,a){var d,g,c,f,b;$("#track").unbind("markup_deleted");if(a.type==="selection"||a.type==="note"){$("#track span.annotation").each(function(j){var e;e=$(this);if(e.data("page")===a.page&&e.hasClass(a.color)){e.remove();return false}});f=courseload.data.book.markuplist;b=[];for(g=0,c=f.length;g<c;g++){d=f[g];if(d.page===a.page&&d.color===a.color){courseload.data.book.markuplist.splice(g,1);break}else{b.push(void 0)}}return b}});$(document).keydown(function(g){var a,f,h,d,b,c;a=$(g.target);if(a.hasClass("goto-field")&&a.val()!==""){switch(g.which){case hotkeys.Enter:a.blur();h=a.val().toLowerCase();c=courseload.data.manifest.pages;for(d=0,b=c.length;d<b;d++){f=c[d];if(f.label&&f.label.toLowerCase()===h){courseload.book.page.gotoPage(f.pagenum);courseload.scrubber.refresh();$(".scrubber").hide();return}}return alert("Unable to find the page specified")}}})}).call(this);(function(){var c,a,b=[].indexOf||function(f){for(var e=0,d=this.length;e<d;e++){if(e in this&&this[e]===f){return e}}return -1};namespace("courseload.book.logging");c=function(g,f,e){var h,d;if(g!==courseload.data.classmaterial){return}h=(function(){var l,j,k,i;k=$(".page");i=[];for(l=0,j=k.length;l<j;l++){d=k[l];if($(d).data().pageIndex!=null){i.push($(d).data().pageIndex)}}return i})();if(b.call(h,f)<0){return}if(g.hasOwnProperty("last_page_read")){g.last_page_read=f}else{if(courseload.data.membership){courseload.data.membership.last_pages[g.uri]=f}}return courseload.api.logPageRead(g,f)};a=[];courseload.book.logging.startPageReadLogging=function(){var h,i,e,d,l,k,g,j,f;courseload.book.logging.stopPageReadLogging();d=(function(){var p,n,o,m;o=$(".page");m=[];for(p=0,n=o.length;p<n;p++){k=o[p];if($(k).data().pageIndex!=null){m.push($(k))}}return m})();f=[];for(g=0,j=d.length;g<j;g++){h=d[g];i=courseload.data.classmaterial;e=h.data().pageIndex;l=_.delay(c,10000,i,e);f.push(a.push(l))}return f};courseload.book.logging.stopPageReadLogging=function(){var d,f,e;for(f=0,e=a.length;f<e;f++){d=a[f];clearTimeout(d)}return a=[]}}).call(this);(function(){var h,g,e,k,j,d,l,n,b,q,r,o,p,a,c,m,i,f;namespace("courseload.book.page");h=72;e={FIT_PAGE:"fit-page",FIT_WIDTH:"fit-width"};g="index/";k=0.98;courseload.book.page.gotoPage=function(s){var u,t;t=courseload.data.manifest;u=courseload.data.book.currentPage||0;s=s!=null?s:u;s=r(s);if(s<0||s>t.pages.length-1){return}return courseload.nav.updatehash([""+courseload.data.classmaterial.short_id,""+g+s])};i=function(){var v,w,t,u,s;w=$("button.bookmark").outerWidth(true)+5;u=$("div.scrollbar").outerWidth(true);t=$(".page-scroll").outerWidth(true);v=t-(w+u);s=v*k;return s};f=function(){var s,t;s=$("div.toolbar");if(s.hasClass("open")){return s.width(25).removeClass("open").addClass("closed")}else{t=i();return s.width(t).removeClass("closed").addClass("open")}};courseload.book.page.loadPage=function(t){var u,s,v;t=parseInt(t,10);courseload.book.logging.stopPageReadLogging();s=$(".page").data();v=s&&s.zoom&&s.zoom.currentZoomLevel;u=o(t);d(u,v);q(u);courseload.scrubber.refresh();$(".scrubber").hide();courseload.data.book.currentPage=t;if(courseload.data.classmaterial&&courseload.data.classmaterial.task&&courseload.data.classmaterial.task.end_index===t){_.delay(f,1500)}courseload.book.logging.startPageReadLogging()};courseload.book.page.zoomPage=function(s,t){d(s,t);return s.trigger("page_resized")};courseload.book.page.clearCurrentZoomLevel=function(s){var t;s=s||$(".page");t=s.data();if(t.zoom!=null){return delete t.zoom.currentZoomLevel}};courseload.book.page.getIndexByLabel=function(t){var u,s;if(courseload.data.manifest){t=t.toLowerCase();u=_.detect(courseload.data.manifest.pages,function(v){return v.label.toLowerCase()===t});if(u&&(u.pagenum!=null)){s=u.pagenum}}return s};courseload.book.page.getLabelByIndex=function(t){var u,s;if(courseload.data.manifest){u=_.detect(courseload.data.manifest.pages,function(v){return v.pagenum===t});if(u&&(u.pagenum!=null)){s=u.label}}return s};d=function(E,I){var B,F,J,t,s,G,D,K,v,x,w,y,H,z,A,C,u;if(E.hasClass("edit-note")){return}c(E);m();v=courseload.data.manifest;H=E.data("pageIndex");w=v.pages[H];C=n(E),s=C[0],t=C[1];J=b(s,t,w,v.sizes);G=b(s,t,w,v.sizes);y=E.data();if(I==null){I=y&&y.zoom&&y.zoom.currentZoomLevel}if(I==null){I=_.last(G)}if(!_.contains(G,I)){I=_.last(G)}A={allZoomLevels:J,availableZoomLevels:G,currentZoomLevel:I};u=l(s,t,w,v.sizes,I),D=u[0],z=u[1];K=""+v.image_base+D+"/"+w.image;E.find("img.content").remove();E.width(z).height(t).data("zoom",A);if(!courseload.data.classmaterial.section){E.addClass("additionalresources")}F=E.find(".page-scroll .overview");B=$('<img class="content" src="'+K+'" alt="" width='+z+' aria-hidden="true" />').data("scale",z/w.width).prependTo(F).bind("load",function(){return a(E)});E.find(".page-scroll").width(z).height(t).find(".viewport").height(t);a(E);x=t-E.find(".sidebar .header").outerHeight(true);E.find(".sidebar .viewport.notescroll").height(x);return courseload.book.updateZoomButtons(E)};b=function(B,s,w,D){var A,v,t,y,C,z,u,x;z=w.width/h;y=w.height/h;t=[e.FIT_PAGE];for(u=0,x=D.length;u<x;u++){C=D[u];A=y*C;v=z*C;if(v<B&&A<s){}else{if(v<B){t.push(C)}else{if(v>=B){t.push(e.FIT_WIDTH);break}}}}return t};l=function(F,u,y,H,s){var E,x,B,A,D,G,C,w,v,z,t;C=y.width/h;B=y.height/h;switch(s){case e.FIT_PAGE:for(w=0,z=H.length;w<z;w++){G=H[w];E=B*G;x=C*G;if(E>=u||x>=F){break}}D=E/u;A=x/D;A=Math.floor(A);return[G,Math.min(A,F)];case e.FIT_WIDTH:for(v=0,t=H.length;v<t;v++){G=H[v];x=C*G;if(x>=F){return[G,F]}}break;default:G=s;x=C*G;E=B*G;return[G,x]}};j=function(w,y,v){var z,t,u,x,s;t=y.width/h;for(x=0,s=v.length;x<s;x++){u=v[x];z=t*u;if(z>=w){break}}return[u,z]};n=function(z){var w,A,u,v,F,C,y,x,B,E,D,s,t;u=$(window);w=$("#main");A=w.find(".nav");x=20;B=20;y=$("div.menu:visible").outerHeight(true);C=$(".footer.tracker").outerHeight(true);D=A.width();t=u.width();s=u.height();E=t-D-B;F=Math.floor(E);v=Math.floor(s-x-C-y);return[F,v]};courseload.book.page.resizePageImages=function(){var s,w,u,t,v;s=$(".page");if(s.hasClass("edit-note")){v=n(s),u=v[0],w=v[1];s.width(u).height(w)}else{d(s)}t=i();$("div.toolbar.open").width(t);return s.trigger("page_resized")};o=function(t){var v,u,s;$("#main > div.page, #main > div.externallinkcontainer").remove();s=false;if(courseload.data.classmaterial.task&&courseload.data.classmaterial.task.end_index===t){s=true}v=$("#main");u=$("#pageTemplate").tmpl({task:courseload.data.classmaterial.task,finalPage:s}).data("pageIndex",t).addClass(courseload.data.book.showSidebar?"open":"closed").appendTo(v).trigger("page_rendered");$(document).trigger("pageRendered");return u};$("div.toolbar a").live("click",function(s){s.preventDefault();return f()});$("div.toolbar span.return a").live("click",function(t){var s;t.preventDefault();if(courseload.data.section){s=courseload.data.section.short_id;return courseload.nav.updatehash([s])}});q=function(s){var t;t=courseload.data.manifest;courseload.book.updateNoteSetting();courseload.book.toggleCursorPointer();return(function(v){var u;u=v.data("pageIndex");return $.when(courseload.api.getwords(t,u),courseload.api.getmarkup(t,u)).done(function(x,w){var y;y=x[0];v.data("words",y).data("markup",w);return v.trigger("dataloaded")})})(s)};r=function(s){var v,u,t;t=courseload.data.manifest;v=$(".page:first").data("pageIndex")||0;if(s.indexOf){if(s.indexOf("-")===0||s.indexOf("+")===0){u=parseInt(s,10);s=parseInt(v,10)+u}else{s=parseInt(s,10)}}return s};c=function(s){var t;if($("html").hasClass("ios")){s.addClass("ios");t={swipeStatus:courseload.book.swipeStatus,allowPageScroll:"none",fingers:2};return $("div.page-scroll div.viewport, div.sidebar div.scroll div.viewport, div.nav-top div.scroll div.viewport").swipe(t)}};m=function(){return $(".phead").text("Copyrighted material licensed to "+courseload.data.user.name+" <"+courseload.data.user.email+">")};a=function(s){var t;t=s.find(".page-scroll");if(t.hasClass("tinyscrollbar")){return t.tinyscrollbar_update()}else{return t.addClass("tinyscrollbar").tinyscrollbar({sizethumb:"auto",size:"auto"})}};$("img.content").live("contextmenu",function(s){return s.preventDefault()});courseload.book.page.addnoteview=function(s){var x,z,v,t,y,u,w;t=courseload.data.classmaterial;u=$("#main > .nav").data();y=u.membership&&u.membership.role==="instructor";$("#main > .page").remove();x=$("#addPageNoteTemplate").tmpl({pageIndex:s+1,isInstructor:y}).appendTo("#main");w=n(x),v=w[0],z=w[1];x.find(".sidebar").width("100%");x.width(v).height(z);$(".cited-text").click(function(B){var A;A=$(this).closest(".quote-text-wrapper");A.find("div").toggle();A.find("textarea").val("");return A.find(".icon-caret-right").toggleClass("down")});$(".color-list li.yellow").addClass("selectedColor");$(".color-list li").click(function(C){var B,A;A=$(this);B=A.closest(".color-list");B.find(".selectedColor").removeClass("selectedColor");return A.addClass("selectedColor")});$(".color-list li").focusin(function(B){var A;A=$(this);return A.addClass("focused")});$(".color-list li").focusout(function(B){var A;A=$(this);return A.removeClass("focused")});p();return x};courseload.book.page.notesview=function(G){var t,u,F,A,w,s,C,E,z,v,D,B,y;if(G==null){G={}}C=$("#main > .nav").data();w=C.membership&&C.membership.role==="instructor";A=courseload.data.classmaterial;D=courseload.data.sharingclassmates||[];D=(function(){var I,H,x;x=[];for(I=0,H=D.length;I<H;I++){B=D[I];x.push({name:B.name,id:B.user.match(/\/api\/user\/(\d+)\//)[1]})}return x})();if(G.pageIndex||G.pageIndex===0){v=G.pageIndex}if(v||v===0){if($(".page").data().notes){z=$(".page").data().notes.length}E=$(".page").data().notescount||z}else{s=courseload.data.book.markuplist;E=courseload.markup.filterNotesOnly(s).length}$("#main > .page").remove();t=$("#notesViewTemplate").tmpl({sharing_with_me:D,pageIndex:v,notescount:E,isInstructor:w}).appendTo("#main");if(v&&!$(".page").hasClass("page-level-note")){t.addClass("page-level-note")}y=n(t),F=y[0],u=y[1];t.find(".sidebar").width("100%");t.width(F).height(u).data({pageIndex:v});courseload.book.notes.load(t,G.note_data);t.find("#main-content-headline").remove();$(".button.zin,.button.zout").attr("disabled","disabled").addClass("disabled");return t};p=function(){var s,w,u,t,v,x;w=$(".page.edit-note");if(w.length===0){return}u=w.children(".sidebar");v=u.children(".header");s=u.children(".note-edit-panel");t=s.children(".header");s.height(w.height()-t.outerHeight());x=parseInt(s.css("padding-top").replace("px",""),10)+parseInt(s.css("padding-bottom").replace("px",""),10);return $(".note-edit-panel .viewport").height(w.height()-v.outerHeight()-t.outerHeight()-x)};courseload.book.page.resizeNotesView=p;courseload.book.swipeStatus=function(w,y,x,s){var B,u,C,z,A,v,t;if(y==="move"&&(x==="up"||x==="down")){u=$(w.target).parents(".tinyscrollbar");B=u.find(".thumb");t=parseInt(B.css("top"),10);A=parseInt(B.css("height"),10);C=parseInt(u.css("height"),10);if(x==="down"){z=t+s;if(z<=C){v=s;return u.tinyscrollbar_update(v)}}else{if(x==="up"){z=t-s;if(z>=0){v=z}else{v=0}return u.tinyscrollbar_update(v)}}}};$(".page").live("page_resized",function(t){var s;s=i();$("div.toolbar.open").width(s);return p()});$(document).on("click",".add-page-level-note, .back-to-page, .add-book-note, .page-level-notes, .page .allnotes",function(v){var t,s,u;u=$(this).attr("class");switch(u){case"back-to-page":return courseload.book.page.loadPage(courseload.data.book.currentPage);case"add-page-level-note":courseload.book.page.addnoteview(courseload.data.book.currentPage);return $("form#add-page-note textarea#pagenote-text").focus();case"add-book-note":t=courseload.book.page.addnoteview($(this).data("pageindex"));return $("form#add-page-note input#add-note-page-number").focus();case"page-level-notes":s=courseload.book.page.notesview({pageIndex:courseload.data.book.currentPage});return $(".page").addClass("page-level-note");case"allnotes":return s=courseload.book.page.notesview({pageIndex:false})}})}).call(this);(function(){var a;namespace("courseload.book.ui");courseload.book.ui.navigator=function(d){var i,c,f,g,e,b,h;i=$("#navigator");if(i.length===0){i=$("#navigatorTemplate").tmpl().appendTo("#main");g=i.find(".navigator-view");f=i.find("img");i.draggable({handle:".navigator-top"});a(i);g.draggable({containment:f});f.bind("mousedown",function(j){return j.preventDefault()});g.bind("click",function(j){return j.preventDefault()})}c=d.$page;b=c.data("pageIndex");e=courseload.data.manifest.pages[b];h=""+courseload.data.manifest.image_base+"thumbs/"+e.image;i.find("img").prop("src",h);return i};a=function(h){var g,c,b,e,d,f;g=$(window);f=[0,0,g.width()-h.outerWidth(),g.height()-h.outerHeight()],c=f[0],e=f[1],b=f[2],d=f[3];return h.draggable("option","containment",[c,e,b,d])};$(window).resize(function(){var b;b=$("#navigator");if(b.length===0){return}return a(b)});$(".page").bind("page_resized",function(d){var c,b;b=$(this);return c=b.children("img.content")})}).call(this);(function(){var c,b,a;namespace("courseload.book");a=2;c=72;b={ME:0,INSTRUCTOR:1,CLASSMATES:2};$("#main").live("resized",function(d){if(courseload.data&&courseload.data.manifest){courseload.book.page.resizePageImages();return courseload.scrubber.refresh()}});$(".nav.main a.full").live("click",function(d){d.preventDefault();courseload.book.enableFullScreen();return courseload.book.toggleCursorPointer()});$(".nav.fullscreen-buttons > button.full").live("click",function(d){d.preventDefault();courseload.book.disableFullScreen();return courseload.book.toggleCursorPointer()});courseload.book.disableFullScreen=function(){courseload.markup.clearDialogs();$(".header").removeClass("hide");$(".nav.fullscreen-buttons").removeClass("show");$("div.menu").removeClass("hide");$(".nav.fullscreen-buttons").removeClass("show");$("#main").removeClass("fullscreen");$(".page").removeClass("fullscreen");$("img.content").removeClass("fullscreen");courseload.screen.exitFullScreen();return courseload.resize()};courseload.book.enableFullScreen=function(){courseload.markup.clearDialogs();$(".header.menu").addClass("hide");$(".nav.fullscreen-buttons").addClass("show");$("div.menu").addClass("hide");$(".nav.fullscreen-buttons").addClass("show");$("#main").addClass("fullscreen");$(".page").addClass("fullscreen");$("img.content").addClass("fullscreen");courseload.screen.enterFullScreen();return courseload.resize()};courseload.book.toggleCursorPointer=function(){if(courseload.data.book.notesetting===b.ME||courseload.data.book.notesetting===3){return $("img.content").toggleClass("allowed").attr("title","")}else{return $("img.content").toggleClass("notAllowed","allowed").attr("title",'To annotate this page, please select "Me" from the notes panel.')}};courseload.book.updateNoteSetting=function(){if(courseload.data.book){if(courseload.data.book.notesetting===3){return $("input[id=show_instructor_highlights]").each(function(d){return $(this).attr("checked",true)})}}};courseload.book.lastPageRead=function(){if(window.localStorage&&localStorage[courseload.data.classmaterial.uri]){courseload.data.classmaterial.last_page_read=JSON.parse(localStorage[courseload.data.classmaterial.uri]).last_page_read}if(courseload.data.classmaterial.hasOwnProperty("last_page_read")){return courseload.data.classmaterial.last_page_read}else{if(courseload.data.membership){return courseload.data.membership.last_pages[courseload.data.classmaterial.uri]}}};courseload.book.load=function(f,e){var g,d,h;$(".forBook").remove();$("#documentControlsTemplate").tmpl().prependTo("#container .menu .nav");$("#documentFooterTemplate").tmpl().appendTo($("#container"));$("#fullscreenControlsTemplate").tmpl().insertBefore("#main");$("p.resource-status-message").remove();if(courseload.data.book){courseload.data.book={notesetting:courseload.data.book.notesetting,showSidebar:courseload.data.book.showSidebar}}else{courseload.data.book={notesetting:3,showSidebar:!$("html").hasClass("ios")}}g=courseload.api.getroster(courseload.data.section);h=[];$.when(g).done(function(i){_.each(i,function(j){if(j.role==="instructor"){return h.push(j)}});courseload.data.book.instructors=h;return $(document).trigger("instructors_loaded")});if(!(e!=null)){d=courseload.book.lastPageRead()||0}else{d=e}courseload.book.page.loadPage(d);courseload.scrubber.init();$(document).on("instructors_loaded",function(){return $.when(courseload.api.getmarkuplist()).done(function(i){courseload.data.book.markuplist=i;courseload.scrubber.paintMarkupDots(i);return $(document).unbind("instructors_loaded")})});courseload.book.getNotesCount();if($("#main").hasClass("fullscreen")){courseload.book.enableFullScreen()}else{courseload.resize()}if(!courseload.data.markupColor){courseload.data.markupColor="yellow"}return courseload.book.toggleCursorPointer()};courseload.book.getNotesCount=function(){return $.when(courseload.api.getnotes({notes:courseload.data.classmaterial.notes+"?me=1&instructor=1&classmates=all&type=note"})).done(function(d){courseload.data.book.notescount=courseload.markup.filterNotesOnly(d).length;return $(document).trigger("markupListLoaded")})};courseload.book.pageFit=function(f){var d,g,e;g=courseload.data.book;e=f||FIT.ONE_PAGE;if(e===g.pageFit){return}g.pageFit=e;d=$(".page");return courseload.book.page.gotoPage(d.data("pageIndex"))};courseload.book.zoom=function(g){var j,f,d,i,l,k,e,m,h;courseload.markup.clearDialogs();e=g==="+"?1:-1;j=$(".page");l=j.hasClass("open");i=$("#main > .nav").hasClass("open");k=j.data().zoom;f=k.availableZoomLevels;d=k.currentZoomLevel;m=_.indexOf(k.availableZoomLevels,k.currentZoomLevel);m+=e;if(g==="+"&&d==="fit-width"&&(l||i)){courseload.book.page.clearCurrentZoomLevel();courseload.screen.collapsePanels();courseload.book.page.zoomPage(j);return}if(g==="-"&&!(l||i)){courseload.book.page.clearCurrentZoomLevel();courseload.screen.expandPanels();courseload.book.page.zoomPage(j);return}if(m<0){log("cannot zoom out anymore, zoomIndex already 0");return}if(m>k.availableZoomLevels.length-1){log("no more zoom levels available");return}h=k.availableZoomLevels[m];return courseload.book.page.zoomPage(j,h)};courseload.book.updateZoomButtons=function(j){var n,i,k,g,f,h,m,o,d,e,l;m=j.hasClass("open");h=$("#main > .nav").hasClass("open");n=$("a.button.zin, button.zin");i=$("a.button.zout, button.zout");l=j.data().zoom;e=courseload.data.manifest;k=l.allZoomLevels;g=l.availableZoomLevels;f=l.currentZoomLevel;d=f===_.first(k);o=!m&&!h&&f===_.last(k);o=o||f===_.last(e.sizes);n.toggleClass("disabled",o);return i.toggleClass("disabled",d)};$(".zin").live("click",function(d){d.preventDefault();return courseload.book.zoom("+")});$(".zout").live("click",function(d){d.preventDefault();return courseload.book.zoom("-")});$("#next-page,.aural-next-page").live("click",function(d){d.preventDefault();return courseload.book.page.gotoPage("+1")});$("#previous-page,.aural-previous-page").live("click",function(d){d.preventDefault();return courseload.book.page.gotoPage("-1")});$(".page img.content").live("mousedown",function(d){return d.preventDefault()});$("a.vertical").live("click",function(d){d.preventDefault();return courseload.book.pageFit(FIT.ONE_PAGE)});$("a.horizontal").live("click",function(d){d.preventDefault();return courseload.book.pageFit(FIT.TWO_PAGE)});$(document).on("change",'input[name="show_instructor_highlights"]',function(f){var d;d=$(this).is(":checked")?3:0;courseload.data.book.notesetting=d;courseload.book.page.loadPage($(".page:first").data("pageIndex"));return $.when(courseload.api.getmarkuplist()).done(function(e){courseload.data.book.markuplist=e;return courseload.scrubber.paintMarkupDots(e)})});$("#classmates").live("change",function(f){var d;d=$(this).val();if(d){courseload.data.book.selectedclassmate=d;return $("#show-from-classmate:first").click()}})}).call(this);(function(){var a;namespace("courseload.print");courseload.print.dialogInit=function(){var c,b;b=$(".page").data("pageIndex");if(b){c=courseload.data.manifest.pages[$(".page").data("pageIndex")].label;$("#print-input").val(c)}return $("#print-input").focus()};$("#modalprint .footer button.brown").live("click",function(h){var j,b,d,g,i,c,f,k;j=$(".modal-link.printing");j.remove();$("#print-input").val($("#print-input").val().replace(/\s/g,""));c=$("#print-input").val();if(c.length>0){b=c.split(",");f=c.split("-");if((b.length>1&&f.length>1)||f.length>2){$("#print-input").select().focus();return alert("Please enter a valid page range.")}else{if(b.length>1){alert("Please enter a valid page range or a single page number.");return false}else{if(f.length>1){k=[];i=a(f[0]);if(i===void 0){alert("No page found with that label");return false}k.push(i);i=a(f[f.length-1]);if(i===void 0){alert("No page found with that label");return false}k.push(i);d=Math.min(k[0],k[1]);g=Math.max(k[0],k[1]);d=d<=0?0:d;g=g<=0?0:g}else{d=a(c);g=d}}$.fancybox.close();courseload.print.submit(courseload.data.manifest.slug,d,g);$("#print.modal-link").hide();return $("<span class='modal-link printing'>Processing</span>").appendTo($(".book-section-right"))}}else{$("#print-input").select().focus();return alert("Please enter a valid page range.")}});a=function(c){var f,e,b,d;d=courseload.data.manifest.pages;for(e=0,b=d.length;e<b;e++){f=d[e];if(f.label===c){return f.pagenum;break}}return void 0};courseload.print.submit=function(b,d,c){courseload.api.print(b,d,c,function(e){if(e.href){return courseload.api.polljob(e,function(f){return courseload.print.updateStatus(f)})}else{return courseload.print.updateStatus(e)}});return courseload.print.updateStatus({status:"waiting"})};courseload.print.updateStatus=function(d){var c,b;b=d?d.status:"failed";c=$(".modal-link.printing");switch(b){case"waiting":case"inprogress":return c.text("Processing");case"bad_range":c.remove();alert("Invalid page range, please try printing again");return $("#print.modal-link").show();case"limit_exceeded":c.remove();alert("Too many pages requested, please try printing again with a smaller range");return $("#print.modal-link").show();case"failed":case"timeout":c.remove();alert("Error, please try printing again");return $("#print.modal-link").show();case"complete":c.text("Downloading");courseload.print.jobcomplete(d);return $("#print.modal-link").show()}};courseload.print.jobcomplete=function(c){var b,h,j,g,e,i,f,d;$(".sidebar").removeClass("printable");$("#printable").empty().addClass("printable");h=0;j=function(l){var k;$(this).unbind(l);h++;if(h>=c.result.hrefs.length){k=$(".modal-link.printing");k.remove();return window.print()}};f=c.result.hrefs;d=[];for(e=0,i=f.length;e<i;e++){g=f[e];b=$("<img/>");b.bind("load",j);b.appendTo("#printable");d.push(b.attr("src",g))}return d}}).call(this);(function(){namespace("courseload.settings");courseload.settings.dialogStart=function(){var a,b;b=courseload.data.classmaterial;$("#sharing_settings_form").attr("action",b.sharing_settings_uri);$(".book-title.coursename").text(courseload.data.classmaterial.title);if(courseload.data.classmaterial.author_byline){$(".book-author.professor").text("By "+courseload.data.classmaterial.author_byline)}a=$(".settings-students ul");a.empty();$("#sharing_instructor").prop("checked",false);return $('input[name="with_all_students"]:checked').prop("checked",false)};courseload.settings.dialogInit=function(){var a,c,d,b;b=courseload.data.classmaterial;a=$(".settings-students ul");c=courseload.api.getroster(courseload.data.section);d=courseload.api.getsharingsettings(b);return $.when(c,d).done(function(e,p){var q,g,m,h,n,o,k,s,j,i,r,f,l;m=e[0];h=p[0];o=(function(){var v,u,t;t=[];for(v=0,u=m.length;v<u;v++){s=m[v];if(s.role==="learner"&&s.user!==courseload.data.user.uri){t.push(s)}}return t})();for(j=0,r=o.length;j<r;j++){n=o[j];$("<li><input type='checkbox' id='"+n.user+"' name='shared_with' value='"+n.user+"' /><label for='"+n.user+"'>"+n.name+"</label></li>").appendTo(a)}$("#sharing_instructor").prop("checked",!h.with_all_instructor);g=$(".settings-students");q=g.find("input[type='checkbox']");g.removeClass("disabled");if(h.with_all_students){$("#sharing_all").prop("checked",true);q.prop("checked",true)}else{if(h.shared_with.length===0){$("#sharing_none").prop("checked",true);g.addClass("disabled")}else{$("#sharing_subset").prop("checked",true);l=h.shared_with;for(i=0,f=l.length;i<f;i++){k=l[i];a.find("input[id='"+k+"']").prop("checked",true)}}}return $("#sharing-content").removeClass("loading").addClass("loaded")})};$(document).on("submit","#sharing_settings_form",function(c){var a,b;c.preventDefault();a=$(c.target);b=a.serialize();courseload.api.savesharingsettings(courseload.data.classmaterial,b).done(function(d){return courseload.data.sharingsettings=d});return $.fancybox.close()});$(document).on("click","div.settings-students ul li input[type=checkbox]",function(a){if($('ul.settings-list li input[id="sharing_subset"]:checked').length===0){return $('ul.settings-list li input[id="sharing_subset"]').click()}});$(document).on("change","input[type='radio'][name='with_all_students']",function(){var c,b,a;a=$(this);b=$(".settings-students");c=b.find("input[type='checkbox']");if(a.is("#sharing_all")){c.prop("checked",true);return b.removeClass("disabled")}else{if(a.is("#sharing_none")){c.prop("checked",false);return b.addClass("disabled")}else{if(a.is("#sharing_subset")){return b.removeClass("disabled")}}}})}).call(this);(function(){var c,d,b,a;namespace("courseload.assignments");$("#main").live("resized",function(){return b()});courseload.assignments.load=function(i){var n,g,e,f,l,k,j,h,m;if(!i.section.hasOwnProperty("assignment_milestone_ranges")){i.section.assignment_milestone_ranges=c(i)}k=[];e=i.section.assignments;l=i.section.assignment_milestone_ranges;for(h=0,m=l.length;h<m;h++){j=l[h];f={};f.assignments=_.filter(e,function(o){return o.position>=j.min&&o.position<=j.max});f.current=j.current;k.push(f)}d(i);n=$("#assignmentListTemplate").tmpl({milestones:k}).data({membershipUri:i.uri}).appendTo("#main");$("a.nav-arrow").height(0);g=_.find(k,function(o){return o.current===true});if(g){$("#view-current").prop("checked",true).change()}else{$("#assignment-list-form").hide()}return b()};$("dd.assignment-task a").live("click",function(g){var f,h;g.preventDefault();f=$(this);h=[f.data("taskid"),f.data("materialid")];return courseload.nav.updatehash(h)});$("#assignment-list-form input[type=radio]").live("change",function(f){if($("#view-current").prop("checked")){$(".overview dl.all").hide()}else{if($("#view-all").prop("checked")){$(".overview dl.all").show()}}return b()});$("div.assignmentscroll .overview dl dd.assignment-task input[type=checkbox]").live("change",function(l){var g,m,j,o,h,n,p,f,i,k;g=$(this);k=g.data("task");i=g.data("completeduri");f={task_complete_uri:i};j=g.prop("checked");m=g.parent();n=$("#assignments-content-wrapper").data("membershipUri");p=_.flatten(_.pluck(courseload.data.nav.terms,"memberships"));h=_.find(p,function(e){return e.uri===n});o=_.indexOf(h.completed_assignments,k);if(j){if(o===-1){h.completed_assignments.push(k)}m.addClass("completed");return courseload.api.taskComplete(f)}else{if(o!==-1){h.completed_assignments.splice(o,1)}m.removeClass("completed");return courseload.api.taskNotComplete(f)}});d=function(g){var m,h,j,l,f,k,e;k=g.section.assignments;e=[];for(l=0,f=k.length;l<f;l++){m=k[l];if(m.type==="task"){e.push((function(){var p,n,i,o;i=m.items;o=[];for(p=0,n=i.length;p<n;p++){j=i[p];h=_.indexOf(g.completed_assignments,j.id);o.push(j.completed=h!==-1)}return o})())}}return e};c=function(j){var g,f,e,l,o,n,i,k,m,h,p;i=o=0;m=Date.today();n=[];f=j.section.assignments;e=null;for(h=0,p=f.length;h<p;h++){g=f[h];if(!(g.type==="milestone")){continue}l=Date.parse(g.due_date);if(e===null&&l>=m){e=g.position}k={min:i,max:g.position,current:g.position===e};n.push(k);i=g.position+1}return n};b=function(){var f,g,e,h;e=$(".menu:visible").outerHeight(true);g=$(".footer.tracker").outerHeight(true);f=h=$(window).height()-e-g-20;$("#assignments-content-wrapper").height(h);f-=_.reduce($(".assignments-header"),function(i,j){return i+$(j).outerHeight(true)},0);$(".assignmentscroll").height(f);return a()};a=function(){var e;e=$("#assignments-content-wrapper").find(".scroll");if(e.hasClass("tinyscrollbar")){return e.tinyscrollbar_update("relative")}else{return e.addClass("tinyscrollbar").tinyscrollbar({sizethumb:"auto",size:"auto"})}}}).call(this);(function(){var a=[].indexOf||function(d){for(var c=0,b=this.length;c<b;c++){if(c in this&&this[c]===d){return c}}return -1};namespace("courseload.models");courseload.models.getModelByShortId=function(c){var b;b=_.detect(courseload.data.flattened_models,function(d){return d.short_id===c});return b};courseload.models.clearContent=function(){$("#assignments-content-wrapper").remove();$(".forBook, .page, .externallinkcontainer").remove();if(!$(".resource-status-message").length){$("#resourceStatusMessageTemplate").tmpl().appendTo("#main")}delete courseload.data.book;delete courseload.data.classmaterial;delete courseload.data.manifest;delete courseload.data.markupColor;delete courseload.data.membership;delete courseload.data.section;delete courseload.data.sharingclassmates;return delete courseload.data.sharingsettings};courseload.models.Term=(function(){function b(){}b.prototype.clearContentArea=function(){return courseload.models.clearContent()};b.prototype.paint=function(){var c;this.clearContentArea();courseload.nav.ui.courseListing(this);c=""+this.term+" Courses";courseload.nav.updateBrowserTitle(c);$("div.skip-navigation").remove();return $("#skipNavigation_CourseView").tmpl().prependTo("#container")};return b})();courseload.models.Section=(function(){function b(){}b.prototype.clearContentArea=function(){return courseload.models.clearContent()};b.prototype.paint=function(){var c,e,j,o,f,n,i,h,l,d,k,g;this.clearContentArea();k=courseload.data.nav.terms;for(i=0,l=k.length;i<l;i++){o=k[i];g=o.memberships;for(h=0,d=g.length;h<d;h++){e=g[h];if(e.section.short_id===this.short_id){j=e}}if(j){f=o;break}}if(f&&j){if(this.tags.length===0){courseload.nav.ui.courseDetail(f,j);c=$("#skipNavigation_SectionView")}else{courseload.nav.ui.courseTags(f,j);c=$("#skipNavigation_StacksView")}n=""+j.section.title;courseload.nav.updateBrowserTitle(n);if(j.section.assignments.length){courseload.offline.status(function(m){if(m){return courseload.assignments.load(j)}})}$("div.skip-navigation").remove();return c.tmpl().prependTo("#container")}};return b})();courseload.models.AssignmentItem=(function(){function b(){}b.prototype.clearContentArea=function(){return $("#assignments-content-wrapper").remove()};b.prototype.paint=function(d){var e,c;this.clearContentArea();c=this;if(d){e=$.extend({},d);e.task=c;e.getDefaultPageIndex=function(){var g,i,f,h;c.start_index=courseload.book.page.getIndexByLabel(c.start_page_label);c.end_index=courseload.book.page.getIndexByLabel(c.end_page_label);h=_.range(c.start_index,c.end_index+1);i=courseload.book.lastPageRead();if(a.call(h,i)>=0){f=i}g=f!=null?f:c.start_index;return g};return e.paint()}};return b})();courseload.models.Material=(function(){function b(){}b.prototype.clearContentArea=function(){return $("#assignments-content-wrapper").remove()};b.prototype.getDefaultPageIndex=function(){return courseload.book.lastPageRead()||0};b.prototype.paint=function(d){var p,n,e,k,o,s,g,r,j,i,q,c,l,h,f;this.clearContentArea();if(courseload.data.book&&courseload.data.classmaterial&&courseload.data.classmaterial.uri===this.uri){courseload.data.classmaterial.task=(l=courseload.data.classmaterial.task)!=null?l:this.task;d=d!=null?d:this.getDefaultPageIndex();return courseload.book.page.loadPage(d)}else{courseload.data.classmaterial=o=this;h=courseload.data.nav.terms;for(j=0,q=h.length;j<q;j++){s=h[j];f=s.memberships;for(i=0,c=f.length;i<c;i++){e=f[i];if(e.section.uri===this.section_uri){k=e}}if(k){g=s;break}}if(courseload.data.classmaterial.is_checked_out){courseload.api=$.extend(true,{},courseload.api_offline)}else{courseload.api=$.extend(true,{},courseload.api_online)}r=""+o.title;courseload.nav.updateBrowserTitle(r);if(o.section){courseload.data.membership=k;courseload.data.section=k.section;courseload.data.classmaterial.sectionUri=k.section.uri;courseload.data.classmaterial.sectionId=o.section;courseload.data.sharingsettings={};switch(o.media_type){case"text":$("div.skip-navigation").remove();$("#skipNavigation_ContentView").tmpl().prependTo("#container");courseload.api.getmanifest({manifest:o.manifest}).done(function(m){courseload.data.manifest=m;d=o.getDefaultPageIndex();courseload.nav.ui.bookDetail(g,k,o);return courseload.book.load(m,d)});n=courseload.api.getclassmatessharingwithme(o);p=courseload.api.getroster(courseload.data.section);$.when(n,p).done(function(m,w){var v,u,t;u=m[0];v=w[0];t=_.filter(v,function(y){var z;return z=y.user,a.call(u.sharing_with_me,z)>=0});courseload.data.sharingclassmates=t;return courseload.book.updateNoteSetting()});return courseload.api.getsharingsettings(o).done(function(m){return courseload.data.sharingsettings=m});case"link":case"video":if(o.lti_provider!==""){courseload.externallink.ui.blti.load(o)}else{courseload.externallink.ui.load()}return courseload.nav.ui.linkDetail(g,k,o)}}else{delete courseload.data.section;delete courseload.data.membership;return courseload.api.getmanifest({manifest:o.manifest}).done(function(t){var m;courseload.data.manifest=t;courseload.book.load(t);m=$("#main > .nav").data();g=m.term;k=m.membership;return courseload.nav.ui.additionalResourcesDetail(g,k,o)})}}};return b})()}).call(this);(function(){var p,h,l,j,o,c,e,b,n,g,d,q,k,m,a,f,i;namespace("courseload.nav");namespace("courseload.nav.ui");namespace("courseload.data");p="index/";h=false;for(l in window){if(l==="onhashchange"){h=true}}courseload.nav.updateBrowserTitle=function(r){if(r){r=r+" - Courseload"}else{r="Courseload"}return $("title").text(r)};k=function(B){var v,A,I,E,r,u,t,s,C,J,G,H,F,z,x,w,y,D;I=B.find(".nav-content-wrapper");A=B.find(".nav-top");C=$("div.menu:visible").outerHeight(true);s=$(".footer.tracker").outerHeight(true);F=$(window).height()-C-s-20;x=$(window).height()-C-s-50;H=B.find(".nav-header").outerHeight(true);G=B.find(".nav-footer").outerHeight(true);z=B.find("div.label-search").outerHeight(true);I.height(F);A.height(x);E=$(window).height()-C-s-315;if(B.data().classmaterial){G=0;A.css({marginBottom:"0",height:x+30});E+=30}B.find(".bookdetailscroll").height(E);u=30;t=F-H-G-z-u;B.find(".courselistingscroll").height(t);r=F-H-G-z-u;r-=_.reduce(B.find(".course-header"),function(K,L){return K+$(L).outerHeight(true)},0);v=B.find(".course-select");D=B.find("#term-selection").height();J=x-D-G;w=v.find(".overview").height();y=J<w?J:w;v.find(".viewport").height(y);B.find(".coursedetailscroll").height(r);return a(B)};a=function(r){var s;s=r.find(".scroll");if(s.hasClass("tinyscrollbar")){return s.tinyscrollbar_update("relative")}else{return s.addClass("tinyscrollbar").tinyscrollbar({sizethumb:"auto",size:"auto"})}};courseload.nav.resize=function(){var r;r=$("#main .nav");if(r.length===0){return}return k(r)};$("#additionalResourcesLink").live("click",function(r){courseload.nav.clearhash();courseload.models.clearContent();return courseload.nav.ui.additionalResources()});i=function(){if(courseload.upload.enabled()){return $("a.upload").fancybox(courseload.upload.dialogSettings())}else{return $("a.upload").hide()}};courseload.nav.ui.courseListing=function(r){return courseload.offline.status(function(t){var s;$("#main > .nav").remove();s=$("#navCourseListingTemplate").tmpl({user:courseload.data.user,term:r,online:t}).data({term:r}).prependTo("#main");k(s);return i()})};courseload.nav.ui.additionalResources=function(){var r,s,t,u;s=$("#main > .nav").data();t=s.term;$("#main > .nav").remove();r=$("#navAdditionalResourcesTemplate").tmpl({user:courseload.data.user,term:t,classmaterials:courseload.data.resources}).data({term:t,classmaterials:courseload.data.resources}).prependTo("#main");r.find("img").bind("load",function(){return a(r)});k(r);i();u="Additional Resources";return courseload.nav.updateBrowserTitle(u)};courseload.nav.ui._getUrl=b=function(r){switch(r.media_type){case"link":return r.link_url;case"video":return r.video_player_uri;default:return r.uri}};courseload.nav.ui_getCoverImage=e=function(r){switch(r.media_type){case"text":return r.cover_image;default:return r.cover_override}};courseload.nav.ui.nestedDetail=function(C,E,x){var s,D,v,u,t,B,z,r,w,A,y;z=courseload.pluralize;for(w=0,A=E.length;w<A;w++){D=E[w];if(!D.is_finalized){return $("#nestedPendingCourseDetail").tmpl({material:D,membership:x}).appendTo(C)}t=courseload.offline.getExpiry(D);v=e(D);r=b(D);B=(y=x.role)==="instructor"||y==="administrator";if(!t.is_expired){u=""+(t.days_remaining||0)+"\n"+(z(t.days_remaining,"day","days"))}else{u="Expired"}s=$("#nestedCourseDetailTemplate").tmpl({classmaterial:D,daysLeft:u,isExpired:t.is_expired,coverImage:v,url:r,isManager:B,membership:x,showCheckout:q(D),showPrintOptions:false}).appendTo(C);g(s,D)}};n=function(s,r){return $(s).on("click","a.checkin",function(t){t.preventDefault();return courseload.offline.status(function(v){var w,x,u;if(!v){return alert("An internet connection is required to check in books. Please reconnect to the Internet, refresh this page, then check in the book.")}else{u=$(t.target).attr("slug");x=$(t.target).attr("section");if($.isArray(r)){w=_.detect(r,function(y){return y.slug===u&&y.section.toString()===x})}else{w=r}$(document).bind("syncComplete",function(z,y){$(document).unbind("syncComplete");courseload.offline.syncing=y.is_syncing=false;courseload.offline.checkin(y);return courseload.nav.refresh()});courseload.offline.syncing=w.is_syncing=true;courseload.nav.refresh();return courseload.offline.synchOfflineData(w)}})})};o=function(s){var r;if(courseload.offline.isBusy()){r="Another sync or download is in progress. Please wait a few moments.";alert(r)}return $.when(courseload.offline.checkout(s.data.material)).always(function(t){return courseload.nav.refresh()})};j=function(r){$("div.action a.checkout.material-option").remove();return $("div.action").append($("<span/>",{"class":"error",text:r}))};q=function(r){return r.section&&r.media_type==="text"&&!r.is_checked_out};g=function(s,r){return $(s).on("click","a.checkout.material-option",{material:r},function(y){var x,w,t,v,u;if(!courseload.offline.approvedBrowser()){t="http://help.courseload.com/help/offline/install-offline-plugin/demo.html";v=window.open(t,"Courseload Offline Access","height=800,width=800");v.focus();return}x="hbdpmgmjclnfpdpfhiofapclnibejdef";u="https://chrome.google.com/webstore/detail/"+x;w=function(){var z;if((z=chrome.app.runningState())==="running"||z==="ready_to_run"){return true}else{return false}};if(w()){return o(y)}else{return chrome.webstore.install(u,(function(){return o(y)}),function(z){return j(z)})}})};courseload.nav.ui.courseDetail=function(t,s){var r,u,v,w;u=courseload.data.classmaterials.classmaterials[s.section.uri];w=_.sortBy(u,function(y){return y.title.toUpperCase()});v=w.length;$("#main > .nav").remove();r=$("#navCourseDetailTemplate").tmpl({itemCount:v}).data({term:t,membership:s,classmaterials:w}).prependTo("#main");$("#nestedTermHeaderTemplate").tmpl({term:t,membership:s}).prependTo(r.find("div.nav-top"));n(r,w);courseload.nav.ui.nestedDetail(r.find("ul.comments.overview"),w,s);r.find("img").bind("load",function(){return a(r)});k(r);return $(document).trigger("courseDetailRendered")};courseload.nav.ui.tagDetail=function(u,t,s){var r,v,x,w,y;v=courseload.data.classmaterials.classmaterials[t.section.uri];if(s!==""){w=_.select(v,function(z){return _.include(z.tags,s)})}else{s="All Resources";w=v}y=_.sortBy(w,function(z){return z.title.toUpperCase()});x=y.length;$("#main > .nav").remove();r=$("#navTagDetailTemplate").tmpl({term:u,membership:t,itemCount:x,tag:s}).data({term:u,membership:t,classmaterials:y}).prependTo("#main");n(r,y);courseload.nav.ui.nestedDetail(r.find("ul.comments.overview"),y,t);r.find("img").bind("load",function(){return a(r)});k(r);$("div.skip-navigation").remove();return $("#skipNavigation_StackView").tmpl({tag:s}).prependTo("#container")};courseload.nav.ui.renderTagSearchResults=function(u,t){var v,r,w,s;v=$("div.nav-top .header.nav-header");s=v.find("span.nav-header-title");s.html("Searching all stacks");v.empty().append(s);$("div.nav-footer.addtag").empty();w=$("ul.comments.overview");w.empty();courseload.nav.ui.nestedDetail(w,t,u);$("#navLeftNavSearchResultsTemplate").tmpl({classmaterials:t,membership:u}).appendTo(w);r=$("#main > .nav");r.find("img").bind("load",function(){return a(r)});return k(r)};courseload.nav.ui.courseTags=function(s,r){return courseload.offline.status(function(u){var t;$("#main > .nav").remove();t=$("#navTagListTemplate").tmpl({term:s,membership:r,online:u,getMaterialCount:function(v){var w;w=courseload.data.classmaterials.classmaterials[r.section.uri];if(v){w=_.select(w,function(y){return _.include(y.tags,v)})}return w.length}}).data({term:s,membership:r,classmaterials:courseload.data.classmaterials.classmaterials[r.section.uri]}).prependTo("#main");t.find("img").bind("load",function(){return a(t)});return k(t)})};courseload.nav.ui.bookDetail=function(x,z,C){var D,y,w,t,E,s,B,v,u,r,A;s=courseload.data.manifest;u=c();$("#main > .nav").remove();B=courseload.pluralize;t=courseload.offline.getExpiry(C);y=e(C);r=b(C);E=(A=C.role)==="instructor"||A==="administrator";if(!t.is_expired){w=""+(t.days_remaining||0)+"\n"+(B(t.days_remaining,"day","days"))}else{w="Expired"}D=$("#navBookDetailTemplate").tmpl({term:x,membership:z,classmaterial:C,manifest:s,toc:u,daysLeft:w,isExpired:t.is_expired,showCheckout:q(C),showPrintOptions:true}).data({term:x,membership:z,classmaterial:C}).prependTo("#main");n(D,C);g(D,C);courseload.notification.qanda.refresh();k(D);$.when(courseload.api.getbookmarks(C)).done(function(F){return courseload.nav.ui.bookmarks(F)});v={overlayColor:"#000",margin:30,padding:0,onComplete:courseload.print.dialogInit};$("a#print").fancybox(v);v={overlayColor:"#000",margin:30,padding:0,onStart:courseload.settings.dialogStart,onComplete:courseload.settings.dialogInit};$("a#sharing").fancybox(v);$(document).trigger("resourceDetailRendered");return courseload.book.notes.allNotesCount()};$("body").live("focus",function(t){var s,r;r=$(t.target);s=$("div.modal:visible");if(r.is(":hidden")){if(s.length===1){s.find(":input:visible:first").focus()}else{$("a:first").focus()}}else{if(s.length===1&&r.parents("div.modal").length===0&&$("#uploadTarget").length===0){return s.find(":input:visible:first").focus()}}});courseload.nav.ui.linkDetail=function(u,t,s){var r;$("#main > .nav").remove();r=$("#navLinkDetailTemplate").tmpl({term:u,membership:t,classmaterial:s,getUrl:function(v){return b(v)},getCoverImage:function(v){return e(v)}}).data({term:u,membership:t,classmaterial:s}).prependTo("#main");return k(r)};courseload.nav.ui.additionalResourcesDetail=function(u,t,s){var r,w,v,x;w=courseload.data.manifest;x=c();$("#main > .nav").remove();r=$("#navAdditionalResourcesDetailTemplate").tmpl({user:courseload.data.user,term:u,membership:t,classmaterial:s,manifest:w,toc:x}).data({term:u,membership:t,classmaterial:s}).prependTo("#main");k(r);$.when(courseload.api.getbookmarks(s)).done(function(y){return courseload.nav.ui.bookmarks(y)});v={overlayColor:"#000",margin:30,padding:0,onComplete:courseload.print.dialogInit};return $("a#print").fancybox(v)};courseload.nav.ui.addBookmark=function(s){var u,r,t;r=$("#main > .nav");u=r.find(".scroll > .viewport > .overview > .bookmark");if(u.length===0){return}t=u.data().bookmarks;t.push(s);courseload.nav.ui.bookmarks(t);return a(r)};courseload.nav.ui.removeBookmark=function(s){var v,r,u,t;r=$("#main > .nav");v=r.find(".scroll > .viewport > .overview > .bookmark");if(v.length===0){return}u=v.data().bookmarks;t=_.indexOf(u,s);if(t!==-1){u.splice(t,1)}courseload.nav.ui.bookmarks(u);return a(r)};courseload.nav.ui.bookmarks=function(s){var t,r;s=_.uniq(s).sort(function(v,u){return v-u});r=$("#main > .nav");t=r.find(".scroll > .viewport > .overview > .bookmark");t.data("bookmarks",s);return $("#navBookmarkTemplate").tmpl({bookmarks:s}).appendTo(t.empty())};c=function(){var z,s,t,w,v,y,r,x,u;t=[];x=courseload.data.manifest.TOC;for(w=0,y=x.length;w<y;w++){z=x[w];t.push({name:z.name,page:z.page});u=z.sections;for(v=0,r=u.length;v<r;v++){s=u[v];t.push({name:s.name,page:s.page})}}return t};m=function(s,r){return _.find(s,function(u){u=u.toString();return u.toLowerCase()===r.toLowerCase()})};f=function(t){var s,r;s=_.groupBy(t,function(u){return $(u).prop("checked")});r=_.map(s[true],function(u){return $("label[for="+u.id+"]").text().toString()});r.naturalSort(true);return r};$("#main").live("click",function(t){var s,r;r=$(t.target);if(r.parents(".nav-header").length||r.is(".nav-header")||r.is(".nav-section")){return}s=$("#main > .selectTerms");if(s.length===1){s.remove()}});$("#main > .nav").live("click",function(aj){var v,M,an,D,U,G,A,J,z,K,r,aa,E,ah,w,R,O,ao,S,al,af,Z,H,ak,ag,P,L,N,ae,s,u,ai,ad,x,I,am,F,t,X,ac,V,y,Q,W,B,T,ab,Y,C;w=$(aj.target);if(!(w.is("a.externalclassmateriallink")||w.is("input, label")||w.is("a.crx"))){aj.preventDefault()}z=$(this);if(w.is("a.courselink")){Q=z.data("term");u=_.detect(Q.memberships,function(ap){return ap.uri===w.attr("href")});return courseload.nav.updatehash([""+u.section.short_id])}else{if(w.is(".notification.new-responses > a")){am=$("#main > .nav").data();ak=new $.Deferred();courseload.api.getnotes({notes:am.classmaterial.notes+"?me=1"}).done(function(ar){var at,ap,aq;at=(function(){var aw,av,au;au=[];for(aw=0,av=ar.length;aw<av;aw++){ap=ar[aw];if(ap.read===false&&(ap.type==="response"||ap.is_question===true)){au.push(ap)}}return au})();ak.resolve(at);aq=function(){var aw,ax,av,au;au=[];for(ax=0,av=at.length;ax<av;ax++){aw=at[ax];au.push(courseload.api.markread(aw))}return au};_.defer(aq);return _.delay(courseload.notification.qanda.refresh,2000)});$("#main > .nav .tabs").find("a.active").removeClass("active");r=courseload.book.page.notesview({note_data:ak});r.addClass("new-responses");r.find(".header > h3").text("New Responses");z.find(".overview > .toc").hide();z.find(".overview > .bookmark").hide();courseload.nav.clearhash();return a(z)}else{if(w.is(".notification.new-questions > a")){am=$("#main > .nav").data();H=new $.Deferred();courseload.api.getnewquestions(am.classmaterial).done(function(ap){ap=ap[am.membership.section.uri][am.classmaterial.slug];return H.resolve(ap)});$("#main > .nav .tabs").find("a.active").removeClass("active");r=courseload.book.page.notesview({note_data:H});r.addClass("new-questions");r.find(".header > h3").text("New Questions");z.find(".overview > .toc").hide();z.find(".overview > .bookmark").hide();courseload.nav.clearhash();return a(z)}else{if(w.is("#stats")){return window.open(w.attr("href"))}else{if(w.is("a.nav-arrow")){z.toggleClass("open closed").find(".nav-content-wrapper").toggle();z.find(".new-question-notifications .notification").toggle(z.hasClass("open"));courseload.markup.clearDialogs();return courseload.resize()}else{if(w.is("a.chapterlink")){return courseload.nav.updatehash([""+courseload.data.classmaterial.short_id,""+p+(w.data("pageindex"))])}else{if(w.is("button.label-menu-opener")&&w.parents(".book-section-right").length){F=z.data().membership.section;M=$(".left-nav-dialog");if(M.length){aa=M.data().$button;M.data().close();if(aa.data().taguri===w.data().taguri){return}}w.addClass("active");J=w.parents(".nav-section").parent();B=w.offset().top-J.offset().top+w.height();an=$("#leftNavLabelDialogTemplate").tmpl({section:F}).appendTo(J).data("$button",w).data("section",F).css("top",B).css("min-height","35px").css("min-width","100px").css("padding","0px");K=w.parents(".folder-item");D=$("div.nav-footer");ag=w.offset().top+an.outerHeight(true);if(ag>D.offset().top){P=ag-D.offset().top;an.css("top",B-w.outerHeight(true)-P)}ab=function(){$(document).unbind(".left-nav-dialog");an.data().$button.removeClass("active");return an.remove()};an.data("close",ab);V=w.data("taguri");an.find("a").bind("click",function(aq){var ap;aq.preventDefault();ap=$('li.nav-section div.book-section-right a.taglink[href="'+V+'"]');ab();switch(w.attr("href")){case"#renametag":return courseload.tag.editInPlace(ap);case"#deletetag":if(confirm("Are you sure you want to remove the '"+(ap.data().tag)+"' stack?")){return courseload.tag["delete"](ap.data("tag"))}}});$(document).bind("mousedown.left-nav-dialog.manage-label",function(ap){w=$(ap.target);if(!(w.is(".left-nav-dialog")||w.parents(".left-nav-dialog").length||w.is(".book-section-right button.label-menu-opener")||w.parent().is(".book-section-right button.label-menu-opener"))){return ab()}});return $(document).bind("keydown.left-nav-dialog.manage-label",function(ap){switch(ap.which){case hotkeys.Escape:return ab()}})}else{if(w.is("button.menu-opener")&&w.parents(".book-section-right").length){s=w.data().classmaterial;ae=_.detect(z.data().classmaterials,function(ap){return ap.uri===s});u=z.data().membership;F=u.section;M=$(".left-nav-dialog");if(M.length){aa=M.data().$button;M.data().close();if(aa.data().classmaterial===w.data().classmaterial){return}}w.addClass("active");J=w.parents(".nav-section").parent();B=w.offset().top-J.offset().top+w.height();an=$("#leftNavDialogTemplate").tmpl({material:ae,section:F,membership:u}).appendTo(J).data("$button",w).data("classmaterial",ae).data("section",F).css("top",B);if((Y=u.role)!=="instructor"&&Y!=="administrator"){an.css("min-width","30px").css("min-height","15px")}if($(".footer.tracker").length){R=$(".footer.tracker").offset().top}else{R=$(window).height()}ag=an.offset().top+an.outerHeight(true);if(ag>R){P=ag-R;an.css("top",B-w.height()-P)}ab=function(){d(ae,u);$(document).unbind(".left-nav-dialog");an.data().$button.removeClass("active");an.remove();return courseload.nav.resize()};an.data("close",ab);an.find("form").bind("submit",function(av){var ar,aq,au,at,ap;av.preventDefault();aq=$(this).find("input").val();F=F||z.data().membership.section;if(aq){if(!m(F.tags,aq)){ap=[F.tags,ae.tags];for(au=0,at=ap.length;au<at;au++){ar=ap[au];ar.push(aq);ar.naturalSort(true)}courseload.api.addTag(ae,aq);d(ae,u);return ab()}else{alert("A tag already exists with that name.");return $(this).find("input").val(null)}}});$(document).bind("mousedown.left-nav-dialog.manage-material",function(ap){w=$(ap.target);if(!(w.is(".left-nav-dialog")||w.parents(".left-nav-dialog").length||w.is(".book-section-right button.menu-opener")||w.parent().is(".book-section-right button.menu-opener"))){return ab()}});return $(document).bind("keydown.left-nav-dialog.manage-material",function(ap){switch(ap.which){case hotkeys.Escape:return ab()}})}else{if(w.is("button.user-resource-menu-opener")&&w.parents(".book-section-right").length){s=w.data().material;ae=_.detect(z.data().classmaterials,function(ap){return ap.uri===s});M=$(".left-nav-dialog");if(M.length){aa=M.data().$button;M.data().close();if(aa.data().material===w.data().material){return}}w.addClass("active");J=w.parents(".nav-section").parent();B=w.offset().top-J.offset().top+w.height();an=$("#leftNavUserResourceDialogTemplate").tmpl().appendTo(J).data("$button",w).css("top",B).css("min-height","15px").css("min-width","30px").css("padding","0px");K=w.parents(".folder-item");D=$("div.nav-footer");ag=w.offset().top+an.outerHeight(true);if(ag>D.offset().top){P=ag-D.offset().top;an.css("top",B-w.outerHeight(true)-P)}ab=function(){$(document).unbind(".left-nav-dialog");an.data().$button.removeClass("active");return an.remove()};an.data("close",ab);an.find("a").bind("click",function(aq){var ap;aq.preventDefault();ab();if(w.attr("href")==="#deleteresource"){if(confirm("Are you sure you want to remove '"+ae.title+"' from your resources?")){courseload.api.deleteusereresource(ae)}}if(courseload.data.classmaterial&&courseload.data.classmaterial.uri&&courseload.data.classmaterial.uri===ae.uri){$(".forBook").remove();$("#main > .page").remove()}ap=courseload.data.resources;courseload.data.resources=_.reject(ap,function(ar){return ar.uri===ae.uri});return courseload.nav.ui.additionalResources()});$(document).bind("mousedown.left-nav-dialog.user-resource-menu-opener",function(ap){w=$(ap.target);if(!(w.is(".left-nav-dialog")||w.parents(".left-nav-dialog").length||w.is(".book-section-right button.user-resource-menu-opener")||w.parent().is(".book-section-right button.user-resource-menu-opener"))){return ab()}});return $(document).bind("keydown.left-nav-dialog.user-resource-menu-opener",function(ap){switch(ap.which){case hotkeys.Escape:return ab()}})}else{if(w.is("button.upload-abort-menu-opener")&&w.parents(".nav-section-right").length){s=w.data().material;u=z.data().membership;ae=_.detect(z.data().classmaterials,function(ap){return ap.uri===s});M=$(".left-nav-dialog");if(M.length){aa=M.data().$button;M.data().close();if(aa.data().material===w.data().material){return}}w.addClass("active");J=w.parents(".nav-section");B=w.offset().top-J.offset().top+w.height();y=u?"#leftNavClassMaterialAbortDialogTemplate":"#leftNavUserResourceAbortDialogTemplate";an=$(y).tmpl().appendTo(J).data("$button",w).css("top",B).css("min-height","15px").css("min-width","30px").css("padding","0px");K=w.parents(".folder-item");if($(".footer.tracker").length){R=$(".footer.tracker").offset().top}else{R=$(window).height()}ag=an.offset().top+an.outerHeight(true);if(ag>R){P=ag-R;an.css("top",B-w.height()-P)}ab=function(){$(document).unbind(".left-nav-dialog");an.data().$button.removeClass("active");return an.remove()};an.data("close",ab);an.find("a").bind("click",function(ap){ap.preventDefault();ab();if(w.attr("href")==="#abortclassmaterial"||w.attr("href")==="#abortuserresource"){if(confirm("Are you sure you want to remove '"+ae.title+"'?")){return courseload.api.abortupload(ae).done(function(){return $.when(courseload.api.getclassmaterials(courseload.data.user),courseload.api.getuserresources()).done(function(aq,ar){courseload.data.classmaterials=aq;courseload.data.resources=ar;if(u){return courseload.nav.refresh()}else{return courseload.nav.ui.additionalResources()}})})}}});$(document).bind("mousedown.left-nav-dialog.upload-abort-menu-opener",function(ap){w=$(ap.target);if(!(w.is(".left-nav-dialog")||w.parents(".left-nav-dialog").length||w.is(".book-section-right button.upload-abort-menu-opener")||w.parent().is(".book-section-right button.upload-abort-menu-opener"))){return ab()}});return $(document).bind("keydown.left-nav-dialog.upload-abort-menu-opener",function(ap){switch(ap.which){case hotkeys.Escape:return ab()}})}else{if(w.is("a.cancelcheckout")){courseload.offline.abort();ao=w.attr("href");return S=_.detect(z.data().classmaterials,function(ap){return ap.checkout===ao})}else{if(w.is("a.deletematerial")){an=w.parents(".left-nav-dialog");Q=z.data().term;u=z.data().membership;F=an.data().section;S=an.data().classmaterial;an.data().close();if(confirm("This item is currently being shared with the entire class. If you delete it other members of this class will no longer have access to this item.\n\nAre you sure you want to remove '"+S.title+"' from "+F.title+"?")){courseload.api.deleteclassmaterial(S);if(courseload.data.classmaterial&&courseload.data.classmaterial.uri&&courseload.data.classmaterial.uri===S.uri){$(".forBook").remove();$("#main > .page").remove()}al=courseload.data.classmaterials.classmaterials[F.uri];courseload.data.classmaterials.classmaterials[F.uri]=_.reject(al,function(ap){return ap.uri===S.uri});return courseload.nav.refresh()}}else{if(w.is('.left-nav-dialog ul.tag-list input[type="checkbox"]')){an=w.parents(".left-nav-dialog");ae=an.data().classmaterial;ae.tags=f(w.parents("ul").find("input"));u=z.data().membership;G=w.parent().find('label[for="'+w[0].id+'"]');ac=G.text();O=w.prop("checked");if(O){ai=courseload.api.addTag}else{ai=courseload.api.removeTag}ai(ae,ac);d(ae,u);T=w.data().wasLabelClicked;w.data("wasLabelClicked",false);if(T){return an.data().close()}}else{if(w.is(".left-nav-dialog ul.tag-list label")){L=w.attr("for");return $("#"+L).data("wasLabelClicked",true)}else{if(w.is("a.delete-folder")){A=w.parents("div.book-section-right").find("a.coursename");s=A.data().uri;ae=_.detect(z.data().classmaterials,function(ap){return ap.uri===s});u=z.data().membership;ac=w.data().tag.toString();ae.tags=_.reject(ae.tags,function(ap){ap=ap.toString();return ap.toLowerCase()===ac.toLowerCase()});courseload.api.removeTag(ae,ac);d(ae,u);return courseload.nav.resize()}else{if(w.is('a[href="/nav/select_term/"]')||w.parent().is('a[href="/nav/select_term/"]')){U=$(".nav-top > .selectTerms");if(U.length){U.remove();return}ah=$("#navCourseSelectionTemplate").tmpl(courseload.data.nav).insertAfter(w.closest(".nav-header"));E=ah.closest(".nav");I=E.find(".nav-top").height();W=E.find("#term-selection").height();x=E.find(".nav-footer").height();af=I-W-x;Z=ah.find(".overview").height();t=af<Z?af:Z;ah.find(".viewport").height(t);ah.find(".scroll").addClass("tinyscrollbar").tinyscrollbar({sizethumb:"auto",size:"auto"});return ah.bind("click",function(ap){var aq,ar;ap.preventDefault();w=$(ap.target);if(w.is("a")){aq=courseload.data.nav;ar=w.attr("href");Q=_.detect(aq.terms,function(at){return at.uri===ar});$(this).remove();return courseload.nav.updatehash([""+Q.short_id])}})}else{if(w.is("a")&&w.attr("href")==="/nav/course_listing/"){Q=z.data("term");return courseload.nav.updatehash([""+Q.short_id])}else{if(w.is("a")&&((C=w.attr("href"))==="/nav/notes/"||C==="/nav/bookmarks/"||C==="/nav/chapters/")){N=w.attr("href");w.parents(".tabs").find("a.active").removeClass("active");w.addClass("active");switch(N){case"/nav/notes/":z.find(".overview > .toc, .overview > .bookmark").hide();z.find(".overview > .notes").show();a(z);return courseload.nav.clearhash();case"/nav/bookmarks/":z.find(".overview > .toc, .overview > .notes").hide();z.find(".overview > .bookmark").show();return a(z);case"/nav/chapters/":z.find(".overview > .toc").show();z.find(".overview > .bookmark, .overview > .notes").hide();return a(z)}}else{if(w.is("a.allnotes")){if(!$(".page:first").hasClass("additionalresources")){return r=courseload.book.page.notesview()}else{r=courseload.book.page.notesview();r.addClass("additionalresources");return r.find("#show-from-me").prop("disabled","disabled")}}else{if(w.is("a.returntobook")||w.parent().is("a.returntobook")){v=$("div.tabs");v.find("a.active").removeClass("active");v.find("li.first a").addClass("active");if(!$(".page").data().hasOwnProperty("pageIndex")){courseload.book.page.gotoPage()}z.find(".overview > .toc").show();z.find(".overview > .bookmark").hide();return a(z)}else{if(w.is("a.classmateriallink")||w.is("a.classmateriallink *")){if(!w.is("a.classmateriallink")){w=w.parents("a.classmateriallink:first")}ad=z.data();Q=ad.term;u=ad.membership;if(ad.classmaterial){X=ad.classmaterial}else{al=ad.classmaterials;X=_.detect(al,function(ap){return ap.uri===w.data("uri")})}return courseload.nav.updatehash([""+X.short_id])}else{if(w.is("a.taglink")){ad=z.data();Q=ad.term;u=ad.membership;ac=w.data("tag")?w.data("tag"):"";courseload.nav.ui.tagDetail(Q,u,ac);return courseload.nav.clearhash()}}}}}}}}}}}}}}}}}}}}}}});courseload.nav.refresh=function(){var t,s,r;t=$(".nav-content-wrapper:visible");if(t.hasClass("classmaterials")){s=$("#main > .nav.open").data();if(!t.data().tag){return courseload.nav.ui.courseDetail(s.term,s.membership)}else{r=t.data().tag!=="All Resources"?t.data().tag:"";return courseload.nav.ui.tagDetail(s.term,s.membership,r)}}else{if(t.hasClass("additionalresources")){return courseload.nav.ui.additionalResources()}else{if($('%s:has(".book-details")',t)){s=$("#main > .nav.open").data();return courseload.nav.ui.bookDetail(s.term,s.membership,s.classmaterial)}}}};d=function(t,r){var u,s;u=$("div.book-section-right a.coursename[data-uri='"+t.uri+"']").parent();u.find("span.folder-reference-tag").remove();s=$("#tagBarTemplate").tmpl({material:t,section:r.section,membership:r}).appendTo(u);return s.find("a.delete-folder").data("material",t)};courseload.nav.clearhash=function(){return location.hash=""};courseload.nav.updatehash=function(w){var v,t,u,s,r;t="";if($.isArray(w)){for(s=0,r=w.length;s<r;s++){u=w[s];t+=""+u+","}}if(t.length>0){t=t.substring(0,t.length-1);if(location.hash.length>0){v=location.hash.substring(1)}if(t!==v){location.hash=t;if(!h){return $(window).trigger("hashupdated")}}}};courseload.nav.getFlattenedModels=function(){var w,s,v,y,z,r,t,x,u;r=courseload.data.nav;u=r.terms;z=_.flatten(_.pluck(u,"memberships"));x=_.pluck(z,"section");s=_.flatten(_.pluck(x,"assignments"));w=_.flatten(_.pluck(s,"items"));y=_.flatten(courseload.data.classmaterials.classmaterials);t=_.flatten(courseload.data.resources);v=_.union(u,x,w,y,t);return v};courseload.nav.evaluateHash=function(){var A,C,B,v,u,y,t,z,x,w,D,s,r;if(location.hash.length>1){A=location.hash;y=A.substring(1).split(",");switch(y.length){case 1:u=y[0];B=courseload.models.getModelByShortId(u);if(B&&B.paint){return B.paint()}break;case 2:if(A.indexOf("material/")>=0&&A.indexOf("index/")>=0){for(z=0,D=y.length;z<D;z++){u=y[z];if(u.indexOf("material/")===0){C=courseload.models.getModelByShortId(u)}else{if(u.indexOf("index/")===0){v=u.substring("index/".length)}}}if(C&&C.paint){C.paint(v)}}if(A.indexOf("resource/")>=0&&A.indexOf("index/")>=0){for(x=0,s=y.length;x<s;x++){u=y[x];if(u.indexOf("resource/")===0){C=courseload.models.getModelByShortId(u)}else{if(u.indexOf("index/")===0){v=u.substring("index/".length)}}}if(C&&C.paint){C.paint(v)}}if(A.indexOf("material/")>=0&&A.indexOf("task/")>=0){for(w=0,r=y.length;w<r;w++){u=y[w];if(u.indexOf("material/")===0){C=courseload.models.getModelByShortId(u)}else{if(u.indexOf("task/")===0){t=courseload.models.getModelByShortId(u)}}}if(C&&t&&t.paint){return t.paint(C)}}}}};$(window).bind("hashchange hashupdated",function(r){return courseload.nav.evaluateHash()});$(function(){var s,r;$(document).bind("userloggedin",function(u,t){return $.when(courseload.api.getnav(t),courseload.api.getclassmaterials(t),courseload.api.getuserresources()).done(function(x,w,y){var v,z;z=courseload.data.nav=x;v=courseload.data.classmaterials=w;courseload.data.resources=y;courseload.data.flattened_models=courseload.nav.getFlattenedModels();courseload.nav.evaluateHash();if(!$("#main > .nav").length&&!courseload.data.classmaterial){s()}return courseload.api.getinstructorcourses().done(function(A){return courseload.data.instructorcourses=A})})});s=function(){var t,u;t=r(courseload.data.nav.terms);courseload.nav.ui.courseListing(t);u=""+t.term+" Courses";return courseload.nav.updateBrowserTitle(u)};r=function(w){var y,v,u,x,t;u=Date.today();for(x=0,t=w.length;x<t;x++){v=w[x];v.ticks=u-Date.parse(v.start_date)}y=function(z){if(z.ticks>=0){return z.ticks}};v=_.min(w,y);if(!v){y=function(z){return z.ticks};v=_.max(w,y)}return v};$(".chapterLink").live("click",function(t){return courseload.book.page.gotoPage($(this).data("page"))});return $("#main").live("resized",function(t){return courseload.nav.resize()})})}).call(this);(function(){namespace("courseload.upload");courseload.upload.intervalId;courseload.upload.enabled=function(){var b,a;b=$('<input type="file" />');a=!b[0].disabled;b.remove();return a};courseload.upload.dialogSettings=function(){return{overlayColor:"#000",margin:30,padding:0,onComplete:courseload.upload.dialogInit,onStart:courseload.upload.dialogStart}};courseload.upload.dialogStart=function(){if(!courseload.data.instructorcourses||courseload.data.instructorcourses.length===0){$("#externalLinkTab").hide();return $("#importTab").hide()}else{$("#externalLinkTab").show();return $("#importTab").show()}};courseload.upload.dialogInit=function(){var g,d,a,f,c,e,b;courseload["import"].dialogInit();$("#uploadTab").click();$("#uploadForm")[0].reset();$("#uploadInput").focus();$("#externalTitle").val("");$("#externalUrl").val("");$("#externalDescription").val("");$("#externalEmbed").val("");$("#externalTermsOfService").prop("checked",false);$("div.modal-content div.important div.cert-right label").text("I certify that I have the right to distribute this information and that it does not violate the Courseload or "+courseload.data.customer.name+" ").append("<a id='tosLink' href='"+courseload.data.customer.eula+"' target='_blank'>Terms of Service.</a>");g=$("#uploadForm #uploadCourseContainer");d=$("#externalLinkContainer #externalLinkCourseContainer");if(courseload.data.instructorcourses&&courseload.data.instructorcourses.length>0){$("#uploadForm #uploadCourseListHeader").attr("aria-hidden","false").removeClass("hide");d.empty().append("<p><label for='linkToAllCourses'><input type='checkbox' name='linkToAllCourses' id='linkToAllCourses' value='' class='assign-list allcourses' />All current courses</label></p>");$("#uploadForm #uploadCourseListHeader").show();g.empty().show().append("<p><label for='uploadToResources'><input type='checkbox' name='uploadToResources' id='uploadToResources' value='' class='assign-list' />"+(courseload.possessify(courseload.data.user.name))+" Private Content</label></p>").append("<p><label for='uploadToAllCourses'><input type='checkbox' name='uploadToAllCourses' id='uploadToAllCourses' value='' class='assign-list allcourses' />All current courses</label></p>");e=courseload.data.instructorcourses;b=[];for(f=0,c=e.length;f<c;f++){a=e[f];g.append("<p><label for='"+a.id+"'><input type='checkbox' id='"+a.id+"' name='course' value='' class='assign-list' />"+a.title+" ("+a.term+")</label></p>");b.push(d.append("<p><label for='"+a.id+"'><input type='checkbox' id='"+a.id+"' name='course' value='' class='assign-list' />"+a.title+" ("+a.term+")</label></p>"))}return b}};$("#uploadCourseContainer p input[type=checkbox],#externalLinkCourseContainer p input[type=checkbox]").live("click",function(b){var a;a=$(this);switch(a.attr("name")){case"course":return $(".allcourses").prop("checked",false)}});$(document).on("click","button#addDocument",function(d){var b,a,f,c;if(courseload.upload.validateFileType()){f=$("#uploadInput").val();if(f.indexOf("'")!==-1||f.indexOf('"')!==-1){alert("Filenames with quotation marks are not supported. Please rename your file and try again.");return}a=$("#uploadTitle");a.val($.trim(a.val()));if(a.val()===""){a.focus();alert("Please include a title for this resource.");return}if(!$("#termsOfService").is(":checked")){$("#termsOfService").focus();alert("Please agree to the Terms of Service before uploading a resource.");return}$("#termsOfService").val(true);$("#csrfmiddlewaretoken").val(courseload.data.csrftoken);$("#apply_to_courses").val("");if(courseload.data.instructorcourses&&courseload.data.instructorcourses.length>0){if($("#uploadCourseContainer p input[type=checkbox]:checked").length===0){alert("Please assign this resource to one or more areas before uploading.");return}if($("#uploadToResources").prop("checked")===true){$("#apply_to_resources").val("true")}c=[];if($("#uploadToAllCourses").prop("checked")===true){$('#uploadCourseContainer p input[name="course"]').each(function(e){return c.push($(this).attr("id"))})}else{$('#uploadCourseContainer p input[name="course"]').each(function(e){if($(this).prop("checked")){return c.push($(this).attr("id"))}})}$("#apply_to_courses").val(c.join(","))}else{$("#apply_to_resources").val("true")}$("#uploadTarget").remove();$("#uploadContainer").append('<iframe id="uploadTarget" name="uploadTarget" src="javascript:false;" style="display:none;"></iframe>');$("#uploadForm").attr("target","uploadTarget").attr("action","/api/upload/").submit();$("#fancybox-wrap").css("left","-5000px");$("#fancybox-overlay").hide();$("a#upload.upload").hide();b=$(".nav-footer.upload:visible");if(b.find("#uploadProgress").length===0){b.append('<span id="uploadProgress">Processing...</span>')}else{b.find("#uploadProgress").text("Processing...")}courseload.upload.intervalId=setInterval(courseload.upload.getResponse,1500);return $("#uploadForm")[0].reset()}else{return alert("Please select a valid resource to upload before continuing.")}});courseload.upload.getResponse=function(){var a,e,b,d;b=$("#uploadTarget")[0];if(!b.parentNode){return}if(b.contentDocument&&b.contentDocument.body&&b.contentDocument.body.innerHTML===""){return}e=b.contentDocument?b.contentDocument:b.contentWindow.document;if(!e.body){return}try{d=$.parseJSON($(e.body).text());if(d&&d.href){clearInterval(courseload.upload.intervalId);return courseload.api.polljob(d,function(f){courseload.upload.refreshNav();return courseload.upload.updateStatus(f)})}}catch(c){clearInterval(courseload.upload.intervalId);$.fancybox.close();alert("Error, please try uploading again");a=$(".nav-footer.upload:visible");a.find("#uploadProgress").text("");return $("a#upload.upload").show()}};courseload.upload.updateStatus=function(c){var b,d,a;a=c?c.status:"failed";b=$(".nav-footer.upload:visible");d=b.find("#uploadProgress");switch(a){case"waiting":case"inprogress":return d.text("Processing...");case"failed":case"timeout":$.fancybox.close();alert("Error, please try uploading again");d.text("");return $("a#upload.upload").show();case"complete":$.fancybox.close();courseload.upload.jobcomplete();d.text("Upload complete");return _.delay((function(){d.text("");return $("a#upload.upload").show()}),3000)}};courseload.upload.jobcomplete=function(){return courseload.upload.refreshNav()};courseload.upload.refreshNav=function(){var a;a=courseload.data.user;return $.when(courseload.api.getclassmaterials(a),courseload.api.getuserresources()).done(function(b,d){var c;courseload.data.classmaterials=b;c=courseload.data.resources=d;courseload.data.flattened_models=courseload.nav.getFlattenedModels();return courseload.nav.refresh()})};courseload.upload.validateFileType=function(){var e,b,d,a,c;e=$("#uploadInput").val();if(!(e!=null)){return false}e=e.toLowerCase();c=[".pdf",".doc",".docx",".txt",".ppt",".html",".htm",".odt",".xls",".xlsb",".ods",".ppt",".pptx",".odp"];for(d=0,a=c.length;d<a;d++){b=c[d];if(e.substring(e.length-b.length)===b){return true}}return false}}).call(this);(function(){namespace("courseload.externallink");$("div.modal-stats-tab-bar a").live("click",function(b){var a;b.preventDefault();$("div#modalresource div, div#modalresource footer").removeClass("show");$("ul.stats-tabs li").removeClass("current");a=$(b.target);switch(a.attr("href")){case"#externalLink":$("#externalLinkContainer").addClass("show");$("#externalLinkFooter").addClass("show");break;case"#importLink":$("#importContainer").addClass("show");$("#importFooter").addClass("show");break;default:$("#uploadContainer").addClass("show");$("#uploadFooter").addClass("show")}return a.parent().addClass("current")});$("button#addExternalLink").live("click",function(c){var b,a,d;$("#externalTitle").val($.trim($("#externalTitle").val()));if(!$("#externalTitle").val()||$("#externalTitle").val()===""){$("#externalTitle").focus();alert("Please include a title for this external link.");return}a=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi;$("#externalUrl").val($.trim($("#externalUrl").val()));if(!$("#externalUrl").val()||$("#externalUrl").val()===""){$("#externalUrl").focus();alert("Please include a url for this external link.");return}if(a.test($("#externalUrl").val())){alert("Please remove all script tags from the url entered.");$("#externalUrl").focus();return}if(a.test($("#externalEmbed").val())){alert("Please remove all script tags from the embed code entered.");$("#externalEmbed").focus();return}$("#apply_to_sections").val("");if(courseload.data.instructorcourses&&courseload.data.instructorcourses.length>0){if($("#externalLinkContainer p input[type=checkbox]:checked").length===0){alert("Please assign this resource to one or more courses before continuing.");return}b={};b.title=$("#externalTitle").val();b.url=$("#externalUrl").val();b.description=$("#externalDescription").val();b.embed=$("#externalEmbed").val();d=[];if($("#linkToAllCourses").prop("checked")===true){$('#externalLinkContainer p input[name="course"]').each(function(e){return d.push($(this).attr("id"))})}else{$('#externalLinkContainer p input[name="course"]').each(function(e){if($(this).prop("checked")){return d.push($(this).attr("id"))}})}b.sections=d.join(",");$.when(courseload.api.saveexternallink(b)).done(function(){return courseload.upload.refreshNav()}).fail(function(){return alert("There was an error adding your external link. Please make sure you are an instructor or administrator for each course selected.")})}return $.fancybox.close()})}).call(this);(function(){var a,c,b;namespace("courseload.externallink.ui");namespace("courseload.externallink.ui.blti");courseload.externallink.ui.load=function(){b();return courseload.externallink.ui.resize()};courseload.externallink.ui.blti.load=function(d){b();return a(d)};$(".externallinkcontainer").live("resized",function(){if(courseload.data.classmaterial.lti_provider===""){return courseload.externallink.ui.resize()}else{return courseload.externallink.ui.blti.resize()}});courseload.externallink.ui.resize=function(){var d,e;e=c();d=$(".externallink");$(".externallinkcontainer").css("left",e.navWidth).css("position","relative").css("z-index","10");return $(".externallink").css("position","absolute").css("z-index","11").css("top",(e.windowHeight/2)-(d.outerHeight(true)/2)-e.headerHeight-e.marginHeight).css("left",(e.windowWidth-e.navWidth)/2-(d.outerWidth(true)/2))};courseload.externallink.ui.blti.resize=function(){var d,e;e=c();d=$(".externallink");$(".externallinkcontainer").css("left",e.navWidth).css("position","relative").css("z-index","10");$(".externallink").css("position","absolute").css("z-index","11").css("top",e.marginHeight).css("width",e.maxWidth).css("height",e.maxHeight-e.marginHeight);return $(".externallink iframe").css("width",e.maxWidth).css("height",e.maxHeight-e.marginHeight)};b=function(){var d;d=$("#main");d.find("div.page").remove();d.find("div.externallinkcontainer").remove();$(".forBook").remove();return $("#externalLinkTemplate").tmpl({classmaterial:courseload.data.classmaterial}).appendTo(d)};c=function(){var f,d,g,e;e={};g=$(window);f=$("#main");d=f.find(".nav");e.marginHeight=20;e.marginWidth=20;e.headerHeight=$("div.menu:visible").outerHeight(true);e.navWidth=d.width();e.windowWidth=g.width();e.windowHeight=g.height();e.maxWidth=e.windowWidth-e.navWidth-e.marginWidth;e.maxHeight=e.windowHeight-e.headerHeight-e.marginHeight;return e};a=function(d){return courseload.api.getbltilaunchparams(d).done(function(h){var f,g,e;e=$("div.externallink iframe");f=$.extend({},e);f.attr({id:"blti_frame",name:"blti_frame"});$("div.externallink").remove("iframe").append(f);courseload.externallink.ui.blti.resize();$("#blti_post_form").remove();g=$("<form>");g.attr({id:"blti_post_form",target:"blti_frame",method:"POST",enctype:"application/x-www-form-urlencoded",action:h.launch_url});delete h.launch_url;$.each(h,function(i,j){var k;k=$('<input type="hidden">');return k.attr({name:i,value:j}).appendTo(g)});return g.appendTo("body").submit().remove()})}}).call(this);(function(){var f,e,g,c,b,d=[].indexOf||function(k){for(var j=0,h=this.length;j<h;j++){if(j in this&&this[j]===k){return j}}return -1},a={}.hasOwnProperty;namespace("courseload.import");f=function(h){if(h==null){h=true}return $("#importContainer").find(".copyFromSectionList").prop("disabled",!h).empty()};e=function(h){if(h==null){h=true}$("#importContainer").find('input[type="checkbox"]').prop("disabled",!h).prop("checked",false);if(!h){$("#importContainer .uploadAndLinkCount").empty().parent();return $("#importContainer .myNotesCount").empty()}};g=function(h){if(h==null){h=true}return $("#importContainer").find(".copyToTermList").prop("disabled",!h).empty()};c=function(h){var i;if(h==null){h=true}i=$("#importContainer").find(".multi-course").empty();if(h){return $("#copyToSectionList").show()}else{return $("#copyToSectionList").hide()}};b=function(){var I,E,B,s,K,J,l,n,C,A,H,L,v,o,h,F,k,q,m,z,y,p,r,w,t,D,u,j,G,i;K=$("#importNotes").prop("checked");s=$("#importUploadsAndLinks").prop("checked");J=$("#importTags").prop("checked");B=$("#importContainer .multi-course .multi-line");i=[];for(j=0,G=B.length;j<G;j++){v=B[j];E=$(v);if(!E.data().import_data){continue}if(E.find("input").length===0){continue}q=E.data().section;C=$("#copyFromSectionList option:selected").data("import_data");H=E.data().import_data;r=[];if(courseload.data.classmaterials.classmaterials.hasOwnProperty(q.uri)){r=(function(){var N,x,O,M;O=courseload.data.classmaterials.classmaterials[q.uri];M=[];for(N=0,x=O.length;N<x;N++){u=O[N];M.push(u.slug)}return M})()}t=(function(){var N,x,O,M;O=C.upload;M=[];for(N=0,x=O.length;N<x;N++){u=O[N];if(d.call(r,u)<0){M.push(u)}}return M})();o=(function(){var N,x,O,M;O=C.link;M=[];for(N=0,x=O.length;N<x;N++){u=O[N];if(d.call(r,u)<0){M.push(u)}}return M})();h=t.length+o.length;y=[];if(s){y.push(""+h+" "+(courseload.pluralize(h,"material","materials"))+" will be added")}if(K){F=0;k=0;l=C.markup;p=H.markup;for(L in l){if(!a.call(l,L)){continue}D=l[L];if(p.hasOwnProperty(L)){k+=p[L];F+=D}else{if(d.call(r,L)>=0||d.call(t,L)>=0){F+=D}}}y.push(""+F+" "+(courseload.pluralize(F,"note","notes"))+" will be added");if(k){y.push(""+k+" "+(courseload.pluralize(k,"note","notes"))+" will be removed")}}if(J){A=$("#copyFromSectionList option:selected").data("section");n=A.tags;w=q.tags;z=_.union(n,w);m=z.length-w.length;y.push(""+m+" "+(courseload.pluralize(m,"stack","stacks"))+" will be added")}I=E.find("label");if(I.find(".importStatus").length){I.find(".importStatus").text(y.join(", "))}else{I.append("<span> &ndash; </span>").append("<span class='importStatus'>"+(y.join(", "))+"</span>")}if(K&&k){i.push(E.find(".importStatus").addClass("replaced"))}else{i.push(E.find(".importStatus").removeClass("replaced"))}}return i};courseload["import"].dialogInit=function(){var m,j,l,i,k,h;$("#importContainer .error-required").removeClass("error-required");f(false);e(false);g(false);c(false);m=$("#importContainer").find(".copyFromTermList");m.empty().append("<option disabled selected role='option'>Select a term...</option>");k=_.sortBy(courseload.data.nav.terms,function(n){return new Date(n.start_date)});h=[];for(l=0,i=k.length;l<i;l++){j=k[l];m.append("<option value='"+j.uri+"' role='option'>"+j.term+"</option>");h.push(m.find("option:last").data("term",j))}return h};$(document).on("click",'#importContainer input[type="checkbox"]',function(h){return b()});$(document).on("change","#importContainer .copyFromTermList",function(l){var h,q,o,p,i,n,k,m,j;f(true);e(false);g(false);c(false);i=$(l.target).find("option:selected").data().term;p=(function(){var u,s,t,r;t=i.memberships;r=[];for(u=0,s=t.length;u<s;u++){n=t[u];if(n.role==="instructor"){r.push(n.section)}}return r})();h=$("#importContainer").find(".copyFromSectionList");h.empty().append('<option disabled selected role="option">Select a course...</option>');j=[];for(k=0,m=p.length;k<m;k++){o=p[k];q="<option value='"+o.uri+"'' role='option'>			"+o.subject+" "+o.catalog_number+" "+o.class_number+"			</option>";h.append(q);j.push(h.find("option:last").data("section",o))}return j});$(document).on("change","#importContainer .copyFromSectionList",function(o){var m,n,q,l,s,h,r,j,p,k,i;e(true);g(true);c(false);n=$("#importContainer");n.find("input.copy-check").prop("disabled",false);s=$(".copyFromSectionList option:selected").data().section;courseload.api.copysectioncounts(s).success(function(w){var t,x,v,u;$(".copyFromSectionList option:selected").data("import_data",w);x=0;u=w.markup;for(t in u){if(!a.call(u,t)){continue}v=u[t];x+=v}return n.find(".uploadAndLinkCount").text("("+(w.link.length+w.upload.length)+")").end().find(".myNotesCount").text("("+x+")").end().find(".tagsCount").text("("+w.tags.length+")")});m=n.find(".copyToTermList");m.empty().append('<option disabled selected role="option">Select a term...</option>');q=n.find(".copyFromTermList option:selected").data().term;l=(function(){var w,u,v,t;v=courseload.data.nav.terms;t=[];for(w=0,u=v.length;w<u;w++){r=v[w];if(new Date(r.start_date)>=new Date(q.start_date)){t.push(r)}}return t})();k=_.sortBy(l,function(t){return new Date(t.start_date)});i=[];for(j=0,p=k.length;j<p;j++){h=k[j];m.append("<option value='"+h.uri+"'' role='option'>"+h.term+"</option>");i.push(m.find("option:last").data("term",h))}return i});$(document).on("change","#importContainer .copyToTermList",function(k){var s,q,l,p,o,r,h,n,j,m,i;c(true);l=$(".copyFromSectionList option:selected").data().section;h=$(k.target).find("option:selected").data().term;r=(function(){var w,u,v,t;v=h.memberships;t=[];for(w=0,u=v.length;w<u;w++){n=v[w];if(n.role==="instructor"){t.push(n.section)}}return t})();s=$("#importContainer").find(".multi-course");s.empty();i=[];for(j=0,m=r.length;j<m;j++){o=r[j];if(o.uri===l.uri){continue}p="<div class='multi-line'>		<input type='checkbox' id='"+o.subject+o.catalog_number+o.class_number+"'>		<label for='"+o.subject+o.catalog_number+o.class_number+"'>		<span class='multi-coursename'>"+o.subject+" "+o.catalog_number+" "+o.class_number+"</span>		</label></div>";q=$(p).appendTo(s).data("section",o);i.push((function(u,t){return courseload.api.copysectioncounts(u).success(function(v){t.data("import_data",v);return b()})})(o,q))}return i});$(document).on("click","#importLink",function(q){var j,u,r,n,o,h,p,m,i,t,l,s,k;$("#importContainer .error-required").removeClass("error-required");$("#importContainer .replaced").removeClass("replaced");n=$("#copyFromTermList option:selected");if(!n.length||n.prop("disabled")){$('#importContainer label[for="copyFromTermList"]').addClass("error-required");$("#copyFromTermList").addClass("error-required");return}r=$("#copyFromSectionList option:selected");if(!r.length||r.prop("disabled")){$('#importContainer label[for="copyFromSectionList"]').addClass("error-required");$("#copyFromSectionList").addClass("error-required");return}h=$("#importNotes").prop("checked");o=$("#importUploadsAndLinks").prop("checked");p=$("#importTags").prop("checked");if(!h&&!o){$("#importItemSelection label").addClass("error-required");return}t=$("#copyToTermList option:selected");if(!t.length||t.prop("disabled")){$('#importContainer label[for="copyToTermList"]').addClass("error-required");$("#copyToTermList").addClass("error-required");return}i=$("#copyToSectionList input:checked");if(!i.length){$("#copyToSectionList label").addClass("error-required");return}r=$(".copyFromSectionList option:selected").data().section;u=$("#importContainer .multi-course .multi-line");k=[];for(l=0,s=u.length;l<s;l++){m=u[l];j=$(m);if(!j.find("input").prop("checked")){continue}j.find("input").remove();j.find("label").addClass("import-in-progress");j.find("span.importStatus").text("importing...");m=j.data().section;k.push((function(v,x){var w;w={copy_to:v.uri,include_class_materials:o,include_markups:h,include_tags:p};return courseload.api.copysection(r,w).success(function(y){courseload.api.getclassmaterials(courseload.data.user).done(function(A){var z;return z=courseload.data.classmaterials=A});if(p){courseload.api.getnav(courseload.data.user).done(function(C){var z,B,A;courseload.data.nav=C;courseload.data.flattened_models=courseload.nav.getFlattenedModels();z=$("#main > .nav");B=z.data().term;A=_.detect(courseload.data.nav.terms,function(D){return D.uri===B.uri});return z.data("term",A)})}x.find("span.importStatus").text("import complete");return x.find("label").removeClass("import-in-progress").addClass("import-complete")})})(m,j))}return k})}).call(this);(function(){var a;namespace("courseload.search");$(function(){var b;b=$("#search-input");if(!Modernizr.input.placeholder){b.val(b.attr("placeholder"));b.bind("focus",function(d){var c;c=$(this);if(c.val()===c.attr("placeholder")){return c.val("")}});return b.bind("blur",function(d){var c;c=$(this);if(c.val()===""){return c.val(c.attr("placeholder"))}})}});$("#main").live("click",function(b){$(".search .search-all .highlight.search-results").hide();return $(".searchterm").remove()});$(".searchResults .nav-section").live("click",function(d){var f,c,b;if($('div#search-result-navigation li[id*="Tab"] a.active').data("tab")!=="#moreTab"){d.preventDefault();f=$(this);c=f.data("match");b=function(){var e,g;e=$(".page");if(f.hasClass("documentTab")){g=courseload.search.getMatchingTerms(c);return courseload.search.highlightMatchingTerms(e,g)}};if(c.page===courseload.data.book.currentPage){return b()}else{courseload.book.page.gotoPage(c.page);return $("body").one("page_rendered",".page",function(g){return b()})}}});$(".more button.moreButton").live("click",function(g){var f,d,c,b;b=$('div#search-result-navigation li[id*="Tab"] a.active').data("tab");d=$(b);f=$(this).parent();c=f.position().top;f.remove();return courseload.search.loadResults(d,c)});courseload.search.getMatchingTerms=function(c){var e,d,f,b;f=$("#search-input").val().toLowerCase().split(/\s+/);e=new RegExp("<em>(.+?)</em>","gi");while((b=e.exec(c.match))!==null){d=b[1];f.push(d.toLowerCase())}return _.uniq(f)};courseload.search.resize=function(){var b;b=$(".highlight.search-results");if(b.length===0){return}return a(b)};a=function(c,e){var f,b,g,d;d=$("div.menu").outerHeight(true)+$(".highlight-header").outerHeight(true)+$(".highlight.search-results #search-result-navigation").outerHeight(true);g=$(".footer.tracker").outerHeight(true);b=$(window).height()-d-g-3;$(".viewport.topsearchscroll").height(_.min([b,$(".result-list").outerHeight(true)]));f=c.find(".scroll");if(f.hasClass("tinyscrollbar")){if(e!=null){return f.tinyscrollbar_update("relative")}else{return f.tinyscrollbar_update()}}else{return f.addClass("tinyscrollbar").tinyscrollbar({sizethumb:"auto",size:"auto"})}};courseload.search.show=function(c,d){var b;$(".search-all").remove();b=$("#searchResultsTemplate").tmpl().appendTo("div.search");$("#documentTab").data({loader:courseload.search.loadDocumentResults,searcher:c});$("#notesTab").data({loader:courseload.search.loadNoteResults,searcher:d});return courseload.search.activateTab($("#documentTab"))};courseload.search.activateTab=function(c){var d,j,k,i,g,f,b,e,h;j=$(c);b=j.attr("id");$(".result-list li.nav-section, .result-list div.more").hide();$(".result-list li.nav-section."+b).show();$(".result-list div.more."+b).show();if(b!=="moreTab"&&j.hasClass("loading")){courseload.search.loadResults(j)}if(b==="moreTab"){j.find(".more").remove();$(".search-all .result-list").find(".nav-section.moreTab").remove();j.removeClass("loading loadingMore");k=[];f=encodeURIComponent($.trim($("#search-input").val()));i="/media/images/icons/";k.push({img:""+i+"google32.png",url:"http://google.com/search?q="+f,name:"Google"});k.push({img:""+i+"dictionary32.png",url:"http://dictionary.reference.com/browse/"+f,name:"Dictionary"});k.push({img:""+i+"google_translate32.png",url:"http://translate.google.com/translate_t?hl=en&q="+f,name:"Google Translate"});k.push({img:""+i+"wikipedia32.png",url:"http://en.wikipedia.org/wiki/Special:Search?search="+f,name:"Wikipedia"});k.push({img:""+i+"youtube32.png",url:"http://www.youtube.com/results?search_query="+f,name:"YouTube"});for(e=0,h=k.length;e<h;e++){g=k[e];$("#searchResourcesTemplate").tmpl(g).addClass("moreTab").appendTo($(".result-list ul"))}}d=$(".highlight.search-results");return a(d)};courseload.search.loadResults=function(d,b){var c;c=d.data("searcher");return c.next(5,function(h){var f,e,l,m,i,k,g,j;d.removeClass("loading loadingMore");i=[];for(g=0,j=h.length;g<j;g++){l=h[g];e={match:l.match,page:l.page};m=$("#searchResultTemplate").tmpl(e).appendTo($(".result-list ul")).data("match",l).addClass(d.attr("id"))}if(c.hasMore()){$("#moreButtonTemplate").tmpl().addClass(d.attr("id")).appendTo($(".result-list"))}else{k=$(".result-list li.nav-section."+d.attr("id")).length?"No more results.":"No results.";$('<div class="more">').addClass(d.attr("id")).text(k).appendTo($(".result-list"))}f=$(".highlight.search-results");return a(f,b)})};courseload.search.clear=function(){$(".search-all").remove();return $("#search-input").val("")};$(function(){var b;$("#main").live("resized",function(){b();return courseload.search.resize()});$(".page").live("page_resized",function(){b();return courseload.search.resize()});b=function(){var c;c=$(".page").find("img.content");return $(".searchterm").each(function(h){var j,g,f,e,k,d,l;k=$(this).data("coordinates"),f=k[0],e=k[1],j=k[2],g=k[3];d=courseload.markup.scaleFromBase(c,[f,e]),f=d[0],e=d[1];l=courseload.markup.scaleFromBase(c,[j,g]),j=l[0],g=l[1];return $(this).css({top:e,left:f}).height(g-e).width(j-f)})};$('div#search-result-navigation li[id*="Tab"] a').live("click",function(c){c.preventDefault();$('div#search-result-navigation li[id*="Tab"] a.active').removeClass("active");$(this).addClass("active");return courseload.search.activateTab($(this).data("tab"))});$("#search-submit").live("click",function(c){$("#searchform").submit();return courseload.markup.clearDialogs()});$(".searchresults .contentsearch .loadmore").bind("click",function(c){});$(".searchresults .markupsearch .loadmore").bind("click",function(c){});return $("#searchform").live("submit",function(k){var j,d,c,i,g,l,f,h;k.preventDefault();d=$("#search-input");d.blur();$(".search-all").remove();$(".searchterm").remove();f=$.trim(d.val());if(f.length===0){return courseload.search.clear()}else{if(f==="mongoforce"){hotkeys.unleash();return}j=$(".page:first");l=j.data("pageIndex");c=courseload.data;h=c.manifest.slug;i=new courseload.api.SolrSearch(courseload.data.classmaterial.sectionId,h,f,l);g=new courseload.api.MarkupSearch(courseload.data.classmaterial.sectionId,h,f,l);return courseload.search.show(i,g)}})});namespace("courseload.util");courseload.util.when=function(g,f,c,b){var d,e;if(c==null){c=100}if(b==null){b=10000}d=0;e=function(){if(g()){return f()}else{if(d<b){window.setTimeout(e,c);return d+=c}}};return e()};courseload.search.highlightMatchingTerms=function(b,c){var e,d;b.data("searchterms",c);d=function(){var p,o,r,H,G,i,u,z,y,w,v,t,D,A,x,s,l,h,g,f,C,F,E,B,q,n,m,k,j;$(".searchterm").remove();s=b.data("words");i=[];for(l=0,C=s.length;l<C;l++){r=s[l];q=r.slice(1,r.length);for(h=0,F=q.length;h<F;h++){x=q[h];for(g=0,E=c.length;g<E;g++){t=c[g];u=new RegExp(t,"i");if(u.test(x[0])){i.push(x)}}}}p=b.find("img.content");o=b.find(".markupContainer");j=[];for(f=0,B=i.length;f<B;f++){n=i[f],x=n[0],D=n[1],A=n[2],H=n[3],G=n[4];m=courseload.markup.scaleFromBase(p,[D,A]),w=m[0],v=m[1];k=courseload.markup.scaleFromBase(p,[H,G]),z=k[0],y=k[1];j.push($('<div class="searchterm">').css({top:v,left:w}).height(y-v).width(z-w).data("coordinates",[D,A,H,G]).appendTo(o))}return j};e=function(){return b.data("words")};return courseload.util.when(e,d)}}).call(this);(function(){namespace("courseload.banner");courseload.banner.showReleaseNotesBanner=function(a){return courseload.api.getreleasenotesacknowledgement(courseload.data.customer).error(function(c,e,d){var b;b=$("#releaseNotesHeaderTemplate").tmpl().hide().prependTo(a);b.slideDown(900);$("div.releaseNotes-banner a.close").bind("click",function(f){f.preventDefault();return courseload.banner.acknowledgeReleaseNotes(courseload.data.customer)});return $("#releaseNotes").bind("click",function(f){return courseload.banner.acknowledgeReleaseNotes(courseload.data.customer)})}).success(function(b,d,c){})};courseload.banner.acknowledgeReleaseNotes=function(){courseload.api.markreleasenotesacknowledgement(courseload.data.customer);return $("div.releaseNotes-banner").remove()};courseload.banner.showOfflineBanner=function(b){var a;a=$("#offlineHeaderTemplate").tmpl().hide().prependTo(b);$("div.offline-banner a.close").bind("click",function(c){c.preventDefault();return $("div.offline-banner").remove()});return _.delay(function(){return a.slideDown(900)},1000)};courseload.banner.alertsMessage=function(g,e){var f,c,b,d,a;c=$("#alertsTemplate").tmpl().hide().prependTo(g);a=e.type?e.type:void 0;d=e.title?e.title:"";b=e.message?e.message:"";f=$("div.alerts-banner").addClass(a).css("cursor","pointer").find("h1").html(d).end().find(".message").html(b);c.slideDown(100);_.delay(function(){if(f.is("*")){return c.slideUp(900,function(){return f.remove()})}},5000);return $("div.alerts-banner *").on("click",function(h){h.preventDefault();return c.remove()})}}).call(this);(function(){var d,c,i,a,b,e,f,h,g;namespace("courseload.feedback");c=function(){$("#feedback_form textarea").val("");$("#feedback_form .error-messages").hide();a($("#send_feedback_form"));return f($("#container"))};e=function(){g();return d($("#container"))};h=function(){return $("#feedback_contact_approval").attr("checked",true)};g=function(){return $("#feedback_content").focus()};a=function(j){return j.attr("disabled",false).removeClass("disabled").text("Send feedback")};i=function(j){return j.attr("disabled",true).addClass("disabled").text("Sending...")};d=function(j){return j.attr("aria-hidden",true)};f=function(j){return j.removeAttr("aria-hidden")};b=function(j){if(j){return true}};courseload.feedback.init=function(){var j;j={overlayColor:"#000",margin:30,padding:0,onStart:h,onComplete:e,onClosed:c};return $("a#feedback").fancybox(j)};courseload.feedback.validate=function(m){var l,q,p,o,n,j,k;q=$("#feedback_form textarea");p=$("#feedback_form .error-messages");l=$("#feedback_contact_approval");if(!b(q.val())){p.show();q.one("keypress",function(r){return p.hide()});return g()}o=$("#send_feedback_form");i(o);k={feedback_text:q.val(),extra_context:{feedback_contact_approval:l.is(":checked"),customer:courseload.data.customer.name}};if(courseload.data.classmaterial){n=courseload.data;j=n.classmaterial;_.extend(k.extra_context,{section:j.section_uri,material_title:j.title,media_type:j.media_type,current_page:n.manifest.pages[n.book.currentPage].label,slug:j.slug,is_printing_allowed:j.is_printing_allowed,is_checked_out:j.is_checked_out})}return courseload.api_online.sendFeedback(JSON.stringify(k))};courseload.feedback.alert=function(j){var l,k;l=$("#container");if(j==="success"){k={type:"success",title:"Thank you!",message:"Your feedback has been sent."}}else{k={type:"error",title:"Service Unavailable",message:"This service is temporarily unavailable. Please try again later."}}courseload.banner.alertsMessage(l,k);return $.fancybox.close()};$(document).on("submit","#feedback_form",function(j){j.preventDefault();return courseload.feedback.validate(j)})}).call(this);(function(){var a,e,c,d,b=[].indexOf||function(h){for(var g=0,f=this.length;g<f;g++){if(g in this&&this[g]===h){return g}}return -1};namespace("courseload.login");namespace("courseload.data");namespace("courseload.forgot");a=420;courseload.login.has_perm=function(f,g){if(f.is_superuser){return true}return b.call(f.permissions,g)>=0};courseload.login.showeula=function(){var g,f;$("#container").remove();g=$("#eulaTemplate").tmpl({customer:courseload.data.customer}).prependTo("body");f=g.find("form.eulaForm");f.find("button.cancelButton").bind("click",courseload.login.logout);return f.bind("submit",courseload.login.eulaConsent)};courseload.login.showlogin=function(){var h,f,g;$("#container").remove();h=$("#loginTemplate").tmpl({customer:courseload.data.customer}).prependTo("body");f=h.find("form.login");f.bind("submit",courseload.login.login);g="Login";return courseload.nav.updateBrowserTitle(g)};courseload.login.eulaConsent=function(g){var f;g.preventDefault();f=$(g.target);f.removeClass("error");if(f.find("input.eulaConsent:checked").length){return courseload.api.consentToEula(courseload.data.customer,f.serialize()).done(function(){var h;h=courseload.api.getuser();return c(h)})}else{return f.addClass("error")}};courseload.login.login=function(h){var g,f,i;h.preventDefault();g=$(h.target);g.removeClass("error");i=g.find(".username").val();f=g.find(".password").val();return courseload.api.login(i,f).fail(function(j,l,k){if(j.status===a){return courseload.login.showeula()}else{return g.addClass("error")}}).done(function(j){courseload.data.user=j;$("#container").remove();return $(document).trigger("userintercept",[courseload.data.user])})};courseload.login.logout=function(g){var f;f="Are you sure you want to logout?\n\nYou have items checked out. If you logout, these items will be checked in and you will lose changes that have not been synchronized.\n\nClick OK to logout, or Cancel to stay on this page.";if(window.localStorage&&localStorage.checkout){if(!confirm(f)){return false}}if(window.localStorage){localStorage.clear()}if(window.sessionStorage){return sessionStorage.clear()}};courseload.forgot.showforgot=function(){var g,f;d();$("#container").remove();g=$("#forgotPasswordTemplate").tmpl().prependTo("body");f=g.find("form.forgot");return f.bind("submit",courseload.forgot.submit)};courseload.forgot.submit=function(h){var f,g;h.preventDefault();f=$("form.forgot");f.removeClass("error");g=f.find(".email").val();if(!g.match(/^\S+@\S+\.\S+$/)){f.addClass("error");alert("Please enter a valid email address.");return}f.unbind().bind("submit",function(){});return courseload.api.forgotpassword(g).fail(function(i,k,j){if(i.status===404){alert("Unable to locate an account with that address. Please try again.")}return f.addClass("error").unbind().bind("submit",courseload.forgot.submit)}).done(function(){return courseload.forgot.emailsent()})};courseload.forgot.emailsent=function(){$("#container").remove();return $("#forgotPasswordEmailSentTemplate").tmpl().prependTo("body")};courseload.forgot.showreset=function(){var g,f;$("#container").remove();g=$("#resetPasswordTemplate").tmpl().prependTo("body");f=g.find("form.reset");return f.bind("submit",courseload.forgot.reset)};courseload.forgot.showinvalidtoken=function(f){$("#container").remove();return $("#invalidTokenTemplate").tmpl({message:f}).prependTo("body")};courseload.forgot.reset=function(k){var j,f,g,h,i;k.preventDefault();i=getUrlParams();if(i.prtoken){h=i.prtoken}else{alert("Your password reset token seems to be missing.");return false}j=$("form.reset");j.removeClass("error");g=j.find(".password").val().trim();f=j.find(".confirmpassword").val().trim();if(g.length<8||g!==f){j.addClass("error").find(".password").focus().select();alert("Please ensure your password is at least 8 characters in length and matches the confirmation password.");return false}j.unbind().bind("submit",function(){});return courseload.api.resetpassword(h,g).fail(function(l,n,m){if(l.status===a){d();return courseload.login.showeula()}else{return j.addClass("error").unbind().bind("submit",courseload.forgot.reset)}}).done(function(l){courseload.data.user=l;$("#container").remove();$(document).trigger("userintercept",[courseload.data.user]);return d()})};d=function(){if(Modernizr.history&&history.pushState){return history.pushState(null,null,"/index.html")}};c=function(f){var g,h;h=getUrlParams();if(h.prtoken){g=h.prtoken;return $.when(courseload.api.validateresetpassword(g)).done(function(){return courseload.forgot.showreset()}).fail(function(j,l,k){var i;if(j.status===401){i="That token has expired.  Please request a new password reset token."}else{i="That token is invalid.  Please request a new password reset token."}return courseload.forgot.showinvalidtoken(i)})}else{return $.when(f).done(function(i){courseload.data.user=i;return $(document).trigger("userintercept",[courseload.data.user])}).fail(function(i,k,j){if(i.status===a){return courseload.login.showeula()}else{return courseload.login.showlogin()}})}};e=courseload.api.getuser();$(function(){$("a.login").live("click",function(f){f.preventDefault();return courseload.login.showlogin()});$("a.forgot").live("click",function(f){f.preventDefault();return courseload.forgot.showforgot()});$("a.logout").live("click",courseload.login.logout);$(document).bind("init",function(){return c(e)});$(document).bind("userintercept",function(g,f){return courseload.offline.updateIntercept(f)});return $(document).bind("userloggedin",function(k,h){var l,g,j,f,i;$("#container").remove();l=$("#mainTemplate").tmpl().prependTo("body");courseload.offline.status(function(m){if(m){return _.delay(function(){return courseload.banner.showReleaseNotesBanner(l)},2000)}else{return courseload.banner.showOfflineBanner(l)}});g=l.children("div.menu");$("#skipNavigation_CourseView").tmpl().prependTo(l);i="a.skipToCourses, a.skipToStacks, a.skipToStack, a.skipToSection, a.skipToMainContent";f="div#skipPrimary-Course, div#skipPrimary-Stacks, div#skipPrimary-Stack,                            div#skipPrimary-Section, div#skipTertiary-PageNav, div#skipSecondary-Book,                            div#skipPrimary-Book, div#skipSecondary-BookPage";$(document).on("click",i,function(m){m.preventDefault();return $('[role="main"]').focus()});$(document).on("click","a.skipToSection",function(m){m.preventDefault();return $("h3#courseNavigationAuralHeader").focus()});$(document).on("click","a.skipToMainContent",function(m){m.preventDefault();return $("div#skipSecondary-BookPage a.skipToBookNav").focus()});$(document).on("click","a.skipToBookNav",function(m){m.preventDefault();return $("div#skipSecondary-Book a.skipToMainContent").focus()});$(document).on("click","a.skipToPageNav",function(m){m.preventDefault();return $("div#skipTertiary-PageNav a.skipToBookNav").focus()});$(document).on("focusin",f,function(){return $(this).addClass("show")});$(document).on("focusout",f,function(){return $(this).removeClass("show")});if(courseload.data.customer.logo_url){$("#customerLogotemplate").tmpl(courseload.data.customer).appendTo(g)}j=$("#topNavContainerTemplate").tmpl().appendTo(g);return courseload.offline.status(function(m){j.append($("#helloTemplate").tmpl({user:h,online:m}));return courseload.feedback.init()})})})}).call(this);(function(){var a,b;namespace("courseload.notification.qanda");a=function(c,d){return courseload.api.getnewquestions(d.classmaterial).done(function(e){var f;e=e[d.membership.section.uri][d.classmaterial.slug];if(c.length){f=e.length;if(f>0){return $("#navQuestionNotificationTemplate").tmpl({number_of_notifications:f}).appendTo(c.empty())}else{return c.empty()}}})};b=function(c,d){return courseload.api.getnewresponses(d.classmaterial).done(function(e){var f;e=e[d.membership.section.uri][d.classmaterial.slug];if(c.length){f=e.length;if(f>0){return $("#navResponseNotificationTemplate").tmpl({number_of_notifications:f}).appendTo(c.empty())}else{return c.empty()}}})};courseload.notification.qanda.refresh=function(){var c,d;if(!courseload.data.section){return}c=$("#main > .nav").find(".new-question-notifications");if(c.length===0){return}d=c.closest(".nav").data();return $(document).one("allNotesCountLoaded",function(){if(d.membership.role==="instructor"){return a(c,d)}else{return b(c,d)}})}}).call(this);(function(){var b,a;namespace("courseload.init");namespace("courseload.data");a=courseload.api.getcustomer();b=courseload.api.getcsrftoken();$(function(){return $.when(a,b).done(function(d,c){courseload.data.customer=d[0];courseload.data.csrftoken=c[0].csrfmiddlewaretoken;return $(document).trigger("init")})})}).call(this);(function(){var d,b,e,a,c;namespace("courseload.tag");$("body").live("click",function(h){var g,f;f=$(h.target);g=$("input.manage-tags");if(g.length&&!f.hasClass("manage-tags")){return a(g)}});$("a.addtag").live("click",function(f){f.preventDefault();$("#newTagTemplate").tmpl().appendTo("ul.comments.overview");return setTimeout(d,0)});d=function(){var f;f=$("ul.comments.overview .nav-section:last a.coursename.taglink:last");return courseload.tag.addInPlace(f)};a=function(g){var f;f=g.data("affectedElement");if(!f.attr("href")){g.closest(".nav-section").remove()}g.remove();return f.show()};e=function(){var f,g,h;f=$("#main > .nav");h=f.data().term;g=f.data().membership;return courseload.nav.ui.courseTags(h,g)};$("a.label-search").live("click",function(f){f.preventDefault();return e()});$("input.label-search").live("keyup",function(f){return c()});c=_.debounce(c,200);c=function(){var f,j,i,g,k,l,h;k=$.trim($("input.label-search").val());h=[];if(k!==""){f=$("#main > .nav");g=f.data("membership");j=courseload.data.classmaterials.classmaterials[g.section.uri];l=new RegExp(k,"gi");h=(function(){var o,n,m;m=[];for(o=0,n=j.length;o<n;o++){i=j[o];if((i.title+" "+i.author_byline).match(l)){m.push(i)}}return m})();return courseload.nav.ui.renderTagSearchResults(g,h)}else{e();return $("input.label-search").focus()}};courseload.tag._addInPlace=function(k,j){var f,h,g,n,m,o,i,l;f=$(k);o=$.trim(f.val());if(o!==""){m=j.section;n=o.toLowerCase();g=m.tags.slice(0);g.push("All Resources");for(i=0,l=g.length;i<l;i++){h=g[i];if(!(n===h.toLowerCase())){continue}alert("The stack '"+o+"' already exists.");f.addClass("error-required").focus().select();return}courseload.api.addTag(m,o);m.tags.push(o);return f.remove()}};courseload.tag.addInPlace=function(g){var f,h;h=$('<input class="add-in-place manage-tags new-folder-name" type="text" maxlength="50">');g.hide();h.data("affectedElement",g).css("width","160px").css("font-weight",g.css("font-weight")).css("font-size",g.css("font-size")).val("").insertBefore(g).focus().select().keydown(function(l){var i,j,k;switch(l.which){case hotkeys.Escape:return a($(this));case hotkeys.Enter:i=$("#main > .nav");k=i.data("term");j=i.data("membership");courseload.tag._addInPlace(this,j);courseload.nav.ui.courseTags(k,j);return courseload.nav.resize()}});courseload.nav.resize();f=h.parents("div.scroll");return f.tinyscrollbar_update("bottom")};courseload.tag.editInPlace=function(f){var g;g=$('<input class="edit-in-place manage-tags new-folder-name" type="text" maxlength="50">');f.hide();return g.data("affectedElement",f).css("width","160px").css("font-weight",f.css("font-weight")).css("font-size",f.css("font-size")).val(f.data().tag).insertBefore(f).focus().select().keydown(function(n){var p,h,k,i,m,s,o,r,t,j,l,q;switch(n.which){case hotkeys.Escape:return a($(this));case hotkeys.Enter:p=$("#main > .nav");j=p.data("term");m=p.data("membership");h=$(this);s=$.trim(h.val());if(s!==""){t=s.toLowerCase();o=h.data().affectedElement.data().tag;if(t===o.toLowerCase()){a(h);return}r=m.section;i=r.tags.slice(0);i.push("All Resources");for(l=0,q=i.length;l<q;l++){k=i[l];if(!(t===k.toLowerCase())){continue}alert("The stack '"+s+"' already exists.");h.addClass("error-required").focus().select();return}$.when(courseload.api.renameTag(r,o,s)).done(function(){return b(j,m)});h.remove();return courseload.nav.ui.courseTags(j,m)}}})};courseload.tag["delete"]=function(g){var f,h,j,i;f=$("#main > .nav");i=f.data("term");h=f.data("membership");j=h.section;j.tags=courseload.tag._deleteTag(j,g);$.when(courseload.api.removeTag(j,g)).done(function(){return b(i,h)});return courseload.nav.ui.courseTags(i,h)};courseload.tag._deleteTag=function(g,f){return _.reject(g.tags,function(h){return h===f})};b=function(g,f){return $.when((courseload.api.getclassmaterials(courseload.data.user)).done(function(h){courseload.data.classmaterials=h;return courseload.nav.ui.courseTags(g,f)}))}}).call(this);(function(){namespace("courseload.accessible");courseload.accessible.describeCourseDetail=function(){return $("#courseNavigationAuralHeader").focus()};courseload.accessible.describeResource=function(){return $(".auralResourceHeader").focus()};courseload.accessible.pageRendered=function(){if(self.auralControls){}}}).call(this);Array.prototype.naturalSort=function(d){for(var f=0,k;k=this[f];f++){this[f]=[];var h=0,g=-1,a=0,e,c;while(e=(c=k.charAt(h++)).charCodeAt(0)){var b=(e==46||(e>=48&&e<=57));if(b!==a){this[f][++g]="";a=b}this[f][g]+=c}}this.sort(function(l,j){for(var i=0,m,o;(m=l[i])&&(o=j[i]);i++){if(d){m=m.toLowerCase();o=o.toLowerCase()}if(m!==o){var p=Number(m),n=Number(o);if(p==m&&n==o){return p-n}else{return(m>o)?1:-1}}}return l.length-j.length});for(var f=0;f<this.length;f++){this[f]=this[f].join("")}};function getUrlParams(){var c={},h,b=/\+/g,f=/([^&=]+)=?([^&]*)/g,i=function(a){return decodeURIComponent(a.replace(b," "))},g=window.location.search.substring(1);while(h=f.exec(g)){c[i(h[1])]=i(h[2])}return c};